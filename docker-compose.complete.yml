name: homeiq-complete

services:
  influxdb:
    image: influxdb:2.7
    restart: unless-stopped
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=admin123
      - DOCKER_INFLUXDB_INIT_ORG=homeiq
      - DOCKER_INFLUXDB_INIT_BUCKET=home_assistant_events
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=homeiq-token
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  data-api:
    build:
      context: ./services/data-api
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8006:8006"
    environment:
      - DATA_API_HOST=0.0.0.0
      - DATA_API_PORT=8006
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=homeiq-token
      - INFLUXDB_ORG=homeiq
      - INFLUXDB_BUCKET=home_assistant_events
      - DATABASE_URL=sqlite+aiosqlite:///./data/metadata.db
      - ENABLE_AUTH=false
      - LOG_LEVEL=INFO
    volumes:
      - sqlite_data:/app/data
    depends_on:
      influxdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8006/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  websocket-ingestion:
    build:
      context: ./services/websocket-ingestion
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=homeiq-token
      - INFLUXDB_ORG=homeiq
      - INFLUXDB_BUCKET=home_assistant_events
      - DATA_API_URL=http://data-api:8006
      - WEBSOCKET_INGESTION_PORT=8001
      - ENABLE_HOME_ASSISTANT=false
      - LOG_LEVEL=INFO
    depends_on:
      influxdb:
        condition: service_healthy
      data-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  admin-api:
    build:
      context: ./services/admin-api
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8003:8004"
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=homeiq-token
      - INFLUXDB_ORG=homeiq
      - INFLUXDB_BUCKET=home_assistant_events
      - DATA_API_URL=http://data-api:8006
      - WEBSOCKET_INGESTION_URL=http://websocket-ingestion:8001
      - LOG_LEVEL=INFO
      - API_HOST=0.0.0.0
      - API_PORT=8004
      - ENABLE_AUTH=false
    depends_on:
      influxdb:
        condition: service_healthy
      data-api:
        condition: service_healthy
      websocket-ingestion:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  health-dashboard:
    build:
      context: ./services/health-dashboard
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "3000:80"
    environment:
      - VITE_API_BASE_URL=http://localhost:8003/api/v1
      - VITE_DATA_API_URL=http://localhost:8006
      - VITE_WS_URL=ws://localhost:8001/ws
      - VITE_ENVIRONMENT=production
    depends_on:
      admin-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  weather-api:
    build:
      context: ./services/weather-api
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8009:8009"
    environment:
      - WEATHER_API_KEY=${WEATHER_API_KEY:-}
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=homeiq-token
      - INFLUXDB_ORG=homeiq
      - INFLUXDB_BUCKET=weather_data
      - LOG_LEVEL=INFO
    depends_on:
      influxdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8009/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  carbon-intensity:
    build:
      context: ./services/carbon-intensity-service
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8010:8010"
    environment:
      - WATTTIME_USERNAME=${WATTTIME_USERNAME:-}
      - WATTTIME_PASSWORD=${WATTTIME_PASSWORD:-}
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=homeiq-token
      - INFLUXDB_ORG=homeiq
      - INFLUXDB_BUCKET=home_assistant_events
      - LOG_LEVEL=INFO
    depends_on:
      influxdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  electricity-pricing:
    build:
      context: ./services/electricity-pricing-service
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8011:8011"
    environment:
      - PRICING_PROVIDER=${PRICING_PROVIDER:-awattar}
      - PRICING_API_KEY=${PRICING_API_KEY:-}
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=homeiq-token
      - INFLUXDB_ORG=homeiq
      - INFLUXDB_BUCKET=home_assistant_events
      - LOG_LEVEL=INFO
    depends_on:
      influxdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8011/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  air-quality:
    build:
      context: ./services/air-quality-service
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8012:8012"
    environment:
      - WEATHER_API_KEY=${WEATHER_API_KEY:-}
      - HOME_ASSISTANT_URL=${HOME_ASSISTANT_URL:-}
      - HOME_ASSISTANT_TOKEN=${HOME_ASSISTANT_TOKEN:-}
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=homeiq-token
      - INFLUXDB_ORG=homeiq
      - INFLUXDB_BUCKET=home_assistant_events
      - LOG_LEVEL=INFO
    depends_on:
      influxdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8012/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  smart-meter:
    build:
      context: ./services/smart-meter-service
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8014:8014"
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=homeiq-token
      - INFLUXDB_ORG=homeiq
      - INFLUXDB_BUCKET=home_assistant_events
      - LOG_LEVEL=INFO
    depends_on:
      influxdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8014/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  energy-correlator:
    build:
      context: ./services/energy-correlator
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8017:8017"
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=homeiq-token
      - INFLUXDB_ORG=homeiq
      - INFLUXDB_BUCKET=home_assistant_events
      - LOG_LEVEL=INFO
    depends_on:
      influxdb:
        condition: service_healthy
      smart-meter:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8017/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  ha-setup-service:
    build:
      context: ./services/ha-setup-service
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8027:8020"
    environment:
      - DATA_API_URL=http://data-api:8006
      - ADMIN_API_URL=http://admin-api:8004
      - SERVICE_PORT=8020
      - LOG_LEVEL=INFO
    depends_on:
      data-api:
        condition: service_healthy
      admin-api:
        condition: service_healthy
    volumes:
      - ha_setup_data:/app/data
      - homeiq_logs:/var/log/homeiq
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8020/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  log-aggregator:
    build:
      context: ./services/log-aggregator
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8015:8015"
    environment:
      - LOG_LEVEL=INFO
      - PORT=8015
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - homeiq_logs:/app/logs
    depends_on:
      websocket-ingestion:
        condition: service_started
      admin-api:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8015/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  data-retention:
    build:
      context: ./services/data-retention
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=homeiq-token
      - INFLUXDB_ORG=homeiq
      - INFLUXDB_BUCKET=home_assistant_events
      - LOG_LEVEL=INFO
      - CLEANUP_INTERVAL_HOURS=24
      - MONITORING_INTERVAL_MINUTES=5
      - COMPRESSION_INTERVAL_HOURS=24
      - BACKUP_INTERVAL_HOURS=24
      - BACKUP_DIR=/backups
    depends_on:
      influxdb:
        condition: service_healthy
    volumes:
      - data_retention_backups:/backups
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Optional free-tier AI automation stack (disabled by default)
  # ai-automation-service:
  #   build:
  #     context: ./services/ai-automation-service
  #     dockerfile: Dockerfile
  #   environment:
  #     - DATA_API_URL=http://data-api:8006
  #     - ENABLE_CLOUD_CONNECTORS=false
  #   depends_on:
  #     data-api:
  #       condition: service_healthy

volumes:
  influxdb_data:
  influxdb_config:
  sqlite_data:
  data_retention_backups:
  homeiq_logs:
  ha_setup_data:
