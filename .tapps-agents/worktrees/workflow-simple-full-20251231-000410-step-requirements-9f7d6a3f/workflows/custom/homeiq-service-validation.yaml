# HomeIQ Service Validation Workflow
# Best for: Comprehensive validation of all HomeIQ services against technical and business experts
#
# This workflow validates all services through three parallel validation tracks:
# - Architecture Validation (Architect Agent + Software Architecture, API Design, Cloud Infrastructure, Database experts)
# - Code Quality & Security Validation (Reviewer Agent + Security, Code Quality, Performance experts)
# - Business Pattern Validation (Analyst Agent + HomeIQ domain experts)
#
# Validates against:
# - Technical Experts: Software Architecture, Security, Performance, API Design, Cloud Infrastructure, Database, Code Quality
# - Business Experts: HomeIQ domain patterns, Epic 31 architecture compliance, service communication patterns

workflow:
  id: homeiq-service-validation
  name: "HomeIQ Service Validation"
  description: "Comprehensive service validation against technical and business experts with Epic 31 compliance"
  version: "1.0.0"
  
  type: brownfield
  auto_detect: true
  
  settings:
    quality_gates: false  # Audit mode - don't block on failures, collect all findings
    code_scoring: true
    context_tier_default: 2
  
  steps:
    # Step 1: Service Discovery
    - id: discover_services
      agent: analyst
      action: gather_requirements
      context_tier: 1
      notes: |
        Discover all active services in the services/ directory:
        - Scan services/ directory structure
        - Identify all microservices (exclude archive/, tests/, .pytest_cache/)
        - Extract service metadata:
          * Service name (directory name)
          * Service path (relative path)
          * Service type (inference from structure: external-api, query-api, ingestion, ai-service, device-service, etc.)
          * Port number (if specified in docker-compose.yml or service config)
        - Categorize services:
          * Critical services: websocket-ingestion, data-api, ai-automation-service-new
          * External API services: weather-api, sports-api, carbon-intensity-service, air-quality-service, calendar-service
          * AI services: ai-core-service, ai-query-service, ai-pattern-service, ai-training-service, ai-code-executor
          * Device services: device-health-monitor, device-recommender, device-context-classifier, etc.
          * Supporting services: log-aggregator, data-retention, admin-api, etc.
        - Create structured JSON output with service inventory
      requires: []
      creates:
        - services-inventory.json
    
    # Step 2-4: Parallel Validation Tracks for Critical Services
    # Architecture Validation for Critical Services
    - id: validate_critical_services_arch
      agent: architect
      action: design_system
      context_tier: 2
      notes: |
        Validate architecture for critical services (websocket-ingestion, data-api, ai-automation-service-new):
        - Consult Software Architecture expert for microservices patterns
        - Consult API Design expert for REST/gRPC patterns
        - Consult Cloud Infrastructure expert for deployment patterns
        - Consult Database expert for data storage patterns
        - HomeIQ-Specific Architecture Checks:
          * Epic 31 compliance: Verify direct InfluxDB writes (NO enrichment-pipeline references)
          * Service pattern compliance:
            - websocket-ingestion: Event Ingestion pattern (HA WebSocket → inline normalization → direct InfluxDB)
            - data-api: Query API pattern (central query endpoint, InfluxDB for events, SQLite for metadata)
            - ai-automation-service-new: AI service pattern (standalone, writes to InfluxDB, queries via data-api)
          * Database architecture (Epic 22): Hybrid pattern validation
            - InfluxDB for time-series data (events, metrics, sports scores)
            - SQLite for relational metadata (devices, entities, webhooks)
          * No service-to-service HTTP dependencies (standalone services)
        - For each service, generate architecture validation report with:
          * Expert feedback from all consulted experts
          * Compliance status (Epic 31, Epic 22, service patterns)
          * Architecture recommendations prioritized by expert confidence
          * Specific issues found (if any)
      requires:
        - services-inventory.json
      creates:
        - validation-results/websocket-ingestion/architecture-validation.json
        - validation-results/data-api/architecture-validation.json
        - validation-results/ai-automation-service-new/architecture-validation.json
      next: aggregate_critical_validation
    
    # Code Quality & Security Validation for Critical Services
    - id: validate_critical_services_quality
      agent: reviewer
      action: review_code
      context_tier: 2
      notes: |
        Validate code quality and security for critical services (websocket-ingestion, data-api, ai-automation-service-new):
        - Consult Security expert for vulnerabilities and best practices
        - Consult Code Quality expert for maintainability and complexity analysis
        - Consult Performance expert for efficiency and scalability assessment
        - HomeIQ-Specific Quality Checks:
          * Quality thresholds: Overall score 70+ required (80+ for critical services)
          * Security score: 7.0+/10 required
          * Maintainability score: 7.0+/10 required
          * Test coverage: 80% target (document current coverage, identify gaps)
          * Performance: Check for bottlenecks, efficient algorithms
        - For each service, generate quality validation report with:
          * Quality scores (overall, security, maintainability, test coverage, performance)
          * Expert feedback from all consulted experts
          * Security vulnerabilities identified (if any)
          * Maintainability issues (complexity, code smells)
          * Performance concerns (if any)
          * Test coverage analysis and recommendations
          * Recommendations prioritized by expert confidence and impact
      requires:
        - services-inventory.json
      creates:
        - validation-results/websocket-ingestion/quality-validation.json
        - validation-results/data-api/quality-validation.json
        - validation-results/ai-automation-service-new/quality-validation.json
      next: aggregate_critical_validation
    
    # Business Pattern Validation for Critical Services
    - id: validate_critical_services_business
      agent: analyst
      action: analyze
      context_tier: 2
      notes: |
        Validate business patterns for critical services (websocket-ingestion, data-api, ai-automation-service-new):
        - Consult HomeIQ domain experts (IoT, home automation patterns)
        - Validate service communication patterns
        - Assess business requirements alignment
        - HomeIQ-Specific Business Checks:
          * Service role and purpose clarity: Does the service have a clear, well-defined purpose?
          * Integration compliance: Does the service integrate correctly with other services per Epic 31 patterns?
          * Business value alignment: Does the service provide clear business value and meet user needs?
          * Service pattern adherence:
            - websocket-ingestion: Event ingestion from Home Assistant, direct InfluxDB writes
            - data-api: Central query endpoint for all data (InfluxDB + SQLite)
            - ai-automation-service-new: AI automation logic, writes to InfluxDB
        - For each service, generate business validation report with:
          * Service purpose and role assessment
          * Integration pattern compliance
          * Business value alignment
          * HomeIQ domain pattern compliance
          * Recommendations for business logic improvements (if any)
      requires:
        - services-inventory.json
      creates:
        - validation-results/websocket-ingestion/business-validation.json
        - validation-results/data-api/business-validation.json
        - validation-results/ai-automation-service-new/business-validation.json
      next: aggregate_critical_validation
    
    # Step 5: Aggregate Critical Services Validation Results
    - id: aggregate_critical_validation
      agent: orchestrator
      action: finalize
      context_tier: 1
      notes: |
        Aggregate validation results for critical services (all three validation tracks must complete):
        - Combine architecture, quality, and business validation results for each critical service
        - Cross-reference findings across validation tracks
        - Calculate composite validation scores
        - Identify services needing immediate attention (FAIL status)
        - Prioritize recommendations by expert confidence and impact
        - Generate aggregated validation JSON for each critical service
      requires:
        - validation-results/websocket-ingestion/architecture-validation.json
        - validation-results/websocket-ingestion/quality-validation.json
        - validation-results/websocket-ingestion/business-validation.json
        - validation-results/data-api/architecture-validation.json
        - validation-results/data-api/quality-validation.json
        - validation-results/data-api/business-validation.json
        - validation-results/ai-automation-service-new/architecture-validation.json
        - validation-results/ai-automation-service-new/quality-validation.json
        - validation-results/ai-automation-service-new/business-validation.json
      creates:
        - validation-results/websocket-ingestion/aggregated-validation.json
        - validation-results/data-api/aggregated-validation.json
        - validation-results/ai-automation-service-new/aggregated-validation.json
    
    # Step 6-8: Parallel Validation Tracks for External API Services
    # Architecture Validation for External API Services
    - id: validate_external_services_arch
      agent: architect
      action: design_system
      context_tier: 2
      notes: |
        Validate architecture for external API services (weather-api, sports-api, carbon-intensity-service, air-quality-service, calendar-service):
        - Consult Software Architecture expert for microservices patterns
        - Consult API Design expert for REST/gRPC patterns
        - Consult Cloud Infrastructure expert for deployment patterns
        - Consult Database expert for data storage patterns
        - HomeIQ-Specific Architecture Checks:
          * Epic 31 compliance: Verify direct InfluxDB writes (NO service-to-service HTTP calls)
          * External API pattern compliance:
            - Fetch data from external API (ESPN, OpenWeatherMap, etc.)
            - Write directly to InfluxDB (standalone, no dependencies)
            - Dashboard queries via data-api (not direct InfluxDB queries)
          * No enrichment-pipeline references (deprecated in Epic 31)
          * Standalone service pattern (no HTTP dependencies on other services)
        - For each service, generate architecture validation report
      requires:
        - services-inventory.json
        - validation-results/websocket-ingestion/aggregated-validation.json
      creates:
        - validation-results/weather-api/architecture-validation.json
        - validation-results/sports-api/architecture-validation.json
        - validation-results/carbon-intensity-service/architecture-validation.json
        - validation-results/air-quality-service/architecture-validation.json
        - validation-results/calendar-service/architecture-validation.json
      next: aggregate_external_validation
    
    # Code Quality & Security Validation for External API Services
    - id: validate_external_services_quality
      agent: reviewer
      action: review_code
      context_tier: 2
      notes: |
        Validate code quality and security for external API services (weather-api, sports-api, carbon-intensity-service, air-quality-service, calendar-service):
        - Consult Security expert, Code Quality expert, Performance expert
        - HomeIQ Quality Checks: Overall 70+, Security 7.0+, Maintainability 7.0+, Test coverage 80% target
        - For each service, generate quality validation report with scores and expert recommendations
      requires:
        - services-inventory.json
        - validation-results/websocket-ingestion/aggregated-validation.json
      creates:
        - validation-results/weather-api/quality-validation.json
        - validation-results/sports-api/quality-validation.json
        - validation-results/carbon-intensity-service/quality-validation.json
        - validation-results/air-quality-service/quality-validation.json
        - validation-results/calendar-service/quality-validation.json
      next: aggregate_external_validation
    
    # Business Pattern Validation for External API Services
    - id: validate_external_services_business
      agent: analyst
      action: analyze
      context_tier: 2
      notes: |
        Validate business patterns for external API services (weather-api, sports-api, carbon-intensity-service, air-quality-service, calendar-service):
        - Consult HomeIQ domain experts
        - Validate external API integration patterns
        - Assess business value and user needs alignment
        - For each service, generate business validation report
      requires:
        - services-inventory.json
        - validation-results/websocket-ingestion/aggregated-validation.json
      creates:
        - validation-results/weather-api/business-validation.json
        - validation-results/sports-api/business-validation.json
        - validation-results/carbon-intensity-service/business-validation.json
        - validation-results/air-quality-service/business-validation.json
        - validation-results/calendar-service/business-validation.json
      next: aggregate_external_validation
    
    # Step 9: Aggregate External Services Validation Results
    - id: aggregate_external_validation
      agent: orchestrator
      action: finalize
      context_tier: 1
      notes: |
        Aggregate validation results for external API services (all three validation tracks must complete):
        - Combine architecture, quality, and business validation results for each external API service
        - Cross-reference findings across validation tracks
        - Calculate composite validation scores
        - Generate aggregated validation JSON for each external API service
      requires:
        - validation-results/weather-api/architecture-validation.json
        - validation-results/weather-api/quality-validation.json
        - validation-results/weather-api/business-validation.json
        - validation-results/sports-api/architecture-validation.json
        - validation-results/sports-api/quality-validation.json
        - validation-results/sports-api/business-validation.json
        - validation-results/carbon-intensity-service/architecture-validation.json
        - validation-results/carbon-intensity-service/quality-validation.json
        - validation-results/carbon-intensity-service/business-validation.json
        - validation-results/air-quality-service/architecture-validation.json
        - validation-results/air-quality-service/quality-validation.json
        - validation-results/air-quality-service/business-validation.json
        - validation-results/calendar-service/architecture-validation.json
        - validation-results/calendar-service/quality-validation.json
        - validation-results/calendar-service/business-validation.json
      creates:
        - validation-results/weather-api/aggregated-validation.json
        - validation-results/sports-api/aggregated-validation.json
        - validation-results/carbon-intensity-service/aggregated-validation.json
        - validation-results/air-quality-service/aggregated-validation.json
        - validation-results/calendar-service/aggregated-validation.json
      next: validate_remaining_services
    
    
    # Step 10: Validate Remaining Services (Batch Processing)
    - id: validate_remaining_services
      agent: reviewer
      action: review_code
      context_tier: 2
      notes: |
        Validate remaining services (AI services, device services, supporting services):
        - Process services in batches based on services-inventory.json
        - For each service, perform all three validation tracks (architecture, quality, business)
        - Apply same validation criteria as critical and external services
        - Generate validation results for each service
        - Focus on identifying services that need immediate attention
      requires:
        - services-inventory.json
        - validation-results/websocket-ingestion/aggregated-validation.json
      creates:
        - validation-results/remaining-services-validation.json
      next: generate_service_reports
    
    # Step 11: Generate Individual Service Validation Reports
    - id: generate_service_reports
      agent: documenter
      action: generate_docs
      context_tier: 1
      notes: |
        Generate comprehensive validation report for each validated service:
        - For critical services: Use aggregated validation JSON
        - For external API services: Combine architecture, quality, business validation JSON
        - For remaining services: Use batch validation results
        - Report format per service:
          * Executive Summary: Status (PASS/WARNING/FAIL), Overall Score, Critical Issues Count, Recommendations Count
          * Technical Validation:
            - Architecture Validation: Expert feedback, Epic 31/Epic 22 compliance, recommendations
            - Code Quality & Security: Scores (overall, security, maintainability, test coverage, performance), expert feedback, recommendations
          * Business Validation: Pattern compliance, business alignment, recommendations
          * Action Items: Prioritized list (High/Medium/Low) with expert attribution, confidence scores, and impact descriptions
        - Generate markdown report for each service: validation-reports/{service-name}-validation-report.md
      requires:
        - validation-results/websocket-ingestion/aggregated-validation.json
        - validation-results/data-api/aggregated-validation.json
        - validation-results/ai-automation-service-new/aggregated-validation.json
        - validation-results/weather-api/aggregated-validation.json
        - validation-results/sports-api/aggregated-validation.json
        - validation-results/carbon-intensity-service/aggregated-validation.json
        - validation-results/air-quality-service/aggregated-validation.json
        - validation-results/calendar-service/aggregated-validation.json
        - validation-results/remaining-services-validation.json
      creates:
        - validation-reports/websocket-ingestion-validation-report.md
        - validation-reports/data-api-validation-report.md
        - validation-reports/ai-automation-service-new-validation-report.md
        - validation-reports/weather-api-validation-report.md
        - validation-reports/sports-api-validation-report.md
        - validation-reports/carbon-intensity-service-validation-report.md
        - validation-reports/air-quality-service-validation-report.md
        - validation-reports/calendar-service-validation-report.md
        - validation-reports/remaining-services-validation-report.md
      next: generate_master_summary
    
    # Step 12: Generate Master Validation Summary
    - id: generate_master_summary
      agent: documenter
      action: generate_docs
      context_tier: 1
      notes: |
        Generate master validation summary across all services:
        - Aggregate all service validation reports
        - Create services summary table with:
          * Service name
          * Status (PASS/WARNING/FAIL)
          * Overall Score
          * Architecture Compliance (Epic 31, Epic 22)
          * Quality Scores (Security, Maintainability, Test Coverage)
          * Critical Issues Count
          * Key Issues Summary
        - Create priority matrix:
          * High Priority: Services with FAIL status or critical architecture violations
          * Medium Priority: Services with WARNING status or quality gaps
          * Low Priority: Services with PASS status but improvement opportunities
        - Identify common issues across services:
          * Architecture pattern violations
          * Common quality issues
          * Shared security concerns
          * Test coverage gaps
        - Overall architecture compliance status:
          * Epic 31 compliance summary (direct InfluxDB writes, no enrichment-pipeline)
          * Epic 22 compliance summary (hybrid database architecture)
          * Service pattern adherence
        - Next steps and recommendations:
          * Prioritized action items across all services
          * Common improvement patterns
          * Architecture modernization opportunities
          * Quality improvement initiatives
        - Generate master summary: validation-reports/MASTER-VALIDATION-SUMMARY.md
      requires:
        - validation-reports/websocket-ingestion-validation-report.md
        - validation-reports/data-api-validation-report.md
        - validation-reports/ai-automation-service-new-validation-report.md
        - validation-reports/weather-api-validation-report.md
        - validation-reports/sports-api-validation-report.md
        - validation-reports/carbon-intensity-service-validation-report.md
        - validation-reports/air-quality-service-validation-report.md
        - validation-reports/calendar-service-validation-report.md
        - validation-reports/remaining-services-validation-report.md
      creates:
        - validation-reports/MASTER-VALIDATION-SUMMARY.md
      next: complete
    
    # Step 13: Complete
    - id: complete
      agent: orchestrator
      action: finalize
      context_tier: 1
      notes: |
        Finalize service validation:
        - Verify all validation tracks completed
        - Confirm all service reports generated
        - Verify master summary generated
        - Generate final summary of validation execution
        - Include recommendations for next steps:
          * Review master validation summary
          * Prioritize services needing immediate attention
          * Create improvement plans per service using TappsCodingAgents workflows
          * Track validation status over time (run periodically)
          * Use validation reports for architecture decision documentation
      requires:
        - validation-reports/MASTER-VALIDATION-SUMMARY.md
