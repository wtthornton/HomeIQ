# Story 38.1: Calendar Integration Foundation

**Epic:** 38 - Correlation Analysis Advanced Features  
**Story Points:** 4  
**Priority:** P0  
**Status:** Done  
**Effort:** 2-3 days

---

## Story

**As a** home automation system,  
**I want** to integrate calendar data with correlation analysis,  
**so that** I can detect presence-aware correlations and enable context-aware automations based on user schedules.

---

## Acceptance Criteria

1. ✅ `CalendarCorrelationIntegration` class created in `services/ai-automation-service/src/correlation/calendar_integration.py`
2. ✅ Integration with existing calendar service (Epic 34) via HTTP client
3. ✅ Presence pattern detection implemented (home/away patterns from calendar events)
4. ✅ Calendar event parsing and normalization (location extraction, time windows)
5. ✅ Presence state tracking (current presence, predicted presence)
6. ✅ Integration with correlation service for presence-aware correlation queries
7. ✅ Unit tests for calendar integration (>80% coverage)
8. ✅ Error handling for calendar service unavailability (graceful fallback)
9. ✅ Memory optimization for NUC deployment (<10MB memory footprint)
10. ✅ Performance targets met (<10ms per query with caching)

---

## Tasks / Subtasks

- [ ] Create `calendar_integration.py` file in correlation module (AC: 1)
  - [ ] Define `CalendarCorrelationIntegration` class
  - [ ] Add type hints and docstrings
  - [ ] Follow 2025 patterns (Pydantic Settings, async/await)
- [ ] Implement calendar service HTTP client integration (AC: 2)
  - [ ] Create async HTTP client for calendar service (port 8013)
  - [ ] Implement calendar event fetching
  - [ ] Add connection error handling
- [ ] Implement presence pattern detection (AC: 3)
  - [ ] Parse calendar events for location information
  - [ ] Detect home/away patterns from event locations
  - [ ] Track presence state over time windows
- [ ] Implement calendar event parsing (AC: 4)
  - [ ] Extract location from event descriptions/locations
  - [ ] Normalize time windows (start/end times)
  - [ ] Handle all-day events and recurring events
- [ ] Implement presence state tracking (AC: 5)
  - [ ] Current presence detection (is user home now?)
  - [ ] Predicted presence (will user be home in next N hours?)
  - [ ] Presence history tracking
- [ ] Integrate with correlation service (AC: 6)
  - [ ] Add presence features to correlation queries
  - [ ] Enhance correlation service with presence context
  - [ ] Update correlation service API
- [ ] Write unit tests (AC: 7)
  - [ ] Test calendar event parsing
  - [ ] Test presence pattern detection
  - [ ] Test integration with correlation service
  - [ ] Test error handling
- [ ] Implement error handling (AC: 8)
  - [ ] Graceful fallback when calendar service unavailable
  - [ ] Log errors without breaking correlation analysis
- [ ] Optimize for NUC deployment (AC: 9)
  - [ ] Memory profiling (<10MB target)
  - [ ] Caching for calendar queries
- [ ] Performance testing (AC: 10)
  - [ ] Benchmark query performance (<10ms target)
  - [ ] Validate caching effectiveness

---

## Dev Notes

### Architecture Context

**Service Location:**
- Correlation module: `services/ai-automation-service/src/correlation/`
- Calendar service: `services/calendar-service/` (port 8013)
- Integration file: `services/ai-automation-service/src/correlation/calendar_integration.py`

**Existing Components:**
- `CorrelationService` class in `correlation_service.py` - unified correlation analysis
- Calendar service HTTP API at `http://calendar-service:8013` (Docker internal network)
- Calendar service provides occupancy predictions and calendar events

**Technology Stack:**
- Python 3.11, FastAPI patterns
- aiohttp for async HTTP client
- Pydantic Settings for configuration
- Type hints throughout (Python 3.11+)
- Structured logging with shared logging config

### Calendar Service Integration

**Calendar Service API:**
- Health check: `GET /health`
- Calendar events: Calendar service stores predictions in InfluxDB
- Home Assistant integration: Calendar service connects to HA calendar entities

**Integration Pattern:**
- HTTP client to calendar service (port 8013)
- Fetch calendar events and presence predictions
- Parse events for location information
- Extract presence patterns (home/away)

**Presence Detection:**
- Parse event locations for "HOME", "WFH", "AWAY" keywords
- Track presence state over time windows
- Predict future presence based on calendar events

### Correlation Service Integration

**Integration Points:**
- Add presence features to `CorrelationFeatureExtractor`
- Enhance correlation queries with presence context
- Update correlation service to use presence patterns

**Presence Features:**
- Current presence state (home/away)
- Predicted presence (next N hours)
- Presence history (patterns over time)

### Single-Home NUC Optimization

**Memory Constraints:**
- Target: <10MB memory footprint
- Cache calendar queries (1 hour TTL)
- In-memory presence state tracking (lightweight)

**Performance Targets:**
- Calendar query: <10ms per query (with caching)
- Presence detection: <5ms per event
- Integration overhead: <1ms per correlation query

### Testing Standards

**Test File Location:**
- `services/ai-automation-service/tests/correlation/test_calendar_integration.py`

**Testing Framework:**
- pytest with pytest-asyncio for async tests
- Mock calendar service HTTP responses
- Test error handling and graceful fallback

**Coverage Requirements:**
- >80% code coverage
- Test all public methods
- Test error handling paths

### Coding Standards

**Type Hints:**
- All functions must have type hints for parameters and return types
- Use `typing` module for complex types (Optional, List, Dict, etc.)

**Async/Await:**
- Always use async/await for I/O operations
- Use `aiohttp` for HTTP client
- Never use blocking operations in async functions

**Error Handling:**
- Always preserve exception chains when re-raising
- Use specific exception types, avoid bare `except:`
- Graceful fallback when calendar service unavailable

**Logging:**
- Use structured logging with shared logging config
- Log errors with context
- Use appropriate log levels (DEBUG, INFO, WARNING, ERROR)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-25 | 1.0 | Story created | BMad Master |

---

## Dev Agent Record

### Agent Model Used
TBD

### Debug Log References
TBD

### Completion Notes List
TBD

### File List
TBD

---

## QA Results
TBD

