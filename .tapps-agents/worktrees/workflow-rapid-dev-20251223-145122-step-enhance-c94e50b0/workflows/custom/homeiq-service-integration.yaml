# HomeIQ Service Integration Workflow
# Best for: Integrating new services with existing HomeIQ infrastructure
#
# This workflow integrates a service with HomeIQ following Epic 31 patterns:
# - InfluxDB direct writes (no enrichment-pipeline)
# - data-api query patterns for reads
# - Standalone service pattern (no service-to-service HTTP dependencies)
# - Quality gates and testing

workflow:
  id: homeiq-service-integration
  name: "HomeIQ Service Integration"
  description: "Integrate service with existing HomeIQ infrastructure (Epic 31 patterns)"
  version: "1.0.0"
  
  type: brownfield
  auto_detect: true
  
  settings:
    quality_gates: true
    code_scoring: true
    context_tier_default: 2
  
  steps:
    # Step 1: Analyze Existing Services
    - id: analysis
      agent: analyst
      action: gather_requirements
      context_tier: 2
      instructions: |
        Analyze existing HomeIQ services and infrastructure:
        - Review existing service patterns (services/ directory)
        - Identify integration points (InfluxDB, data-api)
        - Understand Epic 31 architecture (direct InfluxDB writes)
        - Review docker-compose.yml for service patterns
        - Identify data flow patterns (write to InfluxDB, query via data-api)
      requires: []
      creates:
        - integration-analysis.md
      next: integration_design
      
    # Step 2: Integration Design
    - id: integration_design
      agent: architect
      action: design_system
      context_tier: 2
      instructions: |
        Design service integration following Epic 31 patterns:
        - Direct InfluxDB writes (NO enrichment-pipeline, NO HTTP POST to websocket-ingestion)
        - Query data via data-api endpoints
        - Standalone service pattern (no service-to-service HTTP dependencies)
        - Follow existing external service patterns (weather-api, sports-data, carbon-intensity)
        - Document bucket names, measurement names, and query patterns
      requires:
        - integration-analysis.md
      creates:
        - integration-design.md
      next: influxdb_writes
      
    # Step 3: InfluxDB Write Implementation
    - id: influxdb_writes
      agent: implementer
      action: write_code
      context_tier: 2
      instructions: |
        Implement InfluxDB direct writes following Epic 31 architecture:
        - Use InfluxDB Python client library
        - Write directly to InfluxDB (no intermediate services)
        - Follow existing patterns (see services/weather-api, services/sports-data)
        - Include proper error handling, retry logic, and batch writes
        - Document bucket and measurement names
        - Include connection management and health checks
      requires:
        - integration-design.md
      creates:
        - influxdb-integration.py
      next: data_api_queries
      
    # Step 4: data-api Query Implementation
    - id: data_api_queries
      agent: implementer
      action: write_code
      context_tier: 2
      instructions: |
        Implement data-api query patterns for reading data:
        - Use data-api REST endpoints for queries (NO direct InfluxDB reads)
        - Follow existing query patterns (see services/health-dashboard, services/ai-automation-service)
        - Include proper error handling and caching
        - Document query endpoints used
      requires:
        - integration-design.md
      creates:
        - data-api-queries.py
      next: implementation
      
    # Step 5: Integration Implementation
    - id: implementation
      agent: implementer
      action: write_code
      context_tier: 3
      instructions: |
        Implement the service integration:
        - Integrate InfluxDB writes and data-api queries
        - Follow Epic 31 architecture (direct writes, query via data-api)
        - Include proper error handling, logging, and monitoring
        - Follow existing code patterns from services/ directory
        - Ensure standalone service pattern (no service-to-service HTTP dependencies)
      requires:
        - influxdb-integration.py
        - data-api-queries.py
        - integration-design.md
      creates:
        - src/
      next: review
      
    # Step 6: Quality Review
    - id: review
      agent: reviewer
      action: review_code
      context_tier: 2
      instructions: |
        Review integration code quality following HomeIQ standards:
        - Overall score: 70+ required
        - Security: 7.0+ required
        - Maintainability: 7.0+ required
        - Verify Epic 31 compliance (direct InfluxDB writes, query via data-api, no service dependencies)
        - Check integration patterns match HomeIQ standards
      requires:
        - src/
      scoring:
        enabled: true
        thresholds:
          overall_min: 70
          security_min: 7.0
          maintainability_min: 7.0
      gate:
        condition: "scoring.passed == true"
        on_pass: testing
        on_fail: implementation
      next: testing
      
    # Step 7: Integration Testing
    - id: testing
      agent: tester
      action: write_tests
      context_tier: 2
      instructions: |
        Generate integration tests:
        - Unit tests for InfluxDB write operations
        - Unit tests for data-api query operations
        - Integration tests for end-to-end data flow
        - Mock InfluxDB and data-api for isolated testing
        - Target: 80% test coverage
      requires:
        - src/
      creates:
        - tests/
      next: documentation
      
    # Step 8: Documentation
    - id: documentation
      agent: documenter
      action: generate_docs
      context_tier: 1
      instructions: |
        Generate integration documentation:
        - Integration architecture (Epic 31 patterns)
        - InfluxDB write patterns (bucket, measurements, schema)
        - data-api query patterns (endpoints, parameters)
        - Service dependencies (NONE - standalone pattern)
        - Configuration and deployment guide
      requires:
        - src/
        - integration-design.md
      creates:
        - docs/
      next: complete
      
    # Step 9: Finalize
    - id: complete
      agent: orchestrator
      action: finalize
      context_tier: 1
      instructions: |
        Finalize the service integration:
        - Verify integration code and tests
        - Confirm quality gates passed
        - Generate summary report
        - Include next steps (testing, deployment, monitoring)
      requires:
        - src/
        - tests/
        - docs/

