# HomeIQ Microservice Creation Workflow
# Best for: Creating new microservices in HomeIQ with Epic 31 architecture patterns
#
# This workflow creates a new microservice following HomeIQ standards:
# - Docker setup (Dockerfile, docker-compose.yml)
# - Epic 31 architecture (direct InfluxDB writes, no enrichment-pipeline)
# - Quality gates (70+ overall, 7.0+ security/maintainability)
# - Test generation (80% target coverage)
# - HomeIQ-specific patterns (Python 3.12, health checks, port mapping)

workflow:
  id: homeiq-microservice-creation
  name: "HomeIQ Microservice Creation"
  description: "Create new microservice with HomeIQ patterns (Docker, InfluxDB, Epic 31 architecture)"
  version: "1.0.0"
  
  type: greenfield
  auto_detect: true
  
  settings:
    quality_gates: true
    code_scoring: true
    context_tier_default: 2
  
  steps:
    # Step 1: Architecture Design
    - id: architecture
      agent: architect
      action: design_system
      context_tier: 2
      instructions: |
        Design the microservice architecture following HomeIQ patterns:
        - Epic 31 architecture: Direct InfluxDB writes (no enrichment-pipeline)
        - Standalone service pattern (no service-to-service HTTP dependencies)
        - Follow existing HomeIQ service patterns (see services/ directory)
        - Consider hybrid database architecture (InfluxDB for time-series, SQLite for metadata)
      requires: []
      creates:
        - architecture.md
      next: api_design
      
    # Step 2: API Design
    - id: api_design
      agent: designer
      action: api_design
      context_tier: 2
      instructions: |
        Design the API following HomeIQ API standards:
        - RESTful endpoints
        - Standard response formats
        - Health check endpoint required (/health)
        - Consider data-api query patterns for InfluxDB reads
      requires:
        - architecture.md
      creates:
        - api-specs/
      next: docker_setup
      
    # Step 3: Docker Setup
    - id: docker_setup
      agent: implementer
      action: write_code
      context_tier: 2
      instructions: |
        Create Dockerfile and update docker-compose.yml following HomeIQ patterns:
        - Use Python 3.12 base image (python:3.12-slim)
        - Include health check endpoint (/health)
        - Add to docker-compose.yml with appropriate port mapping
        - Follow existing service patterns (see services/*/Dockerfile examples)
        - Include environment variable management
        - Add service to docker-compose.yml services section
      requires:
        - architecture.md
        - api-specs/
      creates:
        - Dockerfile
        - docker-compose.yml
      next: influxdb_integration
      
    # Step 4: InfluxDB Integration (Epic 31 Pattern)
    - id: influxdb_integration
      agent: implementer
      action: write_code
      context_tier: 2
      instructions: |
        Implement InfluxDB integration following Epic 31 architecture:
        - Direct InfluxDB writes (NO enrichment-pipeline)
        - Use InfluxDB Python client library
        - Write directly to InfluxDB (no HTTP POST to other services)
        - Follow existing patterns (see services/weather-api, services/sports-data)
        - Include proper error handling and retry logic
        - Document bucket and measurement names
      requires:
        - architecture.md
        - api-specs/
      creates:
        - influxdb-client.py
        - influxdb-config.yaml
      next: implementation
      
    # Step 5: Service Implementation
    - id: implementation
      agent: implementer
      action: write_code
      context_tier: 3
      instructions: |
        Implement the microservice following HomeIQ patterns:
        - Use FastAPI or similar framework (match existing services)
        - Implement health check endpoint (/health)
        - Follow Epic 31 architecture (direct InfluxDB writes)
        - Include proper error handling, logging, and monitoring
        - Follow existing code patterns from services/ directory
        - Include proper type hints and documentation
      requires:
        - architecture.md
        - api-specs/
        - Dockerfile
        - docker-compose.yml
        - influxdb-client.py
      creates:
        - src/
      next: review
      
    # Step 6: Quality Review
    - id: review
      agent: reviewer
      action: review_code
      context_tier: 2
      instructions: |
        Review code quality following HomeIQ standards:
        - Overall score: 70+ required (80+ for critical services)
        - Security: 7.0+ required
        - Maintainability: 7.0+ required
        - Check for Epic 31 compliance (direct InfluxDB writes, no enrichment-pipeline)
        - Verify Docker setup and health checks
      requires:
        - src/
        - Dockerfile
      scoring:
        enabled: true
        thresholds:
          overall_min: 70
          security_min: 7.0
          maintainability_min: 7.0
      gate:
        condition: "scoring.passed == true"
        on_pass: testing
        on_fail: implementation
      next: testing
      
    # Step 7: Test Generation
    - id: testing
      agent: tester
      action: write_tests
      context_tier: 2
      instructions: |
        Generate comprehensive tests following HomeIQ patterns:
        - Unit tests for all service functions
        - Integration tests for InfluxDB operations
        - Health check endpoint tests
        - Target: 80% test coverage
        - Follow existing test patterns (see services/data-api/tests/)
      requires:
        - src/
      creates:
        - tests/
      next: documentation
      
    # Step 8: Documentation
    - id: documentation
      agent: documenter
      action: generate_docs
      context_tier: 1
      instructions: |
        Generate documentation for the microservice:
        - API documentation
        - Architecture documentation
        - InfluxDB integration details (Epic 31 patterns)
        - Docker setup instructions
        - Service configuration guide
      requires:
        - src/
        - architecture.md
        - api-specs/
      creates:
        - docs/
      next: complete
      
    # Step 9: Finalize
    - id: complete
      agent: orchestrator
      action: finalize
      context_tier: 1
      instructions: |
        Finalize the microservice creation:
        - Verify all files created
        - Confirm quality gates passed
        - Generate summary report
        - Include next steps (docker-compose up, testing, etc.)
      requires:
        - src/
        - tests/
        - docs/
        - Dockerfile
        - docker-compose.yml

