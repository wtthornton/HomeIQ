# Story 38.2: Presence-Aware Correlations

**Epic:** 38 - Correlation Analysis Advanced Features  
**Story Points:** 4  
**Priority:** P0  
**Status:** Done  
**Effort:** 3-5 days

---

## Story

**As a** home automation system,  
**I want** to correlate calendar events with device usage patterns,  
**so that** I can generate presence-aware automation suggestions that adapt to user schedules.

---

## Acceptance Criteria

1. ✅ Presence-aware correlation analysis implemented
2. ✅ Calendar events correlated with device usage patterns
3. ✅ Presence-driven automation suggestions generated
4. ✅ Integration with correlation service for enhanced features
5. ✅ Home/away usage frequency analysis
6. ✅ WFH day usage pattern detection
7. ✅ Arrival preparation suggestions
8. ✅ Departure optimization suggestions
9. ✅ Unit tests for presence-aware correlations (>80% coverage)
10. ✅ Performance targets met (<100ms per analysis)

---

## Tasks / Subtasks

- [ ] Create `presence_aware_correlations.py` file (AC: 1)
  - [ ] Define `PresenceAwareCorrelationAnalyzer` class
  - [ ] Add type hints and docstrings
  - [ ] Follow 2025 patterns (async/await, type hints)
- [ ] Implement presence-aware correlation analysis (AC: 1, 2)
  - [ ] Analyze correlations between presence and device usage
  - [ ] Calculate home/away usage frequencies
  - [ ] Detect WFH day patterns
- [ ] Integrate with correlation service (AC: 4)
  - [ ] Use correlation service for enhanced features
  - [ ] Add presence features to correlation queries
- [ ] Implement presence-driven automation suggestions (AC: 3, 7, 8)
  - [ ] Arrival preparation suggestions
  - [ ] Departure optimization suggestions
  - [ ] WFH day optimization suggestions
- [ ] Write unit tests (AC: 9)
  - [ ] Test presence correlation analysis
  - [ ] Test automation suggestion generation
  - [ ] Test integration with correlation service
- [ ] Performance testing (AC: 10)
  - [ ] Benchmark analysis performance (<100ms target)
  - [ ] Validate memory usage (<20MB target)

---

## Dev Notes

### Architecture Context

**Service Location:**
- Correlation module: `services/ai-automation-service/src/correlation/`
- New file: `services/ai-automation-service/src/correlation/presence_aware_correlations.py`
- Integration: Uses `CalendarCorrelationIntegration` from Story 38.1

**Existing Components:**
- `CalendarCorrelationIntegration` - Calendar integration (Story 38.1)
- `CorrelationService` - Unified correlation service
- `CorrelationFeatureExtractor` - Feature extraction (updated with presence features)

**Technology Stack:**
- Python 3.11, FastAPI patterns
- Async/await for I/O operations
- Type hints throughout (Python 3.11+)
- Structured logging with shared logging config

### Integration Points

**Calendar Integration:**
- Uses `CalendarCorrelationIntegration` from Story 38.1
- Queries presence state from InfluxDB (occupancy predictions)
- Caches presence queries for performance

**Correlation Service:**
- Integrates with `CorrelationService` for enhanced correlation analysis
- Uses presence features in correlation queries
- Enhances correlation scores with presence context

**Data API Client:**
- Optional data API client for device usage queries
- Queries InfluxDB for device usage history
- Correlates usage with presence patterns

### Presence-Aware Analysis

**Analysis Types:**
1. **Presence Correlation** - Correlates device usage with home/away states
2. **WFH Pattern Detection** - Detects work-from-home day patterns
3. **Arrival Preparation** - Suggests enabling devices before arrival
4. **Departure Optimization** - Suggests disabling devices when leaving

**Metrics:**
- Home usage frequency (usage when home)
- Away usage frequency (usage when away)
- WFH usage frequency (usage on WFH days)
- Presence correlation score (0.0-1.0)

### Automation Suggestions

**Suggestion Types:**
- **arrival_preparation** - Enable device before arrival
- **departure_optimization** - Disable device when leaving
- **wfh_optimization** - Optimize for WFH days

**Confidence Scoring:**
- Based on correlation strength
- Based on data points available
- Based on usage frequency differences

### Single-Home NUC Optimization

**Memory Constraints:**
- Target: <20MB memory footprint
- Cache presence queries (1 hour TTL)
- Efficient usage history queries

**Performance Targets:**
- Analysis: <100ms per entity
- Presence queries: <10ms (cached)
- Usage queries: <50ms (InfluxDB)

### Testing Standards

**Test File Location:**
- `services/ai-automation-service/tests/correlation/test_presence_aware_correlations.py`

**Testing Framework:**
- pytest with pytest-asyncio for async tests
- Mock calendar integration
- Mock data API client
- Test correlation analysis logic

**Coverage Requirements:**
- >80% code coverage
- Test all public methods
- Test error handling paths

### Coding Standards

**Type Hints:**
- All functions must have type hints for parameters and return types
- Use `typing` module for complex types (Optional, List, Dict, etc.)

**Async/Await:**
- Always use async/await for I/O operations
- Use `aiohttp` for HTTP client
- Never use blocking operations in async functions

**Error Handling:**
- Always preserve exception chains when re-raising
- Use specific exception types, avoid bare `except:`
- Graceful fallback when calendar service unavailable

**Logging:**
- Use structured logging with shared logging config
- Log errors with context
- Use appropriate log levels (DEBUG, INFO, WARNING, ERROR)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-25 | 1.0 | Story created | BMad Master |

---

## Dev Agent Record

### Agent Model Used
TBD

### Debug Log References
TBD

### Completion Notes List
TBD

### File List
TBD

---

## QA Results
TBD

