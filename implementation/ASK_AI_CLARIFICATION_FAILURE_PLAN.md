# ASK AI Clarification Failure - Analysis and Fix Plan

**Created:** November 20, 2025  
**Status:** ‚úÖ **COMPLETED**  
**Issue:** ASK AI fails after user answers clarifying question  
**Severity:** HIGH - Blocks core functionality

---

## üîç Root Cause Analysis

### Primary Issue: `NameError: name 'enriched_query' is not defined`

**Location:** `services/ai-automation-service/src/api/ask_ai_router.py:3893`

**Problem:**
- In `generate_suggestions_from_query()`, the code calls `_score_entities_by_relevance()` with `query=enriched_query`
- However, `enriched_query` is not defined in this function's scope
- The function parameter is named `query`, not `enriched_query`
- When called from `provide_clarification()`, it receives an `enriched_query` variable, but inside `generate_suggestions_from_query()`, that parameter is named `query`

**Error Trace:**
```
File "/app/src/api/ask_ai_router.py", line 3893, in generate_suggestions_from_query
    query=enriched_query,
          ^^^^^^^^^^^^^^
NameError: name 'enriched_query' is not defined
```

### Secondary Issue: Empty `validated_entities` Causes Suggestions to Be Skipped

**Location:** `services/ai-automation-service/src/api/ask_ai_router.py:4532-4535`

**Problem:**
- After suggestions are generated by OpenAI, the code attempts to map `devices_involved` to `validated_entities`
- `devices_involved` contains location names like `['office']` instead of entity IDs
- The mapping function `map_devices_to_entities()` fails to resolve "office" because it's a location, not a device/entity name
- Since `validated_entities` is empty, all suggestions are skipped with error: `"CRITICAL: validated_entities is empty for suggestion N - cannot save suggestion without entity mapping"`

**Error Trace:**
```
ERROR:ai-automation-service:‚ùå CRITICAL: validated_entities is empty for suggestion 1 - cannot save suggestion without entity mapping
ERROR:ai-automation-service:‚ùå devices_involved: ['office']
ERROR:ai-automation-service:‚ùå Skipping suggestion 1 - no validated entities
```

**Impact:**
- No suggestions are saved to the database
- Endpoint returns 500 error: `"No suggestions generated after ambiguity resolution - suggestions array is empty"`
- User sees generic error message in UI

### Flow Breakdown

1. User answers clarifying question ‚Üí `POST /api/v1/ask-ai/clarify`
2. `provide_clarification()` rebuilds enriched query from Q&A
3. `provide_clarification()` re-extracts entities from enriched query
4. `provide_clarification()` calls `generate_suggestions_from_query(enriched_query, ...)`
5. `generate_suggestions_from_query()` processes query (parameter name is `query`, not `enriched_query`)
6. **ERROR** at line 3893: tries to use `enriched_query` which doesn't exist
7. If error is caught/fixed, OpenAI generates suggestions with `devices_involved: ['office']`
8. Code tries to map `devices_involved` to entities but fails because "office" is a location
9. `validated_entities` remains empty
10. All suggestions are skipped
11. Endpoint returns 500 error

---

## üéØ Fix Plan

### Phase 1: Fix NameError (Critical - Blocks All Requests)

**Priority:** CRITICAL  
**Effort:** 5 minutes  
**Risk:** LOW

**Change Required:**
- **File:** `services/ai-automation-service/src/api/ask_ai_router.py`
- **Line:** 3893
- **Action:** Change `query=enriched_query` to `query=query`

**Code Change:**
```python
# BEFORE (line 3893):
relevance_scores = await _score_entities_by_relevance(
    enriched_entities=[{'entity_id': eid} for eid in resolved_entity_ids],
    enriched_data=enriched_data,
    query=enriched_query,  # ‚ùå ERROR: enriched_query doesn't exist
    clarification_context=clarification_context,
    mentioned_locations=mentioned_locations,
    mentioned_domains=mentioned_domains
)

# AFTER:
relevance_scores = await _score_entities_by_relevance(
    enriched_entities=[{'entity_id': eid} for eid in resolved_entity_ids],
    enriched_data=enriched_data,
    query=query,  # ‚úÖ FIX: Use the function parameter
    clarification_context=clarification_context,
    mentioned_locations=mentioned_locations,
    mentioned_domains=mentioned_domains
)
```

### Phase 2: Fix Entity Mapping for Location-Based `devices_involved` (Critical)

**Priority:** CRITICAL  
**Effort:** 1-2 hours  
**Risk:** LOW (follows existing patterns)

**Problem:**
When OpenAI returns suggestions with `devices_involved: ['office']` (a location name), the entity mapping fails because:
1. `map_devices_to_entities()` expects device/entity names, not locations
2. Location names need to be expanded to all entities in that location
3. The mapping should use the `query_location` that was already extracted earlier

**Solution (Following 2025 Existing Patterns):**
- **Pre-process `devices_involved` to expand location names BEFORE mapping** (matches existing pattern at lines 4473-4522)
- Use `query_location` already extracted at line 3513
- Use `resolved_entity_ids` already fetched at lines 3601-3611
- Use `enriched_data` already populated with entity friendly names
- This follows the same pattern used for handling entity IDs (lines 4473-4522)

**Code Location:**
- `services/ai-automation-service/src/api/ask_ai_router.py:4323-4352` - where `map_devices_to_entities()` is called
- Add location expansion logic BEFORE line 4345, similar to entity ID handling at lines 4473-4522

**Implementation Steps (Following Existing Code Pattern):**

1. **Pre-process `devices_involved` to expand location names** (matches lines 4473-4522 pattern):
   ```python
   # BEFORE calling map_devices_to_entities() (around line 4323)
   # Expand location names to entity friendly names using existing data
   expanded_devices_involved = []
   location_names_expanded = []
   
   for device_name in devices_involved:
       # Normalize location name for comparison (handle spaces, underscores)
       device_name_normalized = device_name.lower().strip().replace(' ', '_')
       query_location_normalized = query_location.lower().strip().replace(' ', '_') if query_location else None
       
       # Check if device_name is a location name that matches query_location
       # This follows the same pattern as entity ID detection (line 4475)
       is_location_name = (
           query_location_normalized and
           (device_name_normalized == query_location_normalized or
            device_name_normalized in query_location_normalized or
            query_location_normalized in device_name_normalized)
       )
       
       if is_location_name and resolved_entity_ids and enriched_data:
           # Expand location to entities (similar to entity ID expansion at lines 4490-4522)
           logger.info(f"üìç Expanding location '{device_name}' to {len(resolved_entity_ids)} entities from resolved_entity_ids")
           location_entities_added = 0
           
           # Map entity IDs to friendly names from enriched_data (existing pattern)
           for entity_id in resolved_entity_ids:
               enriched = enriched_data.get(entity_id, {})
               if enriched:
                   # Use same priority order as lines 4377-4383
                   friendly_name = (
                       enriched.get('device_name') or
                       enriched.get('friendly_name') or
                       enriched.get('name_by_user') or
                       enriched.get('name') or
                       enriched.get('original_name') or
                       entity_id.split('.')[-1].replace('_', ' ').title()  # Fallback
                   )
                   if friendly_name and friendly_name not in expanded_devices_involved:
                       expanded_devices_involved.append(friendly_name)
                       location_entities_added += 1
           
           if location_entities_added > 0:
               location_names_expanded.append(device_name)
               logger.info(f"‚úÖ Expanded location '{device_name}' to {location_entities_added} entity friendly names")
           else:
               # Fallback: keep original if expansion failed
               logger.warning(f"‚ö†Ô∏è Failed to expand location '{device_name}', keeping original")
               expanded_devices_involved.append(device_name)
       else:
           # Not a location name, use as-is (existing behavior)
           expanded_devices_involved.append(device_name)
   
   # Use expanded list for mapping (replace devices_involved with expanded_devices_involved)
   if location_names_expanded:
       logger.info(f"üìç Location expansion: {len(location_names_expanded)} locations expanded, {len(devices_involved)} ‚Üí {len(expanded_devices_involved)} devices")
       devices_involved = expanded_devices_involved
   
   # Then call map_devices_to_entities() with expanded list (line 4345)
   validated_entities = await map_devices_to_entities(
       devices_involved,  # Now contains friendly names instead of location names
       enriched_data,
       ha_client=ha_client_for_mapping,
       fuzzy_match=True,
       clarification_context=clarification_context,
       query_location=query_location
   )
   ```

**Why This Approach:**
- ‚úÖ Follows existing pattern for entity ID handling (lines 4473-4522)
- ‚úÖ Uses existing variables (`query_location`, `resolved_entity_ids`, `enriched_data`) already in scope
- ‚úÖ Minimal code changes (pre-processing before existing mapping call)
- ‚úÖ Leverages existing enriched data (no additional API calls)
- ‚úÖ Consistent with 2025 codebase patterns (location-aware, context-aware)

### Phase 3: Improve Error Handling and User Feedback (Important)

**Priority:** IMPORTANT  
**Effort:** 30 minutes  
**Risk:** LOW

**Changes (Following Existing Error Handling Patterns):**
1. **Enhanced logging when entity mapping fails** (matches existing pattern at lines 4524-4528):
   - When `validated_entities` is empty, log `devices_involved`, `query_location`, `resolved_entity_ids`, and available `enriched_data` keys
   - Already partially implemented, but enhance with more context

2. **User-facing error messages** (aligns with existing error handling at lines 6567-6610):
   - Enhance error message to indicate if location expansion failed
   - Include available entities count for debugging
   - Follow existing error message format from `provide_clarification()` endpoint

3. **Fallback behavior** (matches existing fallback at lines 4473-4522):
   - If location expansion fails but we have `resolved_entity_ids`, use direct entity ID mapping (existing pattern)
   - Create mapping from `resolved_entity_ids` using `enriched_data` friendly names
   - This fallback already exists but should be enhanced for location names

**Code Location:**
- `services/ai-automation-service/src/api/ask_ai_router.py:4524-4535` - validation check (enhance logging)
- `services/ai-automation-service/src/api/ask_ai_router.py:6567-6610` - error response (enhance message)

---

## üìã Implementation Checklist

### Phase 1: Quick Fix (NameError) ‚úÖ COMPLETED
- [x] Change `query=enriched_query` to `query=query` at line 3893
- [x] Verified no linting errors
- [ ] Test that clarification endpoint no longer crashes
- [ ] Verify error is resolved in logs

### Phase 2: Entity Mapping Fix ‚úÖ COMPLETED
- [x] Review existing location expansion pattern (lines 4473-4522)
- [x] Add location name detection before `map_devices_to_entities()` call (lines 4345-4401)
- [x] Expand location names to friendly names using `resolved_entity_ids` and `enriched_data`
- [x] Use same priority order for friendly names as existing code (lines 4375-4381)
- [x] Log location expansion for debugging
- [ ] Test with location-based queries (e.g., "office" LED automation)
- [ ] Verify `validated_entities` is populated correctly after expansion

### Phase 3: Error Handling
- [ ] Add detailed logging when entity mapping fails
- [ ] Improve error messages for user
- [ ] Add fallback to use `resolved_entity_ids` if mapping fails
- [ ] Test error scenarios

### Testing
- [ ] Test full flow: query ‚Üí clarification question ‚Üí answer ‚Üí suggestions generated
- [ ] Test with location-based queries (e.g., "office", "living room")
- [ ] Test with device name-based queries
- [ ] Verify suggestions are saved to database
- [ ] Verify UI displays suggestions correctly

---

## üîß Files to Modify

1. **services/ai-automation-service/src/api/ask_ai_router.py**
   - Line 3893: Fix `enriched_query` ‚Üí `query`
   - Lines 4345-4352: Enhance entity mapping for locations
   - Lines 4530-4535: Improve error handling and logging
   - Lines 6567-6610: Better error messages

---

## üìä Expected Outcomes

### After Phase 1:
- ‚úÖ Clarification endpoint no longer crashes with NameError
- ‚úÖ Request proceeds to suggestion generation

### After Phase 2:
- ‚úÖ `validated_entities` is populated even when `devices_involved` contains locations
- ‚úÖ Suggestions are saved to database
- ‚úÖ User receives suggestions after answering clarifying questions

### After Phase 3:
- ‚úÖ Better debugging information in logs
- ‚úÖ Improved user-facing error messages
- ‚úÖ More resilient error handling

---

## üö® Rollback Plan

If issues arise:
1. **Phase 1 fix** is trivial to rollback (single line change)
2. **Phase 2 fix** can be rolled back by removing location expansion logic
3. **Phase 3** changes are additive and safe to keep

---

## üìù Notes

### Existing Patterns (2025 Codebase)

1. **Location-aware entity resolution:**
   - `query_location` is extracted at line 3513 using `entity_validator._extract_location_from_query()`
   - `resolved_entity_ids` are fetched for that location at lines 3601-3611
   - `enriched_data` contains friendly names for all entities in that location

2. **Entity ID handling pattern (lines 4473-4522):**
   - Code already handles entity IDs in `devices_involved`
   - Expands entity IDs to friendly names using `enriched_data`
   - Uses priority order: `device_name` ‚Üí `friendly_name` ‚Üí `name_by_user` ‚Üí `name` ‚Üí `original_name`

3. **Location expansion should follow same pattern:**
   - Detect location names (like entity ID detection at line 4475)
   - Expand to friendly names using existing `resolved_entity_ids` and `enriched_data`
   - Use same friendly name priority order

4. **Scope note:**
   - The `enriched_query` variable exists in `provide_clarification()` scope (line 5961)
   - But inside `generate_suggestions_from_query()`, the parameter is named `query` (line 3469)
   - This is why line 3893 needs to use `query` instead of `enriched_query`

### Key Variables Available at Entity Mapping Time

- `query_location` (line 3513): Location extracted from query (e.g., "office")
- `resolved_entity_ids` (line 3611): List of entity IDs in that location
- `enriched_data` (line 3727/3743): Dictionary mapping entity_id ‚Üí enriched entity data (includes friendly names)
- `devices_involved` (line 4320): List from OpenAI suggestion (may contain location names like "office")

---

**Status:** Ready for implementation  
**Next Steps:** Start with Phase 1 fix (5 min), then proceed to Phase 2

