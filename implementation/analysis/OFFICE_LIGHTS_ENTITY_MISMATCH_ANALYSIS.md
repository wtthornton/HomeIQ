# Office Lights Entity Mismatch Analysis

**Date:** October 30, 2025  
**Issue:** Suggestion lists 4 devices ("Office light 1-4") but YAML only contains 3 entity IDs

## Problem Summary

**Observed Behavior:**
- **Suggestion devices_involved:** `["Office light 1", "Office light 2", "Office light 3", "Office light 4"]`
- **YAML entity IDs:** `["light.hue_go_1", "light.hue_color_downlight_2_2", "light.hue_color_downlight_1_6"]`
- **Missing:** 4th device was never mapped to an entity ID

## Root Cause Analysis

### 1. Where "Office light 1-4" Comes From

**Location:** `services/ai-automation-service/src/api/ask_ai_router.py:786`

The `devices_involved` list is generated by **OpenAI** when creating the suggestion:

```python
# Line 786 in ask_ai_router.py
'devices_involved': suggestion['devices_involved'],  # From OpenAI response
```

**How Clean AI generates it:**
1. User query: "make a it look like a party in the office by randomly flashing each lights quickly in random colors..."
2. OpenAI infers there are multiple lights (uses plural "lights")
3. OpenAI generates generic numbered names: "Office light 1", "Office light 2", "Office light 3", "Office light 4"
4. This is **inferred/generated** by AI, not based on actual entities

**The Issue:** OpenAI doesn't know how many actual lights exist in the office - it just guesses based on the query mentioning "lights" (plural).

### 2. Entity Resolution Process

**Location:** `services/ai-automation-service/src/api/ask_ai_router.py:1509-1536`

After the suggestion is created, entity resolution happens:

```python
# Line 1509-1522
devices_involved = suggestion.get('devices_involved', [])  # ["Office light 1", "Office light 2", "Office light 3", "Office light 4"]
resolved_entities = await entity_validator.map_query_to_entities(query.original_query, devices_involved)

# Line 1529-1536: Build entity_mapping
entity_mapping = {}
for device_name in devices_involved:
    if device_name in resolved_entities:  # Only maps if resolution succeeded
        entity_id = resolved_entities[device_name]
        entity_mapping[device_name] = entity_id
    else:
        logger.warning(f" Device '{device_name}' not found in resolved_entities")  # "Office light 4" would log here
```

### 3. Why Only 3 Entities Are Resolved

**Location:** `services/ai-automation-service/src/services/entity_validator.py:660-776`

The `_find_best_match()` function tries to match "Office light 1-4" to actual entity IDs:

1. **Extracts numbered pattern:** "Office light 1" → base="office light", number="1"
2. **Searches for matching entities** using patterns like:
   - `office_1`, `office_light_1`, `office_lamp_1`
   - Checks entity IDs and friendly names
   - Filters by domain (light) and location (office area)

3. **Only finds 3 matches:**
   - "Office light 1" → `light.hue_go_1` ✅
   - "Office light 2" → `light.hue_color_downlight_2_2` ✅
   - "Office light 3" → `light.hue_color_downlight_1_6` ✅
   - "Office light 4" → **NO MATCH** ❌ (no 4th office light exists)

### 4. What Actually Happens

**Flow:**
```
1. OpenAI generates suggestion with devices_involved = ["Office light 1", "Office light 2", "Office light 3", "Office light 4"]
   ↓
2. Entity resolution tries to map each device name
   ↓
3. Only 3 matches found → entity_mapping = {
     "Office light 1": "light.hue_go_1",
     "Office light 2": "light.hue_color_downlight_2_2", 
     "Office light 3": "light.hue_color_downlight_1_6"
   }
   ↓
4. "Office light 4" is silently dropped (warning logged but not fatal)
   ↓
5. YAML generated with only 3 entities ✅ (works, but incomplete)
```

## The Real Problem

**Two separate issues:**

### Issue 1: OpenAI Generates Fake Device Names
- OpenAI doesn't have access to actual entity counts
- It infers "4 lights" from the plural "lights" and generates numbered names
- These are **generic names**, not real entity IDs

### Issue 2: Entity Resolution Can't Find All Devices
- Entity resolution correctly finds 3 office lights
- But there is **no 4th light** in Home Assistant
- The system silently drops the unmapped device

## Why This Is Wrong

1. **Misleading User Experience:** Suggestion says "4 devices" but only 3 are controlled
2. **No Validation:** System doesn't verify that all `devices_involved` were successfully mapped
3. **Silent Failure:** Unmapped devices are logged but not reported to user
4. **Incomplete Automation:** Automation only controls 3 lights instead of the intended 4

## Recommended Fixes

### Fix 1: Validate Entity Resolution (Immediate)
**Location:** `services/ai-automation-service/src/api/ask_ai_router.py:1529-1536`

Add validation after entity mapping:

```python
# After building entity_mapping
unmapped_devices = [d for d in devices_involved if d not in entity_mapping]
if unmapped_devices:
    logger.warning(f"⚠️ {len(unmapped_devices)} devices could not be mapped: {unmapped_devices}")
    # Option 1: Update devices_involved to only include mapped devices
    # Option 2: Fail the test with clear error message
    # Option 3: Include in quality_report as a warning
```

### Fix 2: Pass Actual Entity Count to OpenAI (Better)
**Location:** `services/ai-automation-service/src/api/ask_ai_router.py:745-760`

When generating suggestions, pass actual entity count to OpenAI:

```python
# In generate_suggestions_from_query()
office_light_count = len([e for e in entities if 'office' in e.get('area_id', '').lower() and e.get('domain') == 'light'])
context += f"\nAvailable office lights: {office_light_count} lights found in office area."
```

### Fix 3: Post-Process devices_involved After Resolution (Best Practice)
**Location:** `services/ai-automation-service/src/api/ask_ai_router.py:1537`

Update the suggestion's `devices_involved` to only include successfully mapped devices:

```python
# After entity resolution
successfully_mapped_devices = list(entity_mapping.keys())
test_suggestion['devices_involved'] = successfully_mapped_devices  # Update to reflect reality
test_suggestion['devices_resolution_status'] = {
    'original_count': len(devices_involved),
    'mapped_count': len(entity_mapping),
    'unmapped': [d for d in devices_involved if d not in entity_mapping]
}
```

## Evidence from Code

### Entity Resolution Logging
Looking at `entity_validator.py:1534-1535`:
```python
if device_name in resolved_entities:
    entity_id = resolved_entities[device_name]
    entity_mapping[device_name] = entity_id
else:
    logger.warning(f" Device '{device_name}' not found in resolved_entities")
    # ⚠️ This warning is logged but device is silently dropped
```

### Quality Report Already Tracks This
The quality report at line 1117 includes `devices_involved`, but it's the **original** list, not the validated one.

## Conclusion

**What Went Wrong:**
1. OpenAI generated 4 device names without knowing actual entity count
2. Entity resolution found only 3 matching entities
3. The 4th device was silently dropped during mapping
4. YAML was generated with only 3 entities (correctly, but incompletely)

**Why It's Different:**
- `devices_involved` = **AI-generated device names** (can be wrong/inferred)
- YAML entity IDs = **Actual resolved entities** (correct, but incomplete)

**The Fix Needed:**
- Validate entity resolution completeness
- Update `devices_involved` after resolution OR report unmapped devices
- Consider passing actual entity counts to OpenAI during suggestion generation

