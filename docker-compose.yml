name: homeiq

services:
  influxdb:
    image: influxdb:2.7.12
    container_name: homeiq-influxdb
    restart: unless-stopped
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_USERNAME:-admin}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_PASSWORD:-admin123}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_ORG:-homeiq}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_BUCKET:-home_assistant_events}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_TOKEN:-homeiq-token}
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=influxdb,environment=production"

  websocket-ingestion:
    build:
      context: .
      dockerfile: services/websocket-ingestion/Dockerfile
      cache_from:
        - websocket-ingestion:latest
    container_name: homeiq-websocket
    restart: unless-stopped
    ports:
      - "8001:8001"
    env_file:
      - .env
    environment:
      # Docker container detection for SSL context
      - DOCKER_CONTAINER=true
      # Deployment Mode Configuration (Epic 40)
      - DEPLOYMENT_MODE=${DEPLOYMENT_MODE:-production}
      # Home Assistant Configuration (consolidated)
      - HA_HTTP_URL=${HA_HTTP_URL:-}
      - HA_WS_URL=${HA_WS_URL:-}
      - HA_TOKEN=${HA_TOKEN:-}
      # Nabu Casa Fallback Configuration
      - NABU_CASA_URL=${NABU_CASA_URL:-}
      - NABU_CASA_TOKEN=${NABU_CASA_TOKEN:-}
      - DATA_API_URL=http://data-api:8006
      - WEBSOCKET_INGESTION_PORT=8001
      - ENABLE_HOME_ASSISTANT=true
      # InfluxDB Configuration (override .env file)
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_USERNAME=admin
      - INFLUXDB_PASSWORD=admin123
      - INFLUXDB_ORG=${INFLUXDB_ORG:-ha-ingestor}
      - INFLUXDB_BUCKET=home_assistant_events
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN:-ha-ingestor-token}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FILE_PATH=${LOG_FILE_PATH:-/app/logs}
      - LOG_FORMAT=json
      - LOG_OUTPUT=both
      - API_KEY=${API_KEY:-hs_P3rU9kQ2xZp6vL1fYc7bN4sTqD8mA0wR}
      # WebSocket Retry Configuration
      - WEBSOCKET_MAX_RETRIES=${WEBSOCKET_MAX_RETRIES:--1}  # -1 = infinite retry (recommended)
      - WEBSOCKET_MAX_RETRY_DELAY=${WEBSOCKET_MAX_RETRY_DELAY:-300}  # Max 5 minutes between retries
      # Device storage configuration
      - STORE_DEVICE_HISTORY_IN_INFLUXDB=${STORE_DEVICE_HISTORY_IN_INFLUXDB:-false}
      # Weather API Configuration
      - WEATHER_API_KEY=${WEATHER_API_KEY:-}
      - WEATHER_API_URL=${WEATHER_API_URL:-https://api.openweathermap.org/data/2.5}
      - WEATHER_DEFAULT_LOCATION=${WEATHER_DEFAULT_LOCATION:-Las Vegas,NV,US}
      - WEATHER_ENRICHMENT_ENABLED=${WEATHER_ENRICHMENT_ENABLED:-true}
      - WEATHER_CACHE_MINUTES=${WEATHER_CACHE_MINUTES:-15}
      - WEATHER_RATE_LIMIT_PER_MINUTE=${WEATHER_RATE_LIMIT_PER_MINUTE:-50}
      - WEATHER_RATE_LIMIT_PER_DAY=${WEATHER_RATE_LIMIT_PER_DAY:-900}
      - WEATHER_REQUEST_TIMEOUT=${WEATHER_REQUEST_TIMEOUT:-10}
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=websocket-ingestion,environment=production"
    volumes:
      - homeiq_logs:/var/log/homeiq
    depends_on:
      data-api:
        condition: service_healthy
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  admin-api:
    build:
      context: ./services/admin-api
      dockerfile: Dockerfile
      cache_from:
        - admin-api:latest
    container_name: homeiq-admin
    restart: unless-stopped
    ports:
      - "8004:8004"
    env_file:
      - .env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./infrastructure:/app/infrastructure:rw
      - ./docker-compose.yml:/app/docker-compose.yml:ro
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FILE_PATH=${LOG_FILE_PATH:-/app/logs}
      - LOG_FORMAT=json
      - API_HOST=0.0.0.0
      - API_PORT=8004
      - API_KEY=${API_KEY:-hs_P3rU9kQ2xZp6vL1fYc7bN4sTqD8mA0wR}
      - ENABLE_AUTH=false
      - DOCKER_HOST=unix:///var/run/docker.sock
      - WEATHER_API_KEY=${WEATHER_API_KEY:-}
      # Home Assistant Configuration (consolidated)
      - HA_HTTP_URL=${HA_HTTP_URL:-${HOME_ASSISTANT_URL:-}}
      - HA_URL=${HA_HTTP_URL:-${HOME_ASSISTANT_URL:-http://192.168.1.86:8123}}
      - HA_TOKEN=${HOME_ASSISTANT_TOKEN:-}
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN:-homeiq-token}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-homeiq}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-home_assistant_events}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-super-secret-jwt-key}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-adminpass}
      - WEBSOCKET_INGESTION_URL=http://websocket-ingestion:8001
      - AI_AUTOMATION_URL=http://ai-automation-service:8018
    depends_on:
      influxdb:
        condition: service_healthy
      websocket-ingestion:
        condition: service_healthy
      data-api:
        condition: service_healthy
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=admin-api,environment=production"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  data-api:
    build:
      context: .
      dockerfile: services/data-api/Dockerfile
      cache_from:
        - data-api:latest
    container_name: homeiq-data-api
    restart: unless-stopped
    ports:
      - "8006:8006"
    env_file:
      - .env
    environment:
      - DATA_API_HOST=0.0.0.0
      - DATA_API_PORT=8006
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN:-homeiq-token}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-homeiq}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-home_assistant_events}
      - DATABASE_URL=${DATABASE_URL:-sqlite+aiosqlite:///./data/metadata.db}
      - SQLITE_TIMEOUT=30
      - SQLITE_CACHE_SIZE=-64000
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENABLE_AUTH=true
      - API_KEY=${API_KEY:-hs_P3rU9kQ2xZp6vL1fYc7bN4sTqD8mA0wR}
      - CORS_ORIGINS=http://localhost:3000,http://localhost
      # Deployment Mode Configuration (Epic 40)
      - DEPLOYMENT_MODE=${DEPLOYMENT_MODE:-production}
    volumes:
      - sqlite-data:/app/data
    depends_on:
      influxdb:
        condition: service_healthy
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=data-api,environment=production"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8006/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  data-retention:
    build:
      context: ./services/data-retention
      dockerfile: Dockerfile
    container_name: homeiq-data-retention
    restart: unless-stopped
    ports:
      - "8080:8080"
    env_file:
      - .env
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN:-homeiq-token}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-homeiq}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-home_assistant_events}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FILE_PATH=${LOG_FILE_PATH:-/app/logs}
      - LOG_FORMAT=json
      - CLEANUP_INTERVAL_HOURS=${CLEANUP_INTERVAL_HOURS:-24}
      - MONITORING_INTERVAL_MINUTES=${MONITORING_INTERVAL_MINUTES:-5}
      - COMPRESSION_INTERVAL_HOURS=${COMPRESSION_INTERVAL_HOURS:-24}
      - BACKUP_INTERVAL_HOURS=${BACKUP_INTERVAL_HOURS:-24}
      - BACKUP_DIR=${BACKUP_DIR:-/backups}
    depends_on:
      influxdb:
        condition: service_healthy
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=data-retention,environment=production"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      - data_retention_backups:/backups

  carbon-intensity:
    build:
      context: ./services/carbon-intensity-service
      dockerfile: Dockerfile
    container_name: homeiq-carbon-intensity
    restart: unless-stopped
    ports:
      - "8010:8010"
    env_file:
      - .env
    environment:
      # WattTime Authentication (username/password preferred for auto-refresh)
      - WATTTIME_USERNAME=${WATTTIME_USERNAME:-}
      - WATTTIME_PASSWORD=${WATTTIME_PASSWORD:-}
      # Or static token (expires every 30 minutes, not recommended)
      - WATTTIME_API_TOKEN=${WATTTIME_API_TOKEN:-}
      # Grid configuration
      - GRID_REGION=${GRID_REGION:-CAISO_NORTH}
      # InfluxDB configuration
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN:-homeiq-token}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-homeiq}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-home_assistant_events}
      - SERVICE_PORT=8010
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      influxdb:
        condition: service_healthy
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 192M  # Increased from 128M (was at 53% usage)
          cpus: '0.5'
        reservations:
          memory: 96M   # Increased from 64M
          cpus: '0.25'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=carbon-intensity,environment=production"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    profiles:
      - production
      # Excluded from test profile to save resources and prevent API quota usage

  electricity-pricing:
    build:
      context: ./services/electricity-pricing-service
      dockerfile: Dockerfile
    container_name: homeiq-electricity-pricing
    restart: unless-stopped
    ports:
      - "8011:8011"
    env_file:
      - .env
    environment:
      - PRICING_PROVIDER=${PRICING_PROVIDER:-awattar}
      - PRICING_API_KEY=${PRICING_API_KEY:-}
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN:-homeiq-token}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-homeiq}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-home_assistant_events}
      - SERVICE_PORT=8011
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      influxdb:
        condition: service_healthy
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 192M  # Increased from 128M (was at 57% usage)
        reservations:
          memory: 96M   # Increased from 64M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=electricity-pricing,environment=production"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8011/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    profiles:
      - production
      # Excluded from test profile to save resources and prevent API quota usage

  air-quality:
    build:
      context: ./services/air-quality-service
      dockerfile: Dockerfile
    container_name: homeiq-air-quality
    restart: unless-stopped
    ports:
      - "8012:8012"
    env_file:
      - .env
    environment:
      - WEATHER_API_KEY=${WEATHER_API_KEY:-}
      - LATITUDE=${LATITUDE:-36.1699}
      - LONGITUDE=${LONGITUDE:--115.1398}
      - HOME_ASSISTANT_URL=${HA_HTTP_URL:-${HOME_ASSISTANT_URL:-}}
      - HOME_ASSISTANT_TOKEN=${HOME_ASSISTANT_TOKEN:-}
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN:-homeiq-token}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-homeiq}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-home_assistant_events}
      - SERVICE_PORT=8012
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      influxdb:
        condition: service_healthy
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 192M  # Increased from 128M (was at 58% usage)
        reservations:
          memory: 96M   # Increased from 64M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=air-quality,environment=production"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8012/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    profiles:
      - production
      # Excluded from test profile to save resources and prevent API quota usage

  weather-api:
    build:
      context: ./services/weather-api
      dockerfile: Dockerfile
    container_name: homeiq-weather-api
    restart: unless-stopped
    ports:
      - "8009:8009"
    env_file:
      - .env
    environment:
      - SERVICE_PORT=8009
      - WEATHER_API_KEY=${WEATHER_API_KEY:-}
      - WEATHER_LOCATION=${WEATHER_LOCATION:-Las Vegas}
      - CACHE_TTL_SECONDS=900
      - FETCH_INTERVAL_SECONDS=300
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN:-homeiq-token}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-homeiq}
      - INFLUXDB_BUCKET=weather_data
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      influxdb:
        condition: service_healthy
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 192M
          cpus: '0.5'
        reservations:
          memory: 96M
          cpus: '0.25'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=weather-api,environment=production"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8009/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - production
      # Excluded from test profile to save resources and prevent API quota usage

  calendar:
    build:
      context: ./services/calendar-service
      dockerfile: Dockerfile
    container_name: homeiq-calendar
    restart: unless-stopped
    ports:
      - "8013:8013"
    env_file:
      - .env
    environment:
      # Home Assistant Configuration (consolidated)
      - HA_HTTP_URL=${HA_HTTP_URL:-}
      - HA_WS_URL=${HA_WS_URL:-}
      - HA_TOKEN=${HA_TOKEN:-${HOME_ASSISTANT_TOKEN:-}}
      - CALENDAR_ENTITIES=${CALENDAR_ENTITIES:-calendar.primary}
      - CALENDAR_FETCH_INTERVAL=${CALENDAR_FETCH_INTERVAL:-900}
      # InfluxDB Configuration
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN:-homeiq-token}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-homeiq}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-home_assistant_events}
      # Service Configuration
      - SERVICE_PORT=8013
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      influxdb:
        condition: service_healthy
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 192M  # Increased from 128M (was at 54% usage)
        reservations:
          memory: 96M   # Increased from 64M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=calendar,environment=production"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8013/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    profiles:
      - production
      # Excluded from test profile to save resources and prevent API quota usage

  smart-meter:
    build:
      context: ./services/smart-meter-service
      dockerfile: Dockerfile
    container_name: homeiq-smart-meter
    restart: unless-stopped
    ports:
      - "8014:8014"
    env_file:
      - .env
    environment:
      - METER_TYPE=${METER_TYPE:-home_assistant}
      # Home Assistant Configuration (unified)
      - HA_HTTP_URL=${HA_HTTP_URL:-}
      - HA_WS_URL=${HA_WS_URL:-}
      - HA_TOKEN=${HOME_ASSISTANT_TOKEN:-}
      # Nabu Casa Fallback
      - NABU_CASA_URL=${NABU_CASA_URL:-}
      - NABU_CASA_TOKEN=${NABU_CASA_TOKEN:-}
      # Standard HA connection
      - HOME_ASSISTANT_URL=${HOME_ASSISTANT_URL:-}
      - HOME_ASSISTANT_TOKEN=${HOME_ASSISTANT_TOKEN:-}
      - METER_API_TOKEN=${METER_API_TOKEN:-}
      - METER_DEVICE_ID=${METER_DEVICE_ID:-}
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN:-homeiq-token}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-homeiq}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-home_assistant_events}
      - SERVICE_PORT=8014
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      influxdb:
        condition: service_healthy
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 192M  # Increased from 128M (was at 54% usage)
        reservations:
          memory: 96M   # Increased from 64M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=smart-meter,environment=production"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8014/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  energy-correlator:
    build:
      context: ./services/energy-correlator
      dockerfile: Dockerfile
    container_name: homeiq-energy-correlator
    restart: unless-stopped
    ports:
      - "8017:8017"
    env_file:
      - .env
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN:-homeiq-token}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-homeiq}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-home_assistant_events}
      - PROCESSING_INTERVAL=${ENERGY_CORRELATION_INTERVAL:-60}
      - LOOKBACK_MINUTES=${ENERGY_LOOKBACK_MINUTES:-5}
      - SERVICE_PORT=8017
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      influxdb:
        condition: service_healthy
      smart-meter:
        condition: service_started
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=energy-correlator,environment=production"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8017/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  health-dashboard:
    build:
      context: ./services/health-dashboard
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=
        - VITE_API_KEY=${API_KEY:-hs_P3rU9kQ2xZp6vL1fYc7bN4sTqD8mA0wR}
        - VITE_DATA_API_URL=
        - VITE_WS_URL=ws://localhost:8001/ws
        - VITE_ENVIRONMENT=production
    container_name: homeiq-dashboard
    restart: unless-stopped
    ports:
      - "3000:80"
    environment:
      - VITE_API_BASE_URL=
      - VITE_API_KEY=${API_KEY:-hs_P3rU9kQ2xZp6vL1fYc7bN4sTqD8mA0wR}
      - VITE_DATA_API_URL=
      - VITE_WS_URL=ws://localhost:8001/ws
      - VITE_ENVIRONMENT=production
    depends_on:
      admin-api:
        condition: service_healthy
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=health-dashboard,environment=production"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  log-aggregator:
    build:
      context: ./services/log-aggregator
      dockerfile: Dockerfile
    container_name: homeiq-log-aggregator
    restart: unless-stopped
    ports:
      - "8015:8015"
    env_file:
      - .env
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FILE_PATH=${LOG_FILE_PATH:-/app/logs}
      - LOG_FORMAT=json
      - PORT=8015
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./logs:/app/logs
      - homeiq_logs:/var/log/homeiq
    group_add:
      - "0"  # root group for docker socket access
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.5'
        reservations:
          memory: 64M
          cpus: '0.25'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=log-aggregator,environment=production"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8015/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # NER Model Service - Pre-built container with dslim/bert-base-NER
  ner-service:
    build:
      context: ./services/ai-automation-service
      dockerfile: docker/ner-service.Dockerfile
    container_name: homeiq-ner-service
    restart: unless-stopped
    # Internal service - no external port mapping needed
    # Port 8031 is used by proactive-agent-service
    expose:
      - "8031"
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 1G  # NER model + inference
          cpus: '2.0'
        reservations:
          memory: 512M
          cpus: '1.0'
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8031/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # Longer startup for model loading
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=ner-model,environment=production"

  # OpenAI Client Service - Lightweight OpenAI API client
  openai-service:
    build:
      context: ./services/ai-automation-service
      dockerfile: docker/openai-service.Dockerfile
    container_name: homeiq-openai-service
    restart: unless-stopped
    ports:
      - "8020:8020"
    env_file:
      - infrastructure/env.ai-automation
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 256M  # Minimal memory for API client
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8020/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=openai-client,environment=production"

  # OpenVINO Service - Optimized Model Inference (Phase 1)
  openvino-service:
    build:
      context: ./services/openvino-service
      dockerfile: Dockerfile
    container_name: homeiq-openvino-service
    restart: unless-stopped
    ports:
      - "8026:8019"  # Fixed port conflict with ner-service
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 1.5G  # 3 OpenVINO models + runtime
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.5'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8019/health"]
      interval: 30s
      timeout: 10s
      retries: 5  # More retries for model loading
      start_period: 300s  # Extended startup for model loading (5 minutes)
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=openvino-models,environment=production"

  # ML Service - Classical Machine Learning (Phase 1)
  ml-service:
    build:
      context: ./services/ml-service
      dockerfile: Dockerfile
    container_name: homeiq-ml-service
    restart: unless-stopped
    ports:
      - "8025:8020"  # Fixed port conflict with openai-service
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 512M  # scikit-learn + pandas + numpy
          cpus: '2.0'
        reservations:
          memory: 256M
          cpus: '1.0'
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8020/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=ml-algorithms,environment=production"

  # AI Core Service - Orchestrator (Phase 1)
  ai-core-service:
    build:
      context: ./services/ai-core-service
      dockerfile: Dockerfile
    container_name: homeiq-ai-core-service
    restart: unless-stopped
    ports:
      - "8018:8018"
    env_file:
      - infrastructure/env.ai-automation
    environment:
      - OPENVINO_SERVICE_URL=http://openvino-service:8019
      - ML_SERVICE_URL=http://ml-service:8020
      - NER_SERVICE_URL=http://ner-service:8031
      - OPENAI_SERVICE_URL=http://openai-service:8020
    depends_on:
      openvino-service:
        condition: service_healthy
      ml-service:
        condition: service_healthy
      ner-service:
        condition: service_healthy
      openai-service:
        condition: service_healthy
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 512M  # Orchestrator + business logic
          cpus: '2.0'
        reservations:
          memory: 256M
          cpus: '1.0'
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8018/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=ai-orchestrator,environment=production"

  ha-ai-agent-service:
    build:
      context: ./services/ha-ai-agent-service
      dockerfile: Dockerfile
    container_name: homeiq-ha-ai-agent-service
    restart: unless-stopped
    ports:
      - "8030:8030"
    env_file:
      - .env
    environment:
      - HA_URL=${HA_HTTP_URL:-http://homeassistant:8123}
      - HA_TOKEN=${HA_TOKEN:-}
      - DATA_API_URL=http://data-api:8006
      - DEVICE_INTELLIGENCE_URL=http://device-intelligence-service:8019
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - AI_AUTOMATION_API_KEY=${API_KEY:-}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      data-api:
        condition: service_healthy
      device-intelligence-service:
        condition: service_healthy
    networks:
      - homeiq-network
    volumes:
      - ha_ai_agent_data:/app/data
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8030/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=ha-ai-agent,environment=production"

  proactive-agent-service:
    build:
      context: ./services/proactive-agent-service
      dockerfile: Dockerfile
    container_name: homeiq-proactive-agent-service
    restart: unless-stopped
    ports:
      - "8031:8031"
    env_file:
      - .env
    environment:
      - HA_AI_AGENT_URL=http://ha-ai-agent-service:8030
      - WEATHER_API_URL=http://weather-api:8009
      # SPORTS_DATA_URL removed - sports data now accessed via data-api service (port 8006)
      # See: implementation/sports-architecture-simplification-summary.md
      - CARBON_INTENSITY_URL=http://carbon-intensity:8010
      - DATA_API_URL=http://data-api:8006
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - SCHEDULER_ENABLED=${SCHEDULER_ENABLED:-true}
      - SCHEDULER_TIME=${SCHEDULER_TIME:-03:00}
    depends_on:
      ha-ai-agent-service:
        condition: service_healthy
      data-api:
        condition: service_healthy
    networks:
      - homeiq-network
    volumes:
      - proactive_agent_data:/app/data
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8031/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=proactive-agent-service,environment=production"

  ai-automation-service:
    build:
      context: ./services/ai-automation-service
      dockerfile: Dockerfile
    container_name: ai-automation-service
    restart: unless-stopped
    ports:
      - "8024:8018"  # Fixed port conflict with energy-correlator
    env_file:
      - .env
      - infrastructure/env.ai-automation
    environment:
      - DATA_API_URL=http://data-api:8006
      - API_KEY=${API_KEY:-hs_P3rU9kQ2xZp6vL1fYc7bN4sTqD8mA0wR}
      # Map API_KEY from .env to AI_AUTOMATION_API_KEY (backend expects this name)
      - AI_AUTOMATION_API_KEY=${API_KEY:-hs_P3rU9kQ2xZp6vL1fYc7bN4sTqD8mA0wR}
      - AI_AUTOMATION_ADMIN_API_KEY=${API_KEY:-hs_P3rU9kQ2xZp6vL1fYc7bN4sTqD8mA0wR}
      # Map .env variables to service expected names
      - HA_URL=${HOME_ASSISTANT_URL:-http://192.168.1.86:8123}
      - HA_TOKEN=${HOME_ASSISTANT_TOKEN:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - NER_SERVICE_URL=http://ner-service:8031
      - OPENAI_SERVICE_URL=http://openai-service:8020
      - OPENVINO_SERVICE_URL=http://openvino-service:8019
      - ML_SERVICE_URL=http://ml-service:8020
      - AI_CORE_SERVICE_URL=http://ai-core-service:8018
      - DEVICE_INTELLIGENCE_URL=http://device-intelligence-service:8019
      # Dataset testing
      - DATASET_ROOT=/app/datasets/home-assistant-datasets/datasets
    depends_on:
      data-api:
        condition: service_healthy
      ner-service:
        condition: service_healthy
      openai-service:
        condition: service_healthy
      openvino-service:
        condition: service_healthy
      ml-service:
        condition: service_healthy
      ai-core-service:
        condition: service_healthy
    volumes:
      - ai_automation_data:/app/data
      - ai_automation_models:/app/models  # Phase 1: OpenVINO model cache
      - ./services/tests/datasets:/app/datasets:ro  # Dataset testing (separate location)
      - ./services/ai-automation-service/tests:/app/tests:ro  # Test files
      - ./services/tests/datasets:/app/tests/datasets:ro  # Dataset testing
      - ./services/ai-automation-service/src:/app/src:ro  # Source code (mounted for development, no rebuild needed)
      - ./services/ai-automation-service/scripts:/app/scripts:ro  # Scripts (mounted for development, no rebuild needed)
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 2G  # Increased for training runs (model loading + training needs ~1.5GB)
          cpus: '2.0'
        reservations:
          memory: 512M  # Increased base reservation
          cpus: '1.0'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=ai-automation,environment=production"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8018/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  ai-code-executor:
    build:
      context: ./services/ai-code-executor
      dockerfile: Dockerfile
    container_name: ai-code-executor
    restart: unless-stopped
    # Internal service - no external port mapping needed
    # Port 8030 is used by ha-ai-agent-service
    expose:
      - "8030"
    environment:
      - EXECUTION_TIMEOUT=30
      - MAX_MEMORY_MB=128
      - MAX_CPU_PERCENT=50.0
      - MCP_WORKSPACE_DIR=/tmp/mcp_workspace
      - LOG_LEVEL=INFO
    depends_on:
      data-api:
        condition: service_healthy
      ai-automation-service:
        condition: service_healthy
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 192M
          cpus: '0.5'
        reservations:
          memory: 96M
          cpus: '0.25'
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8030/health', timeout=5.0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=ai-code-executor,environment=production"

  # AI Training Service - Epic 39, Story 39.1: Training Service Foundation
  ai-training-service:
    build:
      context: ./services/ai-training-service
      dockerfile: Dockerfile
    container_name: ai-training-service
    restart: unless-stopped
    ports:
      - "8033:8022"
    env_file:
      - .env
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./data/ai_automation.db
      - DATABASE_PATH=/app/data/ai_automation.db
      - TRAINING_SCRIPT_PATH=/app/scripts/train_soft_prompt.py
      - SOFT_PROMPT_MODEL_DIR=/app/models/soft_prompts
      - MODEL_STORAGE_DIR=/app/models
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    volumes:
      - ai_automation_data:/app/data  # Shared database
      - ai_automation_models:/app/models  # Shared model storage
      - ./services/ai-automation-service/scripts:/app/scripts:ro  # Training scripts
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '2.0'
        reservations:
          memory: 256M
          cpus: '1.0'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8022/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=ai-training,environment=production"

  ai-pattern-service:
    build:
      context: ./services/ai-pattern-service
      dockerfile: Dockerfile
    container_name: ai-pattern-service
    restart: unless-stopped
    ports:
      - "8034:8020"
    env_file:
      - .env
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./data/ai_automation.db
      - DATABASE_PATH=/app/data/ai_automation.db
      - DATA_API_URL=http://data-api:8006
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - MQTT_BROKER=${MQTT_BROKER:-}
      - MQTT_PORT=${MQTT_PORT:-1883}
    volumes:
      - ai_automation_data:/app/data  # Shared database
    networks:
      - homeiq-network
    depends_on:
      data-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8020/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=ai-pattern-service,environment=production"

  ai-query-service:
    build:
      context: ./services/ai-query-service
      dockerfile: Dockerfile
    container_name: ai-query-service
    restart: unless-stopped
    ports:
      - "8035:8018"  # Changed external port to avoid conflict with ai-core-service
    env_file:
      - .env
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./data/ai_automation.db
      - DATABASE_PATH=/app/data/ai_automation.db
      - DATA_API_URL=http://data-api:8006
      - HA_URL=${HA_HTTP_URL:-}
      - HA_TOKEN=${HA_TOKEN:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - DEVICE_INTELLIGENCE_URL=http://device-intelligence-service:8023
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - QUERY_TIMEOUT=${QUERY_TIMEOUT:-5.0}
      - ENABLE_CACHING=${ENABLE_CACHING:-True}
    volumes:
      - ai_automation_data:/app/data  # Shared database
      - ai_automation_models:/app/models  # Shared model storage
    networks:
      - homeiq-network
    depends_on:
      data-api:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '2.0'
        reservations:
          memory: 256M
          cpus: '1.0'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8018/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=ai-query-service,environment=production"

  ai-automation-ui:
    build:
      context: ./services/ai-automation-ui
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=
        - VITE_API_KEY=${API_KEY:-hs_P3rU9kQ2xZp6vL1fYc7bN4sTqD8mA0wR}
    container_name: ai-automation-ui
    restart: unless-stopped
    ports:
      - "3001:80"
    environment:
      - VITE_API_URL=
      - VITE_API_KEY=${API_KEY:-hs_P3rU9kQ2xZp6vL1fYc7bN4sTqD8mA0wR}
    depends_on:
      ai-core-service:
        condition: service_healthy
      ai-automation-service:
        condition: service_healthy
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
        labels: "service=ai-ui,environment=production"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  automation-miner:
    build:
      context: ./services/automation-miner
      dockerfile: Dockerfile
    container_name: automation-miner
    restart: unless-stopped
    ports:
      - "8029:8019"  # Fixed port conflict with ner-service
    env_file:
      - infrastructure/env.automation-miner
    environment:
      - ENABLE_AUTOMATION_MINER=true  # Epic AI-4: Enable weekly refresh
      - MINER_DB_PATH=data/automation_miner.db
      - DISCOURSE_BASE_URL=https://community.home-assistant.io
      - DISCOURSE_MIN_LIKES=${DISCOURSE_MIN_LIKES:-300}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - automation_miner_data:/app/data
    networks:
      - homeiq-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8019/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M  # Increased for crawler
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=automation-miner,environment=production,epic=ai-4"

  ha-setup-service:
    build:
      context: ./services/ha-setup-service
      dockerfile: Dockerfile
    container_name: homeiq-setup-service
    restart: unless-stopped
    ports:
      - "8027:8020"
    env_file:
      - .env
      - infrastructure/.env.websocket
    environment:
      - SERVICE_NAME=ha-setup-service
      - SERVICE_PORT=8020
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - HA_URL=${HA_HTTP_URL:-${HOME_ASSISTANT_URL:-http://192.168.1.86:8123}}
      - HA_TOKEN=${HOME_ASSISTANT_TOKEN:-}
      - DATABASE_URL=sqlite+aiosqlite:///./data/ha-setup.db
      - DATA_API_URL=http://data-api:8006
      - API_KEY=${API_KEY:-hs_P3rU9kQ2xZp6vL1fYc7bN4sTqD8mA0wR}
      - ADMIN_API_URL=http://admin-api:8004
      - HEALTH_CHECK_INTERVAL=60
      - INTEGRATION_CHECK_INTERVAL=300
      - ENABLE_PERFORMANCE_MONITORING=true
      - PERFORMANCE_SAMPLE_INTERVAL=30
    volumes:
      - ha_setup_data:/app/data
      - homeiq_logs:/var/log/homeiq
    depends_on:
      data-api:
        condition: service_healthy
      admin-api:
        condition: service_healthy
    networks:
      - homeiq-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8020/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=ha-setup-service,environment=production"

  device-intelligence-service:
    build:
      context: ./services/device-intelligence-service
      dockerfile: Dockerfile
    container_name: homeiq-device-intelligence
    restart: unless-stopped
    ports:
      - "8028:8019"  # Fixed port conflict with ner-service
    extra_hosts:
      - "homeassistant:192.168.1.86"
    env_file:
      - .env
    environment:
      - DEVICE_INTELLIGENCE_PORT=${DEVICE_INTELLIGENCE_PORT:-8019}
      - DEVICE_INTELLIGENCE_HOST=${DEVICE_INTELLIGENCE_HOST:-0.0.0.0}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - SQLITE_DATABASE_URL=${SQLITE_DATABASE_URL:-sqlite:///./data/device_intelligence.db}
      - HA_URL=${HA_HTTP_URL:-${HOME_ASSISTANT_URL:-http://homeassistant:8123}}
      - HA_WS_URL=${HA_WS_URL:-}
      - NABU_CASA_URL=https://lwzisze94hrpqde9typkwgu5pptxdkoh.ui.nabu.casa
      - HA_TOKEN=${HOME_ASSISTANT_TOKEN:-}
      - MQTT_BROKER=${MQTT_BROKER:-mqtt://192.168.1.86:1883}
      - MQTT_USERNAME=${MQTT_USERNAME:-}
      - MQTT_PASSWORD=${MQTT_PASSWORD:-}
      - ZIGBEE2MQTT_BASE_TOPIC=${ZIGBEE2MQTT_BASE_TOPIC:-zigbee2mqtt}
      - MAX_WORKERS=${MAX_WORKERS:-4}
      - REQUEST_TIMEOUT=30
      - CACHE_TTL=300
      - MAX_CACHE_SIZE=1000
      # ML Model Configuration (2025 improvements)
      - ML_FAILURE_MODEL=${ML_FAILURE_MODEL:-randomforest}  # randomforest, lightgbm, or tabpfn
      - ML_USE_INCREMENTAL=${ML_USE_INCREMENTAL:-false}  # Enable incremental learning
      - ML_INCREMENTAL_UPDATE_THRESHOLD=${ML_INCREMENTAL_UPDATE_THRESHOLD:-100}  # Samples before incremental update
      - GNN_USE_COMPILE=${GNN_USE_COMPILE:-true}  # Use PyTorch compile for GNN (1.5-2x speedup)
    volumes:
      - device_intelligence_data:/app/data
      - ./infrastructure:/app/infrastructure:rw
    depends_on:
      influxdb:
        condition: service_healthy
    networks:
      - homeiq-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8019/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=device-intelligence,environment=production"

  device-health-monitor:
    build:
      context: ./services/device-health-monitor
      dockerfile: Dockerfile
    container_name: homeiq-device-health-monitor
    restart: unless-stopped
    ports:
      - "8019:8019"
    env_file:
      - .env
    environment:
      - DEVICE_HEALTH_MONITOR_PORT=${DEVICE_HEALTH_MONITOR_PORT:-8019}
      - HA_URL=${HA_HTTP_URL:-${HOME_ASSISTANT_URL:-http://homeassistant:8123}}
      - HA_TOKEN=${HOME_ASSISTANT_TOKEN:-}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - RELOAD=${RELOAD:-false}
    extra_hosts:
      - "homeassistant:192.168.1.86"
    networks:
      - homeiq-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8019/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=device-health-monitor,environment=production"

  device-context-classifier:
    build:
      context: ./services/device-context-classifier
      dockerfile: Dockerfile
    container_name: homeiq-device-context-classifier
    restart: unless-stopped
    ports:
      - "8032:8020"  # External port 8032, internal 8020 (8020 already used by openai-service)
    env_file:
      - .env
    environment:
      - DEVICE_CONTEXT_CLASSIFIER_PORT=${DEVICE_CONTEXT_CLASSIFIER_PORT:-8020}
      - HA_URL=${HA_HTTP_URL:-${HOME_ASSISTANT_URL:-http://homeassistant:8123}}
      - HA_TOKEN=${HOME_ASSISTANT_TOKEN:-}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - RELOAD=${RELOAD:-false}
    extra_hosts:
      - "homeassistant:192.168.1.86"
    networks:
      - homeiq-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8020/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=device-context-classifier,environment=production"

  device-setup-assistant:
    build:
      context: ./services/device-setup-assistant
      dockerfile: Dockerfile
    container_name: homeiq-device-setup-assistant
    restart: unless-stopped
    ports:
      - "8021:8021"
    env_file:
      - .env
    environment:
      - DEVICE_SETUP_ASSISTANT_PORT=${DEVICE_SETUP_ASSISTANT_PORT:-8021}
      - HA_URL=${HA_HTTP_URL:-${HOME_ASSISTANT_URL:-http://homeassistant:8123}}
      - HA_TOKEN=${HOME_ASSISTANT_TOKEN:-}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - RELOAD=${RELOAD:-false}
    extra_hosts:
      - "homeassistant:192.168.1.86"
    networks:
      - homeiq-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8021/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=device-setup-assistant,environment=production"

  device-database-client:
    build:
      context: ./services/device-database-client
      dockerfile: Dockerfile
    container_name: homeiq-device-database-client
    restart: unless-stopped
    ports:
      - "8022:8022"
    env_file:
      - .env
    environment:
      - DEVICE_DATABASE_CLIENT_PORT=${DEVICE_DATABASE_CLIENT_PORT:-8022}
      - DEVICE_DATABASE_API_URL=${DEVICE_DATABASE_API_URL:-}
      - DEVICE_DATABASE_API_KEY=${DEVICE_DATABASE_API_KEY:-}
      - DEVICE_CACHE_DIR=${DEVICE_CACHE_DIR:-data/device_cache}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - RELOAD=${RELOAD:-false}
    volumes:
      - device_cache_data:/app/data/device_cache
    networks:
      - homeiq-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8022/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=device-database-client,environment=production"

  device-recommender:
    build:
      context: ./services/device-recommender
      dockerfile: Dockerfile
    container_name: homeiq-device-recommender
    restart: unless-stopped
    ports:
      - "8023:8023"
    env_file:
      - .env
    environment:
      - DEVICE_RECOMMENDER_PORT=${DEVICE_RECOMMENDER_PORT:-8023}
      - HA_URL=${HA_HTTP_URL:-${HOME_ASSISTANT_URL:-http://homeassistant:8123}}
      - HA_TOKEN=${HOME_ASSISTANT_TOKEN:-}
      - DEVICE_DATABASE_API_URL=${DEVICE_DATABASE_API_URL:-}
      - DEVICE_DATABASE_API_KEY=${DEVICE_DATABASE_API_KEY:-}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - RELOAD=${RELOAD:-false}
    extra_hosts:
      - "homeassistant:192.168.1.86"
    networks:
      - homeiq-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8023/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=device-recommender,environment=production"

  # Home Assistant Test Container (Optional - use --profile test)
  home-assistant-test:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeiq-ha-test
    restart: unless-stopped
    ports:
      - "8124:8123"  # Web UI (different port from production)
    volumes:
      - ha_test_config:/config
      - ha_test_data:/data
    environment:
      - TZ=${TZ:-America/Los_Angeles}
    networks:
      - homeiq-network
    profiles:
      - test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8123/api/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=ha-test,environment=test"

  # WebSocket Ingestion Test Service (Optional - use --profile test)
  websocket-ingestion-test:
    build:
      context: ./services/websocket-ingestion
      dockerfile: Dockerfile
    container_name: homeiq-websocket-test
    restart: unless-stopped
    ports:
      - "8002:8001"  # Different port from production (8001)
    env_file:
      - .env
    environment:
      - DOCKER_CONTAINER=true
      # Deployment Mode Configuration (Epic 40)
      - DEPLOYMENT_MODE=test
      # Home Assistant Test Configuration
      - HA_HTTP_URL=http://home-assistant-test:8123
      - HA_WS_URL=http://home-assistant-test:8123/api/websocket
      - HA_TOKEN=${HA_TEST_TOKEN:-}
      # Data API Configuration
      - DATA_API_URL=http://data-api:8006
      - WEBSOCKET_INGESTION_PORT=8001
      - ENABLE_HOME_ASSISTANT=true
      # InfluxDB Test Configuration (Epic 40 - Separate Test Bucket)
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_USERNAME=admin
      - INFLUXDB_PASSWORD=admin123
      - INFLUXDB_ORG=homeiq-test
      - INFLUXDB_BUCKET=home_assistant_events_test
      - INFLUXDB_TOKEN=homeiq-test-token
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FILE_PATH=${LOG_FILE_PATH:-/app/logs}
      - LOG_FORMAT=json
      - LOG_OUTPUT=both
      - API_KEY=${API_KEY:-hs_P3rU9kQ2xZp6vL1fYc7bN4sTqD8mA0wR}
      # WebSocket Retry Configuration
      - WEBSOCKET_MAX_RETRIES=${WEBSOCKET_MAX_RETRIES:--1}
      - WEBSOCKET_MAX_RETRY_DELAY=${WEBSOCKET_MAX_RETRY_DELAY:-300}
      # Device storage configuration
      - STORE_DEVICE_HISTORY_IN_INFLUXDB=${STORE_DEVICE_HISTORY_IN_INFLUXDB:-false}
    depends_on:
      home-assistant-test:
        condition: service_healthy
      data-api:
        condition: service_healthy
      influxdb:
        condition: service_healthy
    networks:
      - homeiq-network
    profiles:
      - test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=websocket-ingestion-test,environment=test"
    volumes:
      - homeiq_logs:/var/log/homeiq

volumes:
  influxdb_data:
  influxdb_config:
  data_retention_backups:
  homeiq_logs:
  sqlite-data:
  ai_automation_data:
  ha_setup_data:
  ai_automation_models:  # Phase 1: Persistent model cache (OpenVINO INT8 models)
  automation_miner_data:  # Epic AI-4: Community automation corpus
  device_intelligence_data:  # Device Intelligence Service data
  device_cache_data:  # Device Database Client cache
  ha_test_config:  # Home Assistant test container configuration
  ha_test_data:  # Home Assistant test container data
  ha_ai_agent_data:  # HA AI Agent Service context cache
  proactive_agent_data:  # Proactive Agent Service suggestions storage

networks:
  homeiq-network:
    driver: bridge
