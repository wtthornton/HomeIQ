name: Docker Test

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'services/**'
      - 'docker-compose.yml'
      - '.github/workflows/docker-test.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'services/**'
      - 'docker-compose.yml'
      - '.github/workflows/docker-test.yml'
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  test-services:
    name: Test Docker Services
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test images
        run: |
          docker compose build --parallel

      - name: Start services
        run: |
          docker compose up -d influxdb sqlite-data
          sleep 10

      - name: Test service health checks
        run: |
          # Wait for services to be healthy
          timeout 60 bash -c 'until docker compose ps | grep -q "healthy"; do sleep 2; done'
          
          # Test individual service health endpoints
          docker compose exec -T websocket-ingestion curl -f http://localhost:8001/health || echo "WebSocket service health check"
          docker compose exec -T data-api curl -f http://localhost:8006/health || echo "Data API health check"
          docker compose exec -T admin-api curl -f http://localhost:8004/health || echo "Admin API health check"

      - name: Verify resource limits
        run: |
          # Check that CPU limits are set
          docker compose config | grep -A 5 "deploy:" | grep -q "cpus:" || (echo "CPU limits not found" && exit 1)

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v

