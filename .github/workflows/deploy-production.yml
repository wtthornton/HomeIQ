name: Deploy to Production

on:
  push:
    branches: [ main ]
    paths:
      - 'services/**'
      - 'docker-compose.yml'
      - '.github/workflows/deploy-production.yml'
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (use with caution)'
        required: false
        default: 'false'
        type: boolean
      skip_security:
        description: 'Skip security scans (use with caution)'
        required: false
        default: 'false'
        type: boolean

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # Quality Gates - Must pass before deployment
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    outputs:
      tests_passed: ${{ steps.test-results.outputs.passed }}
      security_passed: ${{ steps.security-results.outputs.passed }}
      code_quality_passed: ${{ steps.code-quality-results.outputs.passed }}
      config_valid: ${{ steps.config-validation.outputs.valid }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Run tests
        id: test-results
        if: ${{ !inputs.skip_tests || github.event_name != 'workflow_dispatch' }}
        run: |
          echo "Running test suite..."
          # Check if tests exist and run them
          if [ -f "scripts/simple-unit-tests.py" ]; then
            python scripts/simple-unit-tests.py || TEST_EXIT=$?
            if [ ${TEST_EXIT:-0} -eq 0 ]; then
              echo "passed=true" >> $GITHUB_OUTPUT
              echo "✅ Tests passed"
            else
              echo "passed=false" >> $GITHUB_OUTPUT
              echo "❌ Tests failed"
              exit 1
            fi
          else
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "⚠️ No test script found, skipping tests"
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Security scan
        id: security-results
        if: ${{ !inputs.skip_security || github.event_name != 'workflow_dispatch' }}
        run: |
          echo "Running security scan..."
          # Basic security check - verify docker-compose config
          docker compose config --quiet
          echo "passed=true" >> $GITHUB_OUTPUT
          echo "✅ Security scan passed (basic validation)"

      - name: Code quality check
        id: code-quality-results
        run: |
          echo "Running code quality checks..."
          # Install TappsCodingAgents if available
          if command -v python -m tapps_agents.cli &> /dev/null; then
            # Check code quality for critical services
            python -m tapps_agents.cli reviewer score services/websocket-ingestion/src/main.py || true
            python -m tapps_agents.cli reviewer score services/data-api/src/main.py || true
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "✅ Code quality check completed"
          else
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "⚠️ TappsCodingAgents not available, skipping code quality check"
          fi

      - name: Validate Docker Compose config
        id: config-validation
        run: |
          echo "Validating docker-compose.yml..."
          docker compose config --quiet
          if [ $? -eq 0 ]; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "✅ Docker Compose config is valid"
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "❌ Docker Compose config validation failed"
            exit 1
          fi

  # Pre-deployment validation
  pre-deployment:
    name: Pre-Deployment Validation
    runs-on: ubuntu-latest
    needs: quality-gates
    if: |
      needs.quality-gates.outputs.tests_passed == 'true' &&
      needs.quality-gates.outputs.security_passed == 'true' &&
      needs.quality-gates.outputs.code_quality_passed == 'true' &&
      needs.quality-gates.outputs.config_valid == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run pre-deployment validation
        run: |
          echo "Running pre-deployment validation..."
          if [ -f "scripts/deployment/validate-deployment.py" ]; then
            python scripts/deployment/validate-deployment.py --pre-deployment
          else
            echo "⚠️ Validation script not found, creating basic validation..."
            # Basic validation
            if [ ! -f "docker-compose.yml" ]; then
              echo "❌ docker-compose.yml not found"
              exit 1
            fi
            echo "✅ Basic validation passed"
          fi

  # Build and deploy
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [quality-gates, pre-deployment]
    if: |
      needs.quality-gates.outputs.tests_passed == 'true' &&
      needs.quality-gates.outputs.security_passed == 'true' &&
      needs.quality-gates.outputs.code_quality_passed == 'true' &&
      needs.quality-gates.outputs.config_valid == 'true'
    environment:
      name: production
      url: https://homeiq.example.com
    concurrency:
      group: production-deployment
      cancel-in-progress: false
    outputs:
      deployment-id: ${{ steps.deployment-id.outputs.id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate deployment ID
        id: deployment-id
        run: |
          DEPLOYMENT_ID="deploy-$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA:0:7}"
          echo "id=${DEPLOYMENT_ID}" >> $GITHUB_OUTPUT
          echo "Deployment ID: ${DEPLOYMENT_ID}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build all services
        run: |
          echo "::group::Build Performance"
          BUILD_START=$(date +%s)
          docker compose build --parallel
          BUILD_END=$(date +%s)
          BUILD_DURATION=$((BUILD_END - BUILD_START))
          BUILD_MINUTES=$((BUILD_DURATION / 60))
          BUILD_SECONDS=$((BUILD_DURATION % 60))
          echo "::notice title=Build Time::Build completed in ${BUILD_MINUTES}m ${BUILD_SECONDS}s"
          echo "BUILD_DURATION=${BUILD_DURATION}" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: Build Performance Summary
        if: always()
        run: |
          echo "## Build Performance" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Duration:** ${BUILD_DURATION}s (${BUILD_MINUTES}m ${BUILD_SECONDS}s)" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type:** Parallel" >> $GITHUB_STEP_SUMMARY
          echo "- **Optimizations:** BuildKit enabled, parallel builds" >> $GITHUB_STEP_SUMMARY

      - name: Tag images with deployment ID
        run: |
          # Tag images for rollback capability
          docker compose config --services | while read service; do
            docker tag "homeiq-${service}:latest" "homeiq-${service}:${{ steps.deployment-id.outputs.id }}" || true
          done

      - name: Start services
        run: |
          docker compose up -d
          echo "Waiting for services to start..."
          sleep 30

      - name: Post-deployment validation
        run: |
          echo "Running post-deployment validation..."
          if [ -f "scripts/deployment/validate-deployment.py" ]; then
            python scripts/deployment/validate-deployment.py --post-deployment
          else
            echo "⚠️ Validation script not found, running basic health checks..."
            docker compose ps
          fi

      - name: Health check verification
        run: |
          echo "Running comprehensive health checks..."
          if [ -f "scripts/deployment/health-check.sh" ]; then
            bash scripts/deployment/health-check.sh
          else
            echo "⚠️ Health check script not found, running basic checks..."
            # Basic health checks
            docker compose ps --format json | jq -r '.[] | select(.Health != "healthy" and .Health != "") | "❌ \(.Name): \(.Health)"' || true
            docker compose ps --format json | jq -r '.[] | select(.State != "running") | "❌ \(.Name): \(.State)"' || true
          fi

      - name: Track deployment
        if: always()
        run: |
          echo "Tracking deployment..."
          if [ -f "scripts/deployment/track-deployment.py" ]; then
            # Map job status to deployment status
            if [[ "${{ job.status }}" == "success" ]]; then
              DEPLOY_STATUS="success"
            elif [[ "${{ job.status }}" == "failure" ]]; then
              DEPLOY_STATUS="failure"
            else
              DEPLOY_STATUS="in_progress"
            fi
            python scripts/deployment/track-deployment.py \
              --deployment-id "${{ steps.deployment-id.outputs.id }}" \
              --status "$DEPLOY_STATUS" \
              --commit "${{ github.sha }}" \
              --branch "${{ github.ref_name }}"
          else
            echo "⚠️ Deployment tracking script not found"
          fi

      - name: Rollback on failure
        if: failure()
        run: |
          echo "❌ Deployment failed, initiating rollback..."
          if [ -f "scripts/deployment/rollback.sh" ]; then
            bash scripts/deployment/rollback.sh --deployment-id "${{ steps.deployment-id.outputs.id }}"
          else
            echo "⚠️ Rollback script not found, manual intervention required"
            docker compose down
          fi
        continue-on-error: true

      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "✅ **Deployment Successful**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Deployment Failed**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment ID:** \`${{ steps.deployment-id.outputs.id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Send Deployment Notifications
    needs: deploy
    if: always()
    runs-on: ubuntu-latest
    uses: ./.github/workflows/deployment-notify.yml
    secrets: inherit
    with:
      deployment-id: ${{ needs.deploy.outputs.deployment-id }}
      status: ${{ needs.deploy.result == 'success' && 'success' || 'failure' }}
      commit: ${{ github.sha }}
      branch: ${{ github.ref_name }}

