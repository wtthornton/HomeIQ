# Story 13.4: Sports Data & HA Automation Integration (Epic 12 + 13 Convergence)

**Epic**: Epic 13 - Admin API Service Separation (+ Epic 12 Integration)  
**Story Number**: 13.4  
**Status**: ~~Draft~~ **SUPERSEDED**  
**Created**: 2025-10-13  
**Superseded**: 2025-10-14  
**Estimated Effort**: 4 days  
**Depends On**: Story 13.3 (all endpoints migrated), Epic 12 Story 12.1 (sports InfluxDB writer)

---

## ⚠️ **STORY SUPERSEDED**

**Reason**: This story duplicated work already defined in Epic 12 Stories 12.2 and 12.3

**Replacement Stories**:
- **Story 12.2**: Historical Query Endpoints (replaces tasks 1, 4, 7)
- **Story 12.3**: Adaptive Monitor + HA Webhooks (replaces tasks 2, 3, 5, 6, 8, 9)

**See**: `docs/stories/epic-12-sports-data-influxdb-persistence.md` for current implementation plan

**Why Consolidated**: 
- Epic 12 is the proper home for sports-specific work
- Adaptive state machine strategy (12h → 5min → 5sec) is more efficient
- Cleaner epic organization (all sports work in Epic 12)
- API hub context properly reflected

---

## Original Story Content (For Reference)

---

## Story

**As a** Home Assistant user,  
**I want** sports data with historical queries and automation endpoints available through the data-api service,  
**so that** I can view historical sports data in the dashboard and create Home Assistant automations that react to game events.

---

## Story Context

**Existing System Integration:**
- **Integrates with**: data-api (fully migrated in Story 13.3), sports-data service (port 8005), InfluxDB (sports measurements)
- **Technology**: FastAPI routers, InfluxDB queries, webhook system, asyncio background tasks
- **Follows pattern**: Events and devices endpoints pattern in data-api
- **Touch points**: Dashboard Sports tab, Home Assistant webhook system, sports-data service

**Current State** (After Story 13.3):
- data-api has all feature endpoints
- admin-api has only system monitoring endpoints
- sports-data service has InfluxDB writer (Epic 12.1)
- No sports query endpoints exist
- No HA automation endpoints exist

**Target State**:
- Sports historical query endpoints in data-api
- HA automation endpoints in data-api
- Webhook system functional for game events
- Dashboard Sports tab shows historical data
- Home Assistant automations can query and subscribe to game events

**Epic 12 Integration**:
This story completes Epic 12 Stories 12.2 and 12.3 by implementing them in data-api (not admin-api).

---

## Acceptance Criteria

### Sports Data Endpoints (Epic 12.2)

1. **Historical games endpoint** functional: `GET /api/v1/sports/games/history?team=Patriots&season=2025`
2. **Score timeline endpoint** functional: `GET /api/v1/sports/games/timeline/{game_id}` returns score progression
3. **Team schedule endpoint** functional: `GET /api/v1/sports/schedule/{team}` returns full season with context
4. **Query performance** <100ms for typical historical queries
5. **Results include computed stats** (wins, losses, win percentage)

### HA Automation Endpoints (Epic 12.3)

6. **Game status endpoint** responds <50ms: `GET /api/v1/ha/game-status/{team}`
7. **Game context endpoint** provides rich data: `GET /api/v1/ha/game-context/{team}`
8. **Webhook registration** functional: `POST /api/v1/ha/webhooks/register`
9. **Webhook delivery** <30 seconds from event (game start, end, score change)
10. **Webhook security** HMAC signature validation implemented

### Integration Requirements

11. **Dashboard Sports tab** displays historical data from data-api
12. **Home Assistant webhooks** trigger successfully (3 example automations tested)
13. **Sports WebSocket stream** delivers real-time updates to dashboard
14. **Background task** checks for game events every 15 seconds
15. **Webhook retry logic** attempts 3 times with exponential backoff

### Quality Requirements

16. **API documentation** complete in FastAPI /docs for both data-api and admin-api
17. **HA automation examples** provided (3+ YAML configs in README)
18. **E2E testing** with Home Assistant test instance
19. **No regression** in existing data-api endpoints (events, devices, alerts, etc.)
20. **Architecture documentation** updated showing complete separation

---

## Tasks / Subtasks

### Task 1: Create Sports Query Endpoints (AC: 1, 2, 3, 4, 5)
- [ ] Create `services/data-api/src/sports_endpoints.py`
- [ ] Implement `GET /api/v1/sports/games/history` with team/season filters
- [ ] Implement `GET /api/v1/sports/games/timeline/{game_id}` for score progression
- [ ] Implement `GET /api/v1/sports/schedule/{team}` with historical context
- [ ] Create InfluxDB query helpers (query nfl_scores, nhl_scores measurements)
- [ ] Add result caching (5-minute TTL for historical queries)
- [ ] Add pagination (max 1000 results)
- [ ] Register router in data-api main.py
- [ ] Test all endpoints with real sports data
- [ ] Verify computed stats (wins, losses, win %)

### Task 2: Create HA Automation Endpoints (AC: 6, 7, 8, 10)
- [ ] Create `services/data-api/src/ha_automation_endpoints.py`
- [ ] Implement `GET /api/v1/ha/game-status/{team}` (quick status check)
- [ ] Implement `GET /api/v1/ha/game-context/{team}` (rich game data)
- [ ] Implement `POST /api/v1/ha/webhooks/register` (webhook registration)
- [ ] Implement `DELETE /api/v1/ha/webhooks/{id}` (webhook removal)
- [ ] Implement `GET /api/v1/ha/webhooks` (list registered webhooks)
- [ ] Create webhook storage (JSON file or InfluxDB measurement)
- [ ] Implement HMAC signature validation
- [ ] Test response times (<50ms for status endpoint)
- [ ] Register router in data-api

### Task 3: Implement Webhook Event Detection (AC: 9, 14, 15)
- [ ] Create background task in data-api
- [ ] Poll sports InfluxDB measurements every 15 seconds
- [ ] Compare current state vs previous state (detect events)
- [ ] Detect game start (status: scheduled → live)
- [ ] Detect game end (status: live → finished)
- [ ] Detect score changes (significant: 6+ points or lead change)
- [ ] Trigger registered webhooks on events
- [ ] Implement webhook delivery with HTTP POST
- [ ] Add HMAC signature to webhook payloads
- [ ] Implement retry logic (3 attempts, exponential backoff: 1s, 2s, 4s)
- [ ] Log webhook deliveries and failures

### Task 4: Update Dashboard Sports Tab (AC: 11, 13)
- [ ] Update `services/health-dashboard/src/components/tabs/SportsTab.tsx`
- [ ] Add historical data section (season stats, win/loss record)
- [ ] Add score timeline chart (for completed games)
- [ ] Update API calls to use data-api
- [ ] Add WebSocket connection for real-time sports updates
- [ ] Test historical queries display correctly
- [ ] Test real-time updates work
- [ ] Test error handling (no data, API failure)

### Task 5: Create HA Automation Examples (AC: 12, 17)
- [ ] Create `docs/HA_AUTOMATION_EXAMPLES.md`
- [ ] Example 1: Turn on TV when game starts (webhook trigger)
- [ ] Example 2: Flash lights when team scores (webhook + score change detection)
- [ ] Example 3: Pre-game routine (query endpoint in HA automation)
- [ ] Example 4: Post-game notification (webhook on game end)
- [ ] Test all 3 examples with Home Assistant test instance
- [ ] Document webhook registration process
- [ ] Document HA sensor integration

### Task 6: E2E Testing with Home Assistant (AC: 12, 18)
- [ ] Setup Home Assistant test instance
- [ ] Register webhook in HA: `POST /api/v1/ha/webhooks/register`
- [ ] Create HA automation using webhook trigger
- [ ] Simulate game event (change score in InfluxDB)
- [ ] Verify webhook triggers HA automation
- [ ] Test HMAC signature validation
- [ ] Test retry logic (temporarily disable HA webhook endpoint)
- [ ] Verify all 3 example automations work

### Task 7: API Documentation (AC: 16)
- [ ] Update FastAPI /docs page for data-api (auto-generated)
- [ ] Add endpoint descriptions and examples
- [ ] Document request/response schemas
- [ ] Document sports data models (Game, Team, Schedule)
- [ ] Document HA automation models (GameStatus, WebhookRegistration)
- [ ] Add code examples for each endpoint
- [ ] Test interactive API docs

### Task 8: Architecture Documentation Updates (AC: 20)
- [ ] Update `implementation/analysis/EXTERNAL_API_CALL_TREES.md`
  - [ ] Add sports data as Pattern A (now persists to InfluxDB)
  - [ ] Update service ports reference (add data-api)
  - [ ] Update architecture diagrams
- [ ] Update `docs/architecture.md`
  - [ ] Show admin-api and data-api separation
  - [ ] Document service responsibilities
- [ ] Update `docs/API_DOCUMENTATION.md`
  - [ ] Add data-api section
  - [ ] Update endpoint listing
- [ ] Create `docs/HA_INTEGRATION_GUIDE.md`
  - [ ] Webhook setup
  - [ ] Automation examples
  - [ ] Troubleshooting

### Task 9: Final Integration Testing (AC: 19)
- [ ] Test all data-api endpoints (events, devices, alerts, metrics, sports, HA)
- [ ] Test all admin-api endpoints (health, monitoring, Docker, config, stats)
- [ ] Test all 12 dashboard tabs
- [ ] Test WebSocket connections for all streams
- [ ] Test Home Assistant webhook integrations
- [ ] Verify no regressions anywhere
- [ ] Performance testing (both services)
- [ ] Load testing (4+ concurrent users)

---

## Dev Notes

### Sports InfluxDB Query Examples

From Epic 12 architecture (measurements created by sports-data service in Story 12.1):

```python
# Get team's season record
async def get_team_games(team: str, season: int):
    query = f"""
    SELECT * FROM nfl_scores
    WHERE season = '{season}'
    AND (home_team = '{team}' OR away_team = '{team}')
    ORDER BY time DESC
    """
    df = influxdb_client.query(query, language='sql', mode='pandas')
    return df.to_dict('records')

# Get score timeline for a game
async def get_game_timeline(game_id: str):
    query = f"""
    SELECT time, home_score, away_score, quarter, time_remaining
    FROM nfl_scores
    WHERE game_id = '{game_id}'
    ORDER BY time
    """
    df = influxdb_client.query(query, language='sql', mode='pandas')
    return df.to_dict('records')
```

### HA Automation Endpoint Pattern

```python
# Quick status check (<50ms requirement)
@router.get("/ha/game-status/{team}")
async def get_game_status(team: str):
    # Query only latest point (fast)
    query = f"""
    SELECT * FROM nfl_scores
    WHERE (home_team = '{team}' OR away_team = '{team}')
    AND time > now() - 6h
    ORDER BY time DESC
    LIMIT 1
    """
    result = await influxdb_client.query(query)
    
    if not result:
        return {"status": "no_game", "team": team}
    
    game = result[0]
    return {
        "status": game['status'],  # "live" | "upcoming" | "finished"
        "game_id": game['game_id'],
        "opponent": game['away_team'] if game['home_team'] == team else game['home_team'],
        "score": f"{game['home_score']}-{game['away_score']}" if game['status'] == 'live' else None,
        "start_time": game['time']
    }
```

### Webhook Registration Model

```python
# Pydantic model
class WebhookRegistration(BaseModel):
    webhook_url: str              # HA webhook URL
    secret: str                   # HMAC secret
    team: str                     # Team to monitor
    events: List[str]             # ["game_start", "game_end", "score_change"]
    filters: Optional[Dict] = {}  # Additional filters

# Storage
webhooks = []  # In-memory for Phase 1, InfluxDB for Phase 2

# HMAC signature
import hmac
import hashlib

def generate_signature(payload: dict, secret: str) -> str:
    message = json.dumps(payload, sort_keys=True)
    signature = hmac.new(
        secret.encode(),
        message.encode(),
        hashlib.sha256
    ).hexdigest()
    return signature
```

### Home Assistant YAML Examples

```yaml
# Example 1: Turn on TV when Patriots game starts
automation:
  - alias: "Patriots Game - TV On"
    trigger:
      - platform: webhook
        webhook_id: patriots_game_start
        allowed_methods:
          - POST
    condition:
      - condition: state
        entity_id: binary_sensor.someone_home
        state: "on"
    action:
      - service: media_player.turn_on
        target:
          entity_id: media_player.living_room_tv
      - service: notify.mobile_app
        data:
          message: "Patriots game starting! Score: {{ trigger.json.home_score }}-{{ trigger.json.away_score }}"

# Example 2: Flash lights on score change
automation:
  - alias: "Patriots Score - Flash Lights"
    trigger:
      - platform: webhook
        webhook_id: patriots_score_update
    condition:
      - condition: template
        value_template: "{{ trigger.json.score_change > 0 }}"
    action:
      - service: light.turn_on
        target:
          entity_id: light.living_room
        data:
          flash: long
          color_name: "blue"

# Example 3: Query game status in automation
automation:
  - alias: "Pre-Game Setup"
    trigger:
      - platform: time_pattern
        minutes: "/15"
    action:
      - service: rest_command.check_game_status
        data:
          team: "Patriots"
      - condition: template
        value_template: "{{ states('sensor.patriots_game_status') == 'upcoming' }}"
      - service: scene.turn_on
        target:
          entity_id: scene.game_day

# REST command to query data-api
rest_command:
  check_game_status:
    url: "http://localhost:8006/api/v1/ha/game-status/{{ team }}"
    method: GET
    timeout: 5
```

---

## Testing

### E2E Test with Home Assistant

**Setup**:
1. Home Assistant test instance (Docker)
2. Register webhook in data-api
3. Create HA automation with webhook trigger
4. Simulate game event

**Test Procedure**:
```bash
# 1. Register webhook in data-api
curl -X POST http://localhost:8006/api/v1/ha/webhooks/register \
  -H "Content-Type: application/json" \
  -d '{
    "webhook_url": "http://homeassistant:8123/api/webhook/patriots_game_start",
    "secret": "test_secret_123",
    "team": "Patriots",
    "events": ["game_start"]
  }'

# 2. Simulate game start (write to InfluxDB)
# (Background task detects status change: scheduled → live)

# 3. Verify webhook delivered to HA
# Check HA logs for webhook trigger

# 4. Verify HA automation executed
# Check for expected action (TV on, notification sent)
```

### Performance Test Requirements

- [ ] Game status queries: <50ms (p95)
- [ ] Historical queries: <100ms (p95)
- [ ] Webhook delivery: <30s from event
- [ ] WebSocket sports updates: <100ms latency

---

## QA Results

(To be populated by QA Agent after implementation)

---

**Story Ready for**: Development  
**Previous Story**: 13.3 - Migrate Remaining Feature Endpoints  
**Completes**: Epic 13 + Epic 12 (Stories 12.2, 12.3)

