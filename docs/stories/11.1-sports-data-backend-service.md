# Story 11.1: Sports Data Backend Service

## Status
Ready for Review

## Story
**As a** dashboard user,  
**I want** a backend service that fetches sports data for my selected teams only,  
**so that** I can see live game updates without exceeding API rate limits.

## Acceptance Criteria

1. FastAPI service running on port 8005 with health check endpoint
2. ESPN API client fetches NFL data with team filtering
3. NHL Official API client fetches NHL data with team filtering
4. Only selected teams' data is fetched (no team = no data)
5. Caching layer with 15-second TTL for live games, 5-minute for upcoming
6. API endpoints: `/api/v1/games/live`, `/api/v1/games/upcoming`, `/api/v1/teams`, `/api/v1/user/teams`
7. Docker container configured in docker-compose.yml
8. Error handling with fallback to cached data
9. Rate limiting prevents API quota exhaustion
10. API usage tracking and monitoring

## Tasks / Subtasks

- [x] Task 1: Setup FastAPI service structure (AC: 1, 7)
  - [x] Create `services/sports-data/` directory structure
  - [x] Setup `main.py` with FastAPI app
  - [x] Create `requirements.txt` with dependencies
  - [x] Add Dockerfile (Python 3.11-alpine base)
  - [x] Configure CORS for dashboard access
  - [x] Add health check endpoint `/health`
  - [x] Update docker-compose.yml with sports-data service

- [x] Task 2: Implement API clients (AC: 2, 3)
  - [x] Create `sports_api_client.py` base class
  - [x] Implement ESPN API client for NFL data
  - [x] Implement NHL Official API client
  - [x] Add API key configuration from environment
  - [x] Parse API responses into Game/Team models
  - [x] Handle API errors gracefully

- [x] Task 3: Implement team-based filtering (AC: 4)
  - [x] Add `team_ids` parameter to get_live_games()
  - [x] Filter games by home/away team IDs
  - [x] Return empty list if no teams selected
  - [x] Add `get_available_teams()` method
  - [x] Create team ID mapping (e.g., 'sf' → '49ers')

- [x] Task 4: Add caching layer (AC: 5, 8)
  - [x] Create `cache_service.py` with CacheService class
  - [x] Implement in-memory cache with TTL
  - [x] Add cache for live games (15s TTL)
  - [x] Add cache for upcoming games (5m TTL)
  - [x] Implement cache miss/hit tracking
  - [x] Fallback to cache on API errors

- [x] Task 5: Create API endpoints (AC: 6)
  - [x] GET `/api/v1/games/live?team_ids=sf,dal`
  - [x] GET `/api/v1/games/upcoming?team_ids=sf,dal&hours=24`
  - [x] GET `/api/v1/teams?league=NFL`
  - [x] GET `/api/v1/user/teams`
  - [x] POST `/api/v1/user/teams` (save preferences)
  - [x] Add proper error responses (4xx, 5xx)

- [x] Task 6: Implement rate limiting and monitoring (AC: 9, 10)
  - [x] Add request counting per API source
  - [x] Calculate API usage estimates
  - [x] Create `/api/v1/metrics/api-usage` endpoint
  - [x] Log API calls with timestamps
  - [x] Warn when approaching rate limits

- [x] Task 7: Data models (AC: 2, 3)
  - [x] Create `models.py` with Pydantic models
  - [x] Team model (id, name, logo, colors, record)
  - [x] Game model (id, league, status, teams, score, period)
  - [x] GameStats model for statistics
  - [x] Validate API responses

- [x] Task 8: Testing (AC: all)
  - [x] Unit tests for API clients
  - [x] Unit tests for caching logic
  - [x] Unit tests for team filtering
  - [x] Integration test with mock API responses
  - [x] Test error handling scenarios
  - [x] Test rate limiting logic

## Dev Notes

### Relevant Source Tree

```
services/
├── sports-data/
│   ├── src/
│   │   ├── main.py                    # FastAPI app
│   │   ├── sports_api_client.py       # API clients
│   │   ├── cache_service.py           # Caching
│   │   ├── models.py                  # Data models
│   │   └── health_check.py            # Health endpoint
│   ├── tests/
│   │   └── test_sports_api.py
│   ├── Dockerfile
│   └── requirements.txt
├── admin-api/                         # Reference for patterns
└── websocket-ingestion/               # Reference for structure
```

### Technology Stack
- **Framework:** FastAPI 0.104.1
- **HTTP Client:** aiohttp 3.9.0
- **Data Validation:** Pydantic 2.5.0
- **Container:** Docker with Python 3.11-alpine
- **Caching:** In-memory (Redis optional for Phase 2)

### Integration Points
- Dashboard connects via `/api/sports/*` proxy (Nginx)
- Service runs on port 8005 (internal Docker network)
- No database dependencies (stateless service)
- Environment variables: `SPORTS_API_KEY`, `SPORTS_API_PROVIDER`

### API Endpoints Pattern
Follow existing admin-api patterns:
- Use async def for all endpoints
- Return JSON with `{"data": ..., "count": ..., "metadata": ...}` structure
- Include proper HTTP status codes
- Add CORS middleware for dashboard access

### Caching Strategy
- Live games: 15s TTL (balance freshness vs API calls)
- Upcoming games: 5m TTL (doesn't change frequently)
- Team list: 1h TTL (static data)
- Cache key format: `{resource}_{league}_{team_ids_sorted}`

### Error Handling
- API timeout: 10s max, fallback to cache
- API errors: Log error, return cached data if available
- No cache + API error: Return empty list with error message
- Rate limit hit: Return 429 with retry-after header

### Testing

**Test Framework:** pytest
**Test Location:** `services/sports-data/tests/`
**Test Standards:**
- Unit tests for each component
- Mock external API calls
- Test error scenarios
- Integration tests with mock data
- Coverage target: >80%

**Example Test:**
```python
@pytest.mark.asyncio
async def test_get_live_games_with_teams():
    client = SportsAPIClient(cache=MockCache())
    games = await client.get_live_games('NFL', ['sf', 'dal'])
    assert len(games) > 0
    assert all(g.home_team.id in ['sf', 'dal'] or 
               g.away_team.id in ['sf', 'dal'] 
               for g in games)
```

### Configuration
Environment variables (in `.env` or docker-compose):
```env
SPORTS_API_KEY=your_espn_api_key
SPORTS_API_PROVIDER=espn  # or 'nhl_official', 'sportsdata'
SPORTS_UPDATE_INTERVAL=15  # seconds for live games
MAX_TEAMS_PER_USER=10
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-12 | 1.0 | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (Dev Agent - James)

### Debug Log References
- Implementation: 2025-10-12 19:00-19:35
- Context7 KB: FastAPI patterns, pytest-asyncio testing
- All tasks completed successfully

### Completion Notes
- ✅ FastAPI service with 8 REST endpoints
- ✅ ESPN/NHL API clients with comprehensive error handling
- ✅ Team-based filtering (core requirement - only fetches selected teams!)
- ✅ Smart caching strategy (15s/5m TTL)
- ✅ Rate limiting and usage tracking
- ✅ Docker integration complete
- ✅ pytest-asyncio test suite following Context7 KB patterns
- ✅ README and configuration files

### File List
**Created:**
- `services/sports-data/src/main.py` - FastAPI application (350 lines)
- `services/sports-data/src/models.py` - Pydantic data models (150 lines)
- `services/sports-data/src/sports_api_client.py` - API clients (450 lines)
- `services/sports-data/src/cache_service.py` - Caching layer (80 lines)
- `services/sports-data/Dockerfile` - Container definition
- `services/sports-data/requirements.txt` - Python dependencies
- `services/sports-data/.env.example` - Environment configuration
- `services/sports-data/README.md` - Service documentation
- `services/sports-data/tests/test_cache_service.py` - Cache tests (120 lines)
- `services/sports-data/tests/test_sports_api_client.py` - API client tests (180 lines)

**Modified:**
- `docker-compose.yml` - Added sports-data service on port 8005

## QA Results
*To be filled by QA agent*

