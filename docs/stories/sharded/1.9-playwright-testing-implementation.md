# Story 1.9: Testing & Quality Assurance - Playwright Implementation Guide

## 🎯 **Quick Start Implementation**

### **Phase 1: Playwright Setup (Day 1)**
```bash
# Install Playwright
npm install --save-dev @playwright/test
npx playwright install
```

**Implementation Steps:**
1. **Create Playwright configuration** (`playwright.config.ts`):
   ```tsx
   import { defineConfig, devices } from '@playwright/test';

   export default defineConfig({
     testDir: './tests/e2e',
     fullyParallel: true,
     forbidOnly: !!process.env.CI,
     retries: process.env.CI ? 2 : 0,
     workers: process.env.CI ? 1 : undefined,
     reporter: 'html',
     use: {
       baseURL: 'http://localhost:3000',
       trace: 'on-first-retry',
       screenshot: 'only-on-failure',
     },
     projects: [
       {
         name: 'chromium',
         use: { ...devices['Desktop Chrome'] },
       },
       {
         name: 'firefox',
         use: { ...devices['Desktop Firefox'] },
       },
       {
         name: 'webkit',
         use: { ...devices['Desktop Safari'] },
       },
       {
         name: 'Mobile Chrome',
         use: { ...devices['Pixel 5'] },
       },
       {
         name: 'Mobile Safari',
         use: { ...devices['iPhone 12'] },
       },
     ],
     webServer: {
       command: 'npm run dev',
       url: 'http://localhost:3000',
       reuseExistingServer: !process.env.CI,
     },
   });
   ```

2. **Create test utilities** (`tests/utils/playwright-helpers.ts`):
   ```tsx
   import { Page, expect } from '@playwright/test';

   export class DashboardTestHelpers {
     static async waitForDashboardLoad(page: Page) {
       await page.waitForLoadState('networkidle');
       await page.waitForSelector('[data-testid="health-cards"]');
       await page.waitForSelector('[data-testid="metrics-chart"]');
     }

     static async takeComponentScreenshot(page: Page, selector: string, name: string) {
       await expect(page.locator(selector)).toHaveScreenshot(`${name}.png`);
     }

     static async testResponsiveLayout(page: Page, viewport: { width: number; height: number }) {
       await page.setViewportSize(viewport);
       await this.waitForDashboardLoad(page);
       await expect(page).toHaveScreenshot(`dashboard-${viewport.width}x${viewport.height}.png`);
     }

     static async mockApiResponses(page: Page) {
       await page.route('**/api/health', route => {
         route.fulfill({
           status: 200,
           contentType: 'application/json',
           body: JSON.stringify({
             status: 'healthy',
             services: [
               { name: 'WebSocket Service', status: 'running', uptime: '99.9%' },
               { name: 'Database', status: 'running', uptime: '99.8%' }
             ]
           })
         });
       });

       await page.route('**/api/metrics', route => {
         route.fulfill({
           status: 200,
           contentType: 'application/json',
           body: JSON.stringify({
             eventsPerSecond: 45,
             totalEvents: 125000,
             averageLatency: 12
           })
         });
       });
     }
   }
   ```

### **Phase 2: Visual Regression Tests (Day 2)**
```tsx
// tests/e2e/visual-regression.spec.ts
import { test, expect } from '@playwright/test';
import { DashboardTestHelpers } from '../utils/playwright-helpers';

test.describe('Dashboard Visual Tests', () => {
  test.beforeEach(async ({ page }) => {
    await DashboardTestHelpers.mockApiResponses(page);
  });

  test('dashboard layout matches snapshot', async ({ page }) => {
    await page.goto('/dashboard');
    await DashboardTestHelpers.waitForDashboardLoad(page);
    
    // Full page screenshot
    await expect(page).toHaveScreenshot('dashboard-full-page.png');
    
    // Component-specific screenshots
    await expect(page.locator('[data-testid="health-cards"]')).toHaveScreenshot('health-cards.png');
    await expect(page.locator('[data-testid="metrics-chart"]')).toHaveScreenshot('metrics-chart.png');
  });

  test('mobile layout matches snapshot', async ({ page }) => {
    await page.setViewportSize({ width: 375, height: 667 });
    await page.goto('/dashboard');
    await expect(page).toHaveScreenshot('dashboard-mobile.png');
  });

  test('dark theme matches snapshot', async ({ page }) => {
    await page.goto('/dashboard');
    await page.click('[data-testid="theme-toggle"]');
    await expect(page).toHaveScreenshot('dashboard-dark-theme.png');
  });

  test('responsive layouts across breakpoints', async ({ page }) => {
    const breakpoints = [
      { width: 320, height: 568 },   // iPhone SE
      { width: 375, height: 667 },   // iPhone 8
      { width: 768, height: 1024 },  // iPad
      { width: 1024, height: 768 },  // Desktop
      { width: 1920, height: 1080 }  // Large Desktop
    ];

    for (const breakpoint of breakpoints) {
      await DashboardTestHelpers.testResponsiveLayout(page, breakpoint);
    }
  });
});
```

### **Phase 3: Accessibility Testing (Day 3)**
```tsx
// tests/e2e/accessibility.spec.ts
import { test, expect } from '@playwright/test';
import { DashboardTestHelpers } from '../utils/playwright-helpers';

test.describe('Accessibility Tests', () => {
  test.beforeEach(async ({ page }) => {
    await DashboardTestHelpers.mockApiResponses(page);
  });

  test('dashboard accessibility tree matches snapshot', async ({ page }) => {
    await page.goto('/dashboard');
    await DashboardTestHelpers.waitForDashboardLoad(page);
    
    await expect(page.locator('body')).toMatchAriaSnapshot(`
      - banner:
        - heading /Health Dashboard/ [level=1]
        - button "Theme Toggle"
      - main:
        - region "Health Status"
        - region "Metrics Chart"
        - region "Event Feed"
    `);
  });

  test('dashboard accessibility compliance', async ({ page }) => {
    await page.goto('/dashboard');
    
    // Run accessibility scan
    const accessibilityScanResults = await page.accessibility.snapshot();
    
    // Test for specific violations (stable approach)
    const violationFingerprints = accessibilityScanResults.violations.map(violation => ({
      rule: violation.id,
      targets: violation.nodes.map(node => node.target),
    }));
    
    expect(violationFingerprints).toMatchSnapshot('accessibility-violations.json');
    
    // Test specific accessibility properties
    await expect(page.getByRole('heading', { name: /Health Dashboard/ })).toBeVisible();
    await expect(page.getByRole('button', { name: /Theme Toggle/ })).toBeVisible();
    await expect(page.getByRole('main')).toBeVisible();
  });

  test('keyboard navigation works correctly', async ({ page }) => {
    await page.goto('/dashboard');
    await DashboardTestHelpers.waitForDashboardLoad(page);
    
    // Test tab navigation
    await page.keyboard.press('Tab');
    await expect(page.locator(':focus')).toBeVisible();
    
    // Test Enter key activation
    await page.keyboard.press('Enter');
    // Verify expected behavior
  });
});
```

### **Phase 4: Performance Testing (Day 4)**
```tsx
// tests/e2e/performance.spec.ts
import { test, expect } from '@playwright/test';
import { DashboardTestHelpers } from '../utils/playwright-helpers';

test.describe('Performance Tests', () => {
  test('dashboard performance metrics', async ({ page }) => {
    await page.goto('/dashboard');
    
    // Collect performance metrics
    const metrics = await page.evaluate(() => {
      const navigation = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming;
      return {
        loadTime: navigation.loadEventEnd - navigation.loadEventStart,
        domContentLoaded: navigation.domContentLoadedEventEnd - navigation.domContentLoadedEventStart,
        firstPaint: performance.getEntriesByName('first-paint')[0]?.startTime,
        firstContentfulPaint: performance.getEntriesByName('first-contentful-paint')[0]?.startTime,
      };
    });
    
    // Assert performance thresholds
    expect(metrics.loadTime).toBeLessThan(3000); // 3 seconds
    expect(metrics.firstContentfulPaint).toBeLessThan(1500); // 1.5 seconds
  });

  test('WebSocket connection performance', async ({ page }) => {
    const connectionTimes: number[] = [];
    
    page.on('websocket', ws => {
      const startTime = Date.now();
      ws.on('open', () => {
        connectionTimes.push(Date.now() - startTime);
      });
    });
    
    await page.goto('/dashboard');
    await page.waitForLoadState('networkidle');
    
    expect(connectionTimes[0]).toBeLessThan(1000); // 1 second
  });

  test('chart rendering performance', async ({ page }) => {
    await page.goto('/dashboard');
    await DashboardTestHelpers.waitForDashboardLoad(page);
    
    const startTime = Date.now();
    await page.waitForSelector('[data-testid="metrics-chart"] canvas');
    const renderTime = Date.now() - startTime;
    
    expect(renderTime).toBeLessThan(2000); // 2 seconds
  });
});
```

## 🧪 **Test Scripts**

### **Package.json Scripts**
```json
{
  "scripts": {
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:headed": "playwright test --headed",
    "test:e2e:debug": "playwright test --debug",
    "test:e2e:update-snapshots": "playwright test --update-snapshots",
    "test:e2e:report": "playwright show-report"
  }
}
```

### **CI/CD Integration**
```yaml
# .github/workflows/playwright.yml
name: Playwright Tests
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 18
    - name: Install dependencies
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    - name: Run Playwright tests
      run: npx playwright test
    - uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
```

## 📋 **Acceptance Criteria Checklist**

- [ ] Playwright installed and configured
- [ ] Visual regression tests working across all browsers
- [ ] Screenshot comparisons passing
- [ ] Accessibility snapshots validated
- [ ] Performance metrics within thresholds
- [ ] WebSocket connection tests passing
- [ ] API mocking tests working
- [ ] CI/CD integration complete
- [ ] Test reports generated
- [ ] All existing tests still passing

## 🔗 **Dependencies**

- **Prerequisites**: All previous stories (1.1-1.8)
- **Blocks**: None (final story)
- **External**: @playwright/test

## ⚠️ **Implementation Notes**

1. **Test Data**: Use consistent mock data for reliable tests
2. **Screenshots**: Update snapshots when UI changes intentionally
3. **Performance**: Monitor test execution time
4. **CI/CD**: Ensure tests run reliably in CI environment

## 🚀 **Next Steps After Completion**

Once this story is complete, the entire dashboard enhancement project will be complete and ready for production deployment!


