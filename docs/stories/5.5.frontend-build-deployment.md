# Story 5.5: Frontend Build & Deployment

## Status

Ready for Development

## Story

**As a** developer,  
**I want** automated frontend build and deployment,  
**so that** I can deploy the admin interface efficiently and reliably.

## Acceptance Criteria

1. Vite build system creates optimized production bundles
2. Docker containerization packages the frontend for deployment
3. Environment-specific builds support development and production configurations
4. Build optimization minimizes bundle size and loading times
5. Automated deployment integrates with Docker Compose orchestration
6. Build artifacts are properly versioned and tagged
7. Build and deployment processes are documented and automated

## Tasks / Subtasks

- [ ] Task 1: Configure Vite build system and optimization
- [ ] Task 2: Create Docker containerization for frontend
- [ ] Task 3: Implement environment-specific build configurations
- [ ] Task 4: Add build optimization and bundle analysis
- [ ] Task 5: Integrate frontend deployment with Docker Compose
- [ ] Task 6: Implement build versioning and tagging
- [ ] Task 7: Create build and deployment documentation
- [ ] Task 8: Create comprehensive tests

## Dev Notes

### Technology Stack
- **Build Tool:** Vite for fast development and optimized builds
- **Containerization:** Docker for frontend deployment
- **Deployment:** Docker Compose integration
- **Optimization:** Bundle analysis and size optimization
- **Environment Management:** Multi-stage Docker builds
- **Performance:** Code splitting and lazy loading
- **Security:** Content Security Policy and HTTPS

### Context7 Implementation Patterns

**Vite Configuration with Environment Support:**
```typescript
// vite.config.ts
import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react';
import { resolve } from 'path';

export default defineConfig(({ command, mode }) => {
  // Load env file based on `mode` in the current working directory.
  const env = loadEnv(mode, process.cwd(), '');
  
  return {
    plugins: [react()],
    
    // Base URL for production
    base: env.VITE_BASE_URL || '/',
    
    // Development server configuration
    server: {
      host: '0.0.0.0',
      port: parseInt(env.VITE_DEV_PORT) || 3000,
      proxy: {
        '/api': {
          target: env.VITE_API_URL || 'http://localhost:8080',
          changeOrigin: true,
          secure: false,
        },
        '/ws': {
          target: env.VITE_WS_URL || 'ws://localhost:8080',
          ws: true,
          changeOrigin: true,
        },
      },
    },
    
    // Build configuration
    build: {
      outDir: 'dist',
      sourcemap: mode === 'development',
      minify: mode === 'production' ? 'esbuild' : false,
      
      // Rollup options for optimization
      rollupOptions: {
        output: {
          // Code splitting for better caching
          manualChunks: {
            vendor: ['react', 'react-dom'],
            charts: ['chart.js', 'react-chartjs-2'],
            utils: ['date-fns', 'yup'],
          },
          
          // Asset naming for cache busting
          chunkFileNames: 'assets/[name]-[hash].js',
          entryFileNames: 'assets/[name]-[hash].js',
          assetFileNames: 'assets/[name]-[hash].[ext]',
        },
      },
      
      // Bundle size limits
      chunkSizeWarningLimit: 1000,
    },
    
    // Environment variables
    define: {
      __APP_VERSION__: JSON.stringify(process.env.npm_package_version),
      __BUILD_TIME__: JSON.stringify(new Date().toISOString()),
    },
    
    // Path resolution
    resolve: {
      alias: {
        '@': resolve(__dirname, 'src'),
        '@components': resolve(__dirname, 'src/components'),
        '@services': resolve(__dirname, 'src/services'),
        '@types': resolve(__dirname, 'src/types'),
        '@utils': resolve(__dirname, 'src/utils'),
        '@hooks': resolve(__dirname, 'src/hooks'),
      },
    },
    
    // CSS configuration
    css: {
      devSourcemap: true,
      modules: {
        localsConvention: 'camelCase',
      },
    },
    
    // Preview server for production builds
    preview: {
      host: '0.0.0.0',
      port: parseInt(env.VITE_PREVIEW_PORT) || 4173,
    },
  };
});
```

**Multi-stage Dockerfile for Production:**
```dockerfile
# Multi-stage Dockerfile for React frontend
FROM node:18-alpine AS base

# Install dependencies only when needed
FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app

# Install dependencies based on the preferred package manager
COPY package.json package-lock.json* ./
RUN npm ci --only=production

# Rebuild the source code only when needed
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Build arguments for environment configuration
ARG VITE_API_URL
ARG VITE_WS_URL
ARG VITE_BASE_URL
ARG VITE_ENVIRONMENT=production

# Set environment variables for build
ENV VITE_API_URL=$VITE_API_URL
ENV VITE_WS_URL=$VITE_WS_URL
ENV VITE_BASE_URL=$VITE_BASE_URL
ENV VITE_ENVIRONMENT=$VITE_ENVIRONMENT

# Build the application
RUN npm run build

# Production image, copy all the files and run next
FROM nginx:alpine AS runner
WORKDIR /app

# Copy built application
COPY --from=builder /app/dist /usr/share/nginx/html

# Copy nginx configuration
COPY nginx.conf /etc/nginx/nginx.conf

# Copy environment configuration script
COPY docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

# Add health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:80/health || exit 1

EXPOSE 80

ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["nginx", "-g", "daemon off;"]
```

**Nginx Configuration for Production:**
```nginx
# nginx.conf
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log notice;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # Performance optimizations
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' ws: wss:;" always;

    server {
        listen 80;
        server_name _;
        root /usr/share/nginx/html;
        index index.html;

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\\n";
            add_header Content-Type text/plain;
        }

        # API proxy
        location /api/ {
            proxy_pass http://admin-api:8080/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # WebSocket proxy
        location /ws/ {
            proxy_pass http://admin-api:8080/ws/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Static assets with long cache
        location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            try_files $uri =404;
        }

        # HTML files with no cache
        location ~* \\.html$ {
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
        }

        # SPA fallback
        location / {
            try_files $uri $uri/ /index.html;
        }

        # Security: deny access to hidden files
        location ~ /\\. {
            deny all;
        }
    }
}
```

**Docker Entrypoint Script:**
```bash
#!/bin/sh
# docker-entrypoint.sh

set -e

# Function to replace environment variables in files
replace_env_vars() {
    local file="$1"
    if [ -f "$file" ]; then
        envsubst < "$file" > "$file.tmp" && mv "$file.tmp" "$file"
    fi
}

# Replace environment variables in nginx config
replace_env_vars /etc/nginx/nginx.conf

# Replace environment variables in built files
if [ -d "/usr/share/nginx/html" ]; then
    find /usr/share/nginx/html -name "*.js" -o -name "*.html" | while read file; do
        replace_env_vars "$file"
    done
fi

# Execute the main command
exec "$@"
```

**Package.json with Build Scripts:**
```json
{
  "name": "ha-ingestor-admin-web",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "build:dev": "vite build --mode development",
    "build:prod": "vite build --mode production",
    "preview": "vite preview",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
    "lint:fix": "eslint . --ext ts,tsx --fix",
    "type-check": "tsc --noEmit",
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage",
    "analyze": "vite-bundle-analyzer",
    "docker:build": "docker build -t ha-ingestor/admin-web:latest .",
    "docker:build:dev": "docker build --target builder -t ha-ingestor/admin-web:dev .",
    "docker:run": "docker run -p 3000:80 ha-ingestor/admin-web:latest",
    "docker:run:dev": "docker run -p 3000:3000 ha-ingestor/admin-web:dev"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.8.0",
    "chart.js": "^4.2.0",
    "react-chartjs-2": "^5.2.0",
    "date-fns": "^2.29.0",
    "yup": "^1.0.0"
  },
  "devDependencies": {
    "@types/react": "^18.0.0",
    "@types/react-dom": "^18.0.0",
    "@typescript-eslint/eslint-plugin": "^5.0.0",
    "@typescript-eslint/parser": "^5.0.0",
    "@vitejs/plugin-react": "^4.0.0",
    "eslint": "^8.0.0",
    "eslint-plugin-react-hooks": "^4.6.0",
    "eslint-plugin-react-refresh": "^0.3.0",
    "typescript": "^5.0.0",
    "vite": "^4.3.0",
    "vite-bundle-analyzer": "^0.7.0",
    "vitest": "^0.30.0",
    "@vitest/ui": "^0.30.0",
    "c8": "^8.0.0"
  }
}
```

**Environment Configuration Files:**
```bash
# .env.development
VITE_API_URL=http://localhost:8080
VITE_WS_URL=ws://localhost:8080
VITE_BASE_URL=/
VITE_ENVIRONMENT=development
VITE_DEV_PORT=3000
VITE_PREVIEW_PORT=4173
```

```bash
# .env.production
VITE_API_URL=http://admin-api:8080
VITE_WS_URL=ws://admin-api:8080
VITE_BASE_URL=/
VITE_ENVIRONMENT=production
```

**Docker Compose Integration:**
```yaml
# docker-compose.yml
version: '3.8'

services:
  admin-web:
    build:
      context: ./services/admin-web
      dockerfile: Dockerfile
      args:
        VITE_API_URL: http://admin-api:8080
        VITE_WS_URL: ws://admin-api:8080
        VITE_BASE_URL: /
        VITE_ENVIRONMENT: production
    ports:
      - "3000:80"
    depends_on:
      - admin-api
    networks:
      - ha-ingestor-network
    environment:
      - NGINX_HOST=admin-web
      - NGINX_PORT=80
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  ha-ingestor-network:
    driver: bridge
```

**Build Optimization Scripts:**
```bash
#!/bin/bash
# scripts/build-frontend.sh

set -e

echo "Building frontend application..."

# Clean previous builds
rm -rf dist

# Install dependencies
npm ci

# Run type checking
echo "Running type checking..."
npm run type-check

# Run linting
echo "Running linting..."
npm run lint

# Run tests
echo "Running tests..."
npm run test:coverage

# Build application
echo "Building application..."
npm run build:prod

# Analyze bundle
echo "Analyzing bundle..."
npm run analyze

echo "Frontend build completed successfully!"
```

### File Structure
```
services/admin-web/
├── Dockerfile
├── docker-entrypoint.sh
├── nginx.conf
├── docker-compose.yml
├── vite.config.ts
├── package.json
├── tsconfig.json
├── .env.development
├── .env.production
├── .eslintrc.json
├── .gitignore
├── src/
│   ├── main.tsx
│   ├── App.tsx
│   ├── components/
│   ├── services/
│   ├── types/
│   ├── hooks/
│   └── utils/
├── public/
│   ├── index.html
│   └── favicon.ico
├── scripts/
│   ├── build-frontend.sh
│   └── deploy.sh
└── docs/
    ├── DEPLOYMENT.md
    └── BUILD.md
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Initial story creation from Epic 5.5 | Scrum Master Bob |
