# Story 1.1: Project Setup & Docker Infrastructure

## Status

Draft

## Story

**As a** Home Assistant user,  
**I want** a complete Docker Compose setup with all required services configured,  
**so that** I can deploy the ingestion layer with a single command.

## Acceptance Criteria

1. Docker Compose file includes InfluxDB, ingestion service, and weather API service containers
2. All services are properly networked and can communicate with each other
3. Environment variables are configured for Home Assistant connection and API keys
4. Services start successfully and remain running without errors
5. Basic health check endpoints are available for all services
6. Logging is configured and output is visible in Docker logs
7. Services automatically restart on failure with proper restart policies

## Tasks / Subtasks

- [ ] Task 1: Create project directory structure (AC: 1, 2)
  - [ ] Create root project directory `ha-ingestor/`
  - [ ] Create `services/` directory for backend services
  - [ ] Create `infrastructure/` directory for Docker configuration
  - [ ] Create `scripts/` directory for utility scripts
  - [ ] Create `shared/` directory for shared code and types
  - [ ] Create `docs/` directory structure
  - [ ] Create `tests/` directory for integration tests

- [ ] Task 2: Set up Docker Compose orchestration (AC: 1, 2, 4, 7)
  - [ ] Create main `docker-compose.yml` file in root
  - [ ] Create development `docker-compose.dev.yml` file
  - [ ] Create production `docker-compose.prod.yml` file
  - [ ] Configure service networking with Docker networks
  - [ ] Set up service dependencies and startup order
  - [ ] Configure restart policies for all services

- [ ] Task 3: Configure InfluxDB service (AC: 1, 5)
  - [ ] Set up InfluxDB 2.7 container configuration
  - [ ] Configure InfluxDB initialization scripts
  - [ ] Set up persistent volumes for data storage
  - [ ] Configure health check endpoint for InfluxDB
  - [ ] Set up database initialization with proper organization and bucket

- [ ] Task 4: Create environment configuration system (AC: 3)
  - [ ] Create `.env.example` template file
  - [ ] Define environment variables for Home Assistant connection
  - [ ] Define environment variables for weather API keys
  - [ ] Set up environment variable validation
  - [ ] Document required environment variables

- [ ] Task 5: Set up logging and monitoring infrastructure (AC: 6)
  - [ ] Configure structured logging for all services
  - [ ] Set up log aggregation across containers
  - [ ] Configure log rotation and retention policies
  - [ ] Set up basic health check endpoints
  - [ ] Configure logging levels and formats

- [ ] Task 6: Create utility scripts (AC: 4, 7)
  - [ ] Create `scripts/setup.sh` for initial project setup
  - [ ] Create `scripts/health-check.sh` for system health monitoring
  - [ ] Create `scripts/backup.sh` for data backup
  - [ ] Create `scripts/restore.sh` for data restore
  - [ ] Make scripts executable and add proper error handling

- [ ] Task 7: Create project documentation (AC: 4)
  - [ ] Create comprehensive `README.md` with setup instructions
  - [ ] Create `docs/setup.md` with detailed setup guide
  - [ ] Create `docs/troubleshooting.md` for common issues
  - [ ] Document Docker Compose commands and usage
  - [ ] Create environment configuration guide

- [ ] Task 8: Set up basic CI/CD pipeline (AC: 4)
  - [ ] Create `.github/workflows/ci.yml` for continuous integration
  - [ ] Set up automated testing pipeline
  - [ ] Configure Docker build and test workflows
  - [ ] Set up deployment workflow template

## Dev Notes

### Technology Stack
[Source: architecture/tech-stack.md]

**Backend Technology Stack:**
- **Backend Language:** Python 3.11 for WebSocket client and data processing
- **Backend Framework:** aiohttp 3.9+ for WebSocket client + REST API
- **Database:** InfluxDB 2.7 for time-series data storage
- **File Storage:** Local Docker Volumes for persistent data storage
- **Orchestration:** Docker Compose 2.20+ for service orchestration
- **Build Tool:** Docker 24+ for containerization
- **Monitoring:** Python logging for application logging
- **CI/CD:** GitHub Actions for automated testing

### Context7 Implementation Guidance

#### Docker Compose Configuration
[Source: Context7 Knowledge Base - Docker Compose]

**Multi-Service Configuration Example:**
```yaml
services:
  influxdb:
    image: influxdb:2.7
    container_name: ha-ingestor-influxdb
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=password123
      - DOCKER_INFLUXDB_INIT_ORG=home_assistant
      - DOCKER_INFLUXDB_INIT_BUCKET=events
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=my-super-secret-auth-token
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
    networks:
      - ha-ingestor-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  websocket-ingestion:
    build: 
      context: ./services/websocket-ingestion
      dockerfile: Dockerfile
    container_name: ha-ingestor-websocket
    environment:
      - HA_URL=${HA_URL}
      - HA_ACCESS_TOKEN=${HA_ACCESS_TOKEN}
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN}
      - INFLUXDB_ORG=home_assistant
      - INFLUXDB_BUCKET=events
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      influxdb:
        condition: service_healthy
    networks:
      - ha-ingestor-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  influxdb_data:
    driver: local
  influxdb_config:
    driver: local

networks:
  ha-ingestor-network:
    driver: bridge
```

**Development Override Configuration:**
```yaml
# docker-compose.dev.yml
services:
  websocket-ingestion:
    volumes:
      - ./services/websocket-ingestion:/app
    environment:
      - LOG_LEVEL=DEBUG
      - PYTHONPATH=/app
    command: python -m uvicorn src.main:app --host 0.0.0.0 --port 8080 --reload
```

**Production Configuration:**
```yaml
# docker-compose.prod.yml
services:
  influxdb:
    environment:
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_ADMIN_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_ADMIN_TOKEN}
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  websocket-ingestion:
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
```

#### Docker Compose Commands Reference
[Source: Context7 Knowledge Base - Docker Compose]

**Essential Commands:**
```bash
# Start all services
docker compose up -d

# Start with specific compose files
docker compose -f docker-compose.yml -f docker-compose.dev.yml up

# View service status
docker compose ps

# View logs
docker compose logs -f websocket-ingestion

# Execute commands in running containers
docker compose exec websocket-ingestion python -m pytest

# Health check all services
docker compose ps --filter health=healthy

# Stop and remove containers
docker compose down

# Remove volumes (careful - deletes data!)
docker compose down -v
```

#### InfluxDB Setup with Docker Compose
[Source: Context7 Knowledge Base - InfluxDB]

**InfluxDB Initialization Script:**
```bash
#!/bin/bash
# scripts/init-influxdb.sh

# Wait for InfluxDB to be ready
until curl -f http://localhost:8086/health; do
  echo "Waiting for InfluxDB..."
  sleep 5
done

# Create additional buckets if needed
influx bucket create \
  --name "home_assistant_raw" \
  --org "home_assistant" \
  --retention 30d

influx bucket create \
  --name "home_assistant_processed" \
  --org "home_assistant" \
  --retention 90d
```

**Environment Variables Template:**
```bash
# .env.example
# Home Assistant Configuration
HA_URL=ws://homeassistant.local:8123/api/websocket
HA_ACCESS_TOKEN=your_long_lived_access_token_here

# InfluxDB Configuration
INFLUXDB_URL=http://localhost:8086
INFLUXDB_TOKEN=my-super-secret-auth-token
INFLUXDB_ORG=home_assistant
INFLUXDB_BUCKET=events
INFLUXDB_ADMIN_PASSWORD=secure_password_here
INFLUXDB_ADMIN_TOKEN=admin_token_here

# Logging Configuration
LOG_LEVEL=INFO
LOG_FORMAT=json

# Environment
ENVIRONMENT=development
```

#### Health Check Implementation
[Source: Context7 Knowledge Base - Docker Compose]

**Service Health Check Script:**
```bash
#!/bin/bash
# scripts/health-check.sh

echo "=== HA Ingestor Health Check ==="
echo "Timestamp: $(date)"

# Check InfluxDB
echo -n "InfluxDB: "
if curl -f http://localhost:8086/health > /dev/null 2>&1; then
    echo "✅ Healthy"
else
    echo "❌ Unhealthy"
fi

# Check WebSocket Ingestion Service
echo -n "WebSocket Service: "
if curl -f http://localhost:8080/health > /dev/null 2>&1; then
    echo "✅ Healthy"
else
    echo "❌ Unhealthy"
fi

# Check Docker containers
echo -n "Docker Containers: "
if docker compose ps --filter status=running | grep -q "Up"; then
    echo "✅ Running"
else
    echo "❌ Some containers not running"
fi

echo "=== Health Check Complete ==="
```

#### Backup and Restore Scripts
[Source: Context7 Knowledge Base - Docker Compose]

**Data Backup Script:**
```bash
#!/bin/bash
# scripts/backup.sh

BACKUP_DIR="./backups"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="ha-ingestor-backup-${TIMESTAMP}.tar.gz"

echo "Creating backup: ${BACKUP_FILE}"

# Create backup directory
mkdir -p ${BACKUP_DIR}

# Backup InfluxDB data
docker compose exec influxdb influx backup /tmp/backup
docker cp $(docker compose ps -q influxdb):/tmp/backup ${BACKUP_DIR}/influxdb-${TIMESTAMP}

# Backup configuration files
tar -czf ${BACKUP_DIR}/${BACKUP_FILE} \
  docker-compose.yml \
  docker-compose.*.yml \
  .env \
  services/

echo "Backup completed: ${BACKUP_DIR}/${BACKUP_FILE}"
```

**Data Restore Script:**
```bash
#!/bin/bash
# scripts/restore.sh

if [ -z "$1" ]; then
    echo "Usage: $0 <backup-file>"
    exit 1
fi

BACKUP_FILE=$1

if [ ! -f "$BACKUP_FILE" ]; then
    echo "Backup file not found: $BACKUP_FILE"
    exit 1
fi

echo "Restoring from backup: $BACKUP_FILE"

# Stop services
docker compose down

# Extract backup
tar -xzf $BACKUP_FILE

# Restore InfluxDB data
docker compose up -d influxdb
sleep 10
docker compose exec influxdb influx restore /tmp/backup

# Start all services
docker compose up -d

echo "Restore completed"
```

### Project Structure
[Source: architecture/unified-project-structure.md]

**Required Directory Structure:**
```
ha-ingestor/
├── services/                          # Backend services
│   ├── websocket-ingestion/           # WebSocket client service
│   ├── enrichment-pipeline/           # Data enrichment service
│   └── admin-api/                     # Admin REST API
├── infrastructure/                    # Deployment configuration
│   ├── docker-compose.yml             # Main orchestration
│   ├── docker-compose.dev.yml         # Development environment
│   ├── docker-compose.prod.yml        # Production environment
│   ├── .env.example                   # Environment template
│   └── influxdb/
│       ├── init-scripts/
│       └── config/
├── shared/                            # Shared code and types
│   ├── types/                         # Event data types
│   ├── utils/                         # Shared utilities
│   └── constants/                     # Database schemas
├── scripts/                           # Utility scripts
│   ├── setup.sh                       # Initial setup script
│   ├── backup.sh                      # Data backup script
│   ├── restore.sh                     # Data restore script
│   └── health-check.sh                # System health check
├── docs/                              # Documentation
├── tests/                             # Integration tests
└── .github/                           # CI/CD workflows
    └── workflows/
```

### Docker Configuration Requirements
[Source: architecture/deployment-architecture.md]

**Docker Compose Requirements:**
- **Platform:** Docker containers orchestrated by Docker Compose
- **Build Command:** Docker multi-stage builds
- **Deployment Method:** Docker Compose with health checks and restart policies
- **Frontend URL:** http://localhost:3000 (development)
- **Backend URL:** http://localhost:8080 (development)

### InfluxDB Configuration
[Source: architecture/high-level-architecture.md]

**InfluxDB Setup Requirements:**
- **Version:** InfluxDB 2.7
- **Storage:** Local persistent volumes for data storage
- **Initialization:** Database setup with proper organization and bucket
- **Configuration:** Local Docker deployment with persistent volumes

### Environment Variables
[Source: architecture/high-level-architecture.md]

**Required Environment Variables:**
- Home Assistant WebSocket URL
- Home Assistant access token
- Weather API key
- InfluxDB configuration
- Admin API configuration
- Logging configuration

### Testing
[Source: architecture/testing-strategy.md]

**Testing Requirements:**
- **Backend Testing:** pytest 7.4+ for backend service testing
- **Test Organization:** Tests in `services/*/tests/` directories
- **Integration Testing:** E2E tests in `tests/` directory
- **CI/CD Testing:** Automated testing via GitHub Actions

**Test File Structure:**
```
services/*/tests/
├── test_websocket_client.py
├── test_event_processor.py
├── test_weather_service.py
├── test_influxdb_client.py
└── test_api_endpoints.py

tests/
├── test_integration.py
├── test_data_flow.py
└── fixtures/
    └── sample_events.json
```

### Coding Standards
[Source: architecture/coding-standards.md]

**Critical Rules:**
- **Environment Variables:** Access only through config objects, never `process.env` directly
- **Error Handling:** All API routes must use the standard error handler
- **Naming Conventions:** 
  - Database Tables: snake_case (e.g., `home_assistant_events`)
  - Functions: snake_case for backend (e.g., `get_health_status()`)
  - API Routes: kebab-case (e.g., `/api/health-status`)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Initial story creation from Epic 1.1 | Scrum Master Bob |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes List

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be populated here*
