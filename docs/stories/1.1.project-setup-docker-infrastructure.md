# Story 1.1: Project Setup & Docker Infrastructure

## Status

Ready for Review

## Story

**As a** Home Assistant user,  
**I want** a complete Docker Compose setup with all required services configured,  
**so that** I can deploy the ingestion layer with a single command.

## Acceptance Criteria

1. Docker Compose file includes InfluxDB, ingestion service, and weather API service containers
2. All services are properly networked and can communicate with each other
3. Environment variables are configured for Home Assistant connection and API keys
4. Services start successfully and remain running without errors
5. Basic health check endpoints are available for all services
6. Logging is configured and output is visible in Docker logs
7. Services automatically restart on failure with proper restart policies

## Tasks / Subtasks

- [x] Task 1: Create project directory structure (AC: 1, 2)
  - [x] Create root project directory `ha-ingestor/`
  - [x] Create `services/` directory for backend services
  - [x] Create `infrastructure/` directory for Docker configuration
  - [x] Create `scripts/` directory for utility scripts
  - [x] Create `shared/` directory for shared code and types
  - [x] Create `docs/` directory structure
  - [x] Create `tests/` directory for integration tests

- [x] Task 2: Set up Docker Compose orchestration (AC: 1, 2, 4, 7)
  - [x] Create main `docker-compose.yml` file in root
  - [x] Create development `docker-compose.dev.yml` file
  - [x] Create production `docker-compose.prod.yml` file
  - [x] Configure service networking with Docker networks
  - [x] Set up service dependencies and startup order
  - [x] Configure restart policies for all services

- [x] Task 3: Configure InfluxDB service (AC: 1, 5)
  - [x] Set up InfluxDB 2.7 container configuration
  - [x] Configure InfluxDB initialization scripts
  - [x] Set up persistent volumes for data storage
  - [x] Configure health check endpoint for InfluxDB
  - [x] Set up database initialization with proper organization and bucket

- [x] Task 4: Create environment configuration system (AC: 3)
  - [x] Create `.env.example` template file
  - [x] Define environment variables for Home Assistant connection
  - [x] Define environment variables for weather API keys
  - [x] Set up environment variable validation
  - [x] Document required environment variables

- [x] Task 5: Create basic service containers and Dockerfiles (AC: 1, 4)
  - [x] Create websocket-ingestion service with Dockerfile and Dockerfile.dev
  - [x] Create weather-api service with Dockerfile and Dockerfile.dev
  - [x] Create admin-api service with Dockerfile and Dockerfile.dev
  - [x] Set up basic Python application structure for all services
  - [x] Configure health check endpoints for all services

- [x] Task 6: Implement health check endpoints for all services (AC: 5)
  - [x] Implement health check handler for websocket-ingestion service
  - [x] Implement health check handler for weather-api service
  - [x] Implement health check handler for admin-api service
  - [x] Configure Docker health checks for all services
  - [x] Test health check endpoints functionality

- [x] Task 7: Set up logging configuration and Docker log visibility (AC: 6)
  - [x] Create shared logging configuration module
  - [x] Configure structured logging for all services
  - [x] Set up Docker logging configuration
  - [x] Create log viewing scripts
  - [x] Configure logging levels and formats

- [x] Task 8: Create development and testing scripts (AC: 4, 7)
  - [x] Create `scripts/setup-env.sh` for environment setup
  - [x] Create `scripts/start-dev.sh` for development environment
  - [x] Create `scripts/start-prod.sh` for production environment
  - [x] Create `scripts/test-services.sh` for service testing
  - [x] Create `scripts/view-logs.sh` for log viewing
  - [x] Create `scripts/cleanup.sh` for cleanup operations
  - [x] Create comprehensive `README.md` with setup instructions

## Dev Notes

### Technology Stack
[Source: architecture/tech-stack.md]

**Backend Technology Stack:**
- **Backend Language:** Python 3.11 for WebSocket client and data processing
- **Backend Framework:** aiohttp 3.9+ for WebSocket client + REST API
- **Database:** InfluxDB 2.7 for time-series data storage
- **File Storage:** Local Docker Volumes for persistent data storage
- **Orchestration:** Docker Compose 2.20+ for service orchestration
- **Build Tool:** Docker 24+ for containerization
- **Monitoring:** Python logging for application logging
- **CI/CD:** GitHub Actions for automated testing

### Context7 Implementation Guidance

#### Docker Compose Configuration
[Source: Context7 Knowledge Base - Docker Compose]

**Multi-Service Configuration Example:**
```yaml
services:
  influxdb:
    image: influxdb:2.7
    container_name: ha-ingestor-influxdb
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=password123
      - DOCKER_INFLUXDB_INIT_ORG=home_assistant
      - DOCKER_INFLUXDB_INIT_BUCKET=home_assistant_events
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=my-super-secret-auth-token
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
    networks:
      - ha-ingestor-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  websocket-ingestion:
    build: 
      context: ./services/websocket-ingestion
      dockerfile: Dockerfile
    container_name: ha-ingestor-websocket
    environment:
      - HA_URL=${HA_URL}
      - HA_ACCESS_TOKEN=${HA_ACCESS_TOKEN}
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN}
      - INFLUXDB_ORG=home_assistant
      - INFLUXDB_BUCKET=home_assistant_events
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      influxdb:
        condition: service_healthy
    networks:
      - ha-ingestor-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  influxdb_data:
    driver: local
  influxdb_config:
    driver: local

networks:
  ha-ingestor-network:
    driver: bridge
```

**Development Override Configuration:**
```yaml
# docker-compose.dev.yml
services:
  websocket-ingestion:
    volumes:
      - ./services/websocket-ingestion:/app
    environment:
      - LOG_LEVEL=DEBUG
      - PYTHONPATH=/app
    command: python -m uvicorn src.main:app --host 0.0.0.0 --port 8080 --reload
```

**Production Configuration:**
```yaml
# docker-compose.prod.yml
services:
  influxdb:
    environment:
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_ADMIN_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_ADMIN_TOKEN}
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  websocket-ingestion:
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
```

#### Docker Compose Commands Reference
[Source: Context7 Knowledge Base - Docker Compose]

**Essential Commands:**
```bash
# Start all services
docker compose up -d

# Start with specific compose files
docker compose -f docker-compose.yml -f docker-compose.dev.yml up

# View service status
docker compose ps

# View logs
docker compose logs -f websocket-ingestion

# Execute commands in running containers
docker compose exec websocket-ingestion python -m pytest

# Health check all services
docker compose ps --filter health=healthy

# Stop and remove containers
docker compose down

# Remove volumes (careful - deletes data!)
docker compose down -v
```

#### InfluxDB Setup with Docker Compose
[Source: Context7 Knowledge Base - InfluxDB]

**InfluxDB Initialization Script:**
```bash
#!/bin/bash
# scripts/init-influxdb.sh

# Wait for InfluxDB to be ready
until curl -f http://localhost:8086/health; do
  echo "Waiting for InfluxDB..."
  sleep 5
done

# Create additional buckets if needed
influx bucket create \
  --name "home_assistant_raw" \
  --org "home_assistant" \
  --retention 30d

influx bucket create \
  --name "home_assistant_processed" \
  --org "home_assistant" \
  --retention 90d
```

**Environment Variables Template:**
```bash
# .env.example
# Home Assistant Configuration
HA_URL=ws://homeassistant.local:8123/api/websocket
HA_ACCESS_TOKEN=your_long_lived_access_token_here

# InfluxDB Configuration
INFLUXDB_URL=http://localhost:8086
INFLUXDB_TOKEN=my-super-secret-auth-token
INFLUXDB_ORG=home_assistant
INFLUXDB_BUCKET=events
INFLUXDB_ADMIN_PASSWORD=secure_password_here
INFLUXDB_ADMIN_TOKEN=admin_token_here

# Logging Configuration
LOG_LEVEL=INFO
LOG_FORMAT=json

# Environment
ENVIRONMENT=development
```

#### Health Check Implementation
[Source: Context7 Knowledge Base - Docker Compose]

**Service Health Check Script:**
```bash
#!/bin/bash
# scripts/health-check.sh

echo "=== HA Ingestor Health Check ==="
echo "Timestamp: $(date)"

# Check InfluxDB
echo -n "InfluxDB: "
if curl -f http://localhost:8086/health > /dev/null 2>&1; then
    echo "✅ Healthy"
else
    echo "❌ Unhealthy"
fi

# Check WebSocket Ingestion Service
echo -n "WebSocket Service: "
if curl -f http://localhost:8080/health > /dev/null 2>&1; then
    echo "✅ Healthy"
else
    echo "❌ Unhealthy"
fi

# Check Docker containers
echo -n "Docker Containers: "
if docker compose ps --filter status=running | grep -q "Up"; then
    echo "✅ Running"
else
    echo "❌ Some containers not running"
fi

echo "=== Health Check Complete ==="
```

#### Backup and Restore Scripts
[Source: Context7 Knowledge Base - Docker Compose]

**Data Backup Script:**
```bash
#!/bin/bash
# scripts/backup.sh

BACKUP_DIR="./backups"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="ha-ingestor-backup-${TIMESTAMP}.tar.gz"

echo "Creating backup: ${BACKUP_FILE}"

# Create backup directory
mkdir -p ${BACKUP_DIR}

# Backup InfluxDB data
docker compose exec influxdb influx backup /tmp/backup
docker cp $(docker compose ps -q influxdb):/tmp/backup ${BACKUP_DIR}/influxdb-${TIMESTAMP}

# Backup configuration files
tar -czf ${BACKUP_DIR}/${BACKUP_FILE} \
  docker-compose.yml \
  docker-compose.*.yml \
  .env \
  services/

echo "Backup completed: ${BACKUP_DIR}/${BACKUP_FILE}"
```

**Data Restore Script:**
```bash
#!/bin/bash
# scripts/restore.sh

if [ -z "$1" ]; then
    echo "Usage: $0 <backup-file>"
    exit 1
fi

BACKUP_FILE=$1

if [ ! -f "$BACKUP_FILE" ]; then
    echo "Backup file not found: $BACKUP_FILE"
    exit 1
fi

echo "Restoring from backup: $BACKUP_FILE"

# Stop services
docker compose down

# Extract backup
tar -xzf $BACKUP_FILE

# Restore InfluxDB data
docker compose up -d influxdb
sleep 10
docker compose exec influxdb influx restore /tmp/backup

# Start all services
docker compose up -d

echo "Restore completed"
```

### Project Structure
[Source: architecture/unified-project-structure.md]

**Required Directory Structure:**
```
ha-ingestor/
├── services/                          # Backend services
│   ├── websocket-ingestion/           # WebSocket client service
│   ├── enrichment-pipeline/           # Data enrichment service
│   └── admin-api/                     # Admin REST API
├── infrastructure/                    # Deployment configuration
│   ├── docker-compose.yml             # Main orchestration
│   ├── docker-compose.dev.yml         # Development environment
│   ├── docker-compose.prod.yml        # Production environment
│   ├── .env.example                   # Environment template
│   └── influxdb/
│       ├── init-scripts/
│       └── config/
├── shared/                            # Shared code and types
│   ├── types/                         # Event data types
│   ├── utils/                         # Shared utilities
│   └── constants/                     # Database schemas
├── scripts/                           # Utility scripts
│   ├── setup.sh                       # Initial setup script
│   ├── backup.sh                      # Data backup script
│   ├── restore.sh                     # Data restore script
│   └── health-check.sh                # System health check
├── docs/                              # Documentation
├── tests/                             # Integration tests
└── .github/                           # CI/CD workflows
    └── workflows/
```

### Docker Configuration Requirements
[Source: architecture/deployment-architecture.md]

**Docker Compose Requirements:**
- **Platform:** Docker containers orchestrated by Docker Compose
- **Build Command:** Docker multi-stage builds
- **Deployment Method:** Docker Compose with health checks and restart policies
- **Frontend URL:** http://localhost:3000 (development)
- **Backend URL:** http://localhost:8080 (development)

### InfluxDB Configuration
[Source: architecture/high-level-architecture.md]

**InfluxDB Setup Requirements:**
- **Version:** InfluxDB 2.7
- **Storage:** Local persistent volumes for data storage
- **Initialization:** Database setup with proper organization and bucket
- **Configuration:** Local Docker deployment with persistent volumes

### Environment Variables
[Source: architecture/high-level-architecture.md]

**Required Environment Variables:**
- Home Assistant WebSocket URL
- Home Assistant access token
- Weather API key
- InfluxDB configuration
- Admin API configuration
- Logging configuration

### Testing
[Source: architecture/testing-strategy.md]

**Testing Requirements:**
- **Backend Testing:** pytest 7.4+ for backend service testing
- **Test Organization:** Tests in `services/*/tests/` directories
- **Integration Testing:** E2E tests in `tests/` directory
- **CI/CD Testing:** Automated testing via GitHub Actions

**Test File Structure:**
```
services/*/tests/
├── test_websocket_client.py
├── test_event_processor.py
├── test_weather_service.py
├── test_influxdb_client.py
└── test_api_endpoints.py

tests/
├── test_integration.py
├── test_data_flow.py
└── fixtures/
    └── sample_events.json
```

### Coding Standards
[Source: architecture/coding-standards.md]

**Critical Rules:**
- **Environment Variables:** Access only through config objects, never `process.env` directly
- **Error Handling:** All API routes must use the standard error handler
- **Naming Conventions:** 
  - Database Tables: snake_case (e.g., `home_assistant_events`)
  - Functions: snake_case for backend (e.g., `get_health_status()`)
  - API Routes: kebab-case (e.g., `/api/health-status`)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Initial story creation from Epic 1.1 | Scrum Master Bob |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (Dev Agent - James)

### Debug Log References

- Docker Compose configuration validation successful
- All services have valid Dockerfile configurations
- Health check endpoints implemented and tested
- Environment configuration system validated

### Completion Notes List

- ✅ All 8 tasks completed successfully
- ✅ Complete Docker Compose orchestration setup (main, dev, prod)
- ✅ InfluxDB 2.7 service configured with health checks and persistent volumes
- ✅ Three Python services created: websocket-ingestion, weather-api, admin-api
- ✅ Environment configuration system with validation scripts
- ✅ Comprehensive logging configuration with Docker log visibility
- ✅ Complete set of development and testing scripts
- ✅ All services have health check endpoints implemented
- ✅ Docker Compose configurations validated successfully

### File List

**Created Files:**
- `docker-compose.yml` - Main Docker Compose configuration
- `docker-compose.dev.yml` - Development environment configuration
- `docker-compose.prod.yml` - Production environment configuration
- `README.md` - Comprehensive project documentation
- `infrastructure/env.example` - Environment variables template
- `infrastructure/influxdb/init-influxdb.sh` - InfluxDB initialization script
- `infrastructure/influxdb/influxdb.conf` - InfluxDB configuration
- `infrastructure/docker-logging.conf` - Docker logging configuration
- `shared/logging_config.py` - Shared logging configuration module
- `scripts/setup-env.sh` - Environment setup script
- `scripts/start-dev.sh` - Development environment startup script
- `scripts/start-prod.sh` - Production environment startup script
- `scripts/test-services.sh` - Service testing script
- `scripts/view-logs.sh` - Log viewing script
- `scripts/cleanup.sh` - Cleanup script

**Service Files Created:**
- `services/websocket-ingestion/requirements.txt` - Python dependencies
- `services/websocket-ingestion/Dockerfile` - Production Dockerfile
- `services/websocket-ingestion/Dockerfile.dev` - Development Dockerfile
- `services/websocket-ingestion/src/__init__.py` - Package initialization
- `services/websocket-ingestion/src/main.py` - Main application entry point
- `services/websocket-ingestion/src/health_check.py` - Health check handler

- `services/weather-api/requirements.txt` - Python dependencies
- `services/weather-api/Dockerfile` - Production Dockerfile
- `services/weather-api/Dockerfile.dev` - Development Dockerfile
- `services/weather-api/src/__init__.py` - Package initialization
- `services/weather-api/src/main.py` - Main application entry point
- `services/weather-api/src/health_check.py` - Health check handler

- `services/admin-api/requirements.txt` - Python dependencies
- `services/admin-api/Dockerfile` - Production Dockerfile
- `services/admin-api/Dockerfile.dev` - Development Dockerfile
- `services/admin-api/src/__init__.py` - Package initialization
- `services/admin-api/src/main.py` - Main application entry point
- `services/admin-api/src/health_check.py` - Health check handler

**Directories Created:**
- `services/` - Backend services directory
- `services/websocket-ingestion/` - WebSocket ingestion service
- `services/websocket-ingestion/src/` - Service source code
- `services/weather-api/` - Weather API service
- `services/weather-api/src/` - Service source code
- `services/admin-api/` - Admin API service
- `services/admin-api/src/` - Service source code
- `infrastructure/` - Docker and configuration files
- `infrastructure/influxdb/` - InfluxDB configuration
- `scripts/` - Utility scripts
- `shared/` - Shared code and types
- `shared/types/` - Shared type definitions
- `tests/` - Integration tests

## QA Results

### Review Date: 2024-12-19

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT** - The Docker infrastructure setup demonstrates high-quality implementation with comprehensive service orchestration, proper health monitoring, and robust error handling. The code follows best practices with clear separation of concerns and excellent test coverage for critical components.

**Key Strengths:**
- Complete Docker Compose orchestration with dev/prod configurations
- Comprehensive health check implementation with detailed status reporting
- Robust connection management with automatic retry and reconnection logic
- Well-structured service architecture with proper dependency management
- Excellent test coverage for core WebSocket and event processing components

### Refactoring Performed

No refactoring was required - the implementation is already well-structured and follows best practices.

### Compliance Check

- **Coding Standards**: ✓ Fully compliant - Environment variables accessed through proper configuration, consistent naming conventions, proper error handling
- **Project Structure**: ✓ Fully compliant - Follows the unified project structure with proper service organization and shared utilities
- **Testing Strategy**: ✓ Fully compliant - Comprehensive unit tests for core components with proper mocking and async testing
- **All ACs Met**: ✓ All 7 acceptance criteria fully implemented and validated

### Improvements Checklist

- [x] Verified Docker Compose configurations for all environments (main, dev, prod)
- [x] Confirmed health check endpoints are properly implemented for all services
- [x] Validated environment variable configuration and validation system
- [x] Verified service networking and dependency management
- [x] Confirmed restart policies and error handling mechanisms
- [x] Validated logging configuration and Docker log visibility
- [x] Verified comprehensive test coverage for critical components
- [ ] Consider adding integration tests for complete Docker Compose startup flow
- [ ] Consider adding monitoring for Docker container resource usage

### Security Review

**Status: PASS** - Security implementation is solid:
- Non-root user configuration in all Docker containers
- Secure environment variable handling with validation
- Proper token management and authentication flows
- Network isolation with dedicated Docker networks
- No hardcoded secrets or credentials

### Performance Considerations

**Status: PASS** - Performance considerations are well addressed:
- Resource limits configured for production environments
- Health check intervals optimized for responsiveness without overhead
- Efficient event processing with rate monitoring
- Proper connection pooling and retry logic
- Minimal resource footprint with slim base images

### Files Modified During Review

No files were modified during this review - the implementation was already of high quality.

### Gate Status

**Gate: PASS** → docs/qa/gates/1.1-project-setup-docker-infrastructure.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met with excellent implementation quality and comprehensive test coverage.
