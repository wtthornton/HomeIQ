# Story 16.2: Add Basic Test Coverage for Critical User Workflows

## Status
Draft

## Story

**As a** developer maintaining the HA Ingestor dashboard,  
**I want** basic test coverage for critical user workflows,  
**so that** I can catch regressions when making changes to the dashboard.

## Context
Currently, the frontend has:
- Only 2 hook tests (useTeamPreferences, apiUsageCalculator)
- Only 4 component tests (ServiceDependencyGraph, ServiceDetailsModal, etc.)
- No tests for main Dashboard or critical hooks (useHealth, useStatistics)

**Goal:** Add 5-10 focused tests for main workflows. This is a personal project - we don't need 80% coverage or comprehensive tests. Just enough to catch breaking changes.

## Acceptance Criteria

1. **Dashboard Component Tests**
   - Dashboard renders without crashing
   - Tab navigation switches between tabs correctly
   - Error state displays user-friendly message

2. **Critical Hook Tests**
   - useHealth hook fetches and returns health data
   - useStatistics hook fetches and returns statistics data
   - useHealth hook handles API errors gracefully

3. **User Workflow Tests**
   - Dark mode toggle works
   - Loading state displays while fetching data
   - Empty state displays when no data available

4. **Test Infrastructure**
   - Tests run with `npm test` command
   - All tests pass in clean state
   - Tests use proper mocking for API calls

5. **Documentation**
   - README includes how to run tests
   - Tests have clear descriptions

## Tasks / Subtasks

- [ ] **Task 1: Set up test infrastructure** (AC: 4)
  - [ ] Verify Vitest configuration is correct
  - [ ] Add MSW (Mock Service Worker) for API mocking
  - [ ] Create test utilities file for common setup
  - [ ] Document test commands in README

- [ ] **Task 2: Add Dashboard component tests** (AC: 1)
  - [ ] Test: Dashboard renders without errors
  - [ ] Test: Tab navigation works (click tab, content changes)
  - [ ] Test: Error boundary catches errors
  - [ ] Test: Error state shows user-friendly message

- [ ] **Task 3: Add useHealth hook tests** (AC: 2)
  - [ ] Test: Hook fetches health data successfully
  - [ ] Test: Hook handles loading state
  - [ ] Test: Hook handles API error gracefully
  - [ ] Test: Hook handles network error

- [ ] **Task 4: Add useStatistics hook tests** (AC: 2)
  - [ ] Test: Hook fetches statistics data successfully
  - [ ] Test: Hook handles loading state
  - [ ] Test: Hook handles API error

- [ ] **Task 5: Add user interaction tests** (AC: 3)
  - [ ] Test: Dark mode toggle switches theme
  - [ ] Test: Loading skeleton displays while loading
  - [ ] Test: Auto-refresh toggle works

- [ ] **Task 6: Documentation and CI integration** (AC: 5)
  - [ ] Update README with test instructions
  - [ ] Verify all tests pass
  - [ ] Add test command to package.json scripts

## Dev Notes

### Source Tree Context
```
services/health-dashboard/
├── src/
│   ├── __tests__/              # Existing tests
│   │   ├── useTeamPreferences.test.ts
│   │   └── apiUsageCalculator.test.ts
│   ├── components/
│   │   └── __tests__/          # NEW - component tests
│   │       ├── Dashboard.test.tsx
│   │       └── tabs/
│   │           └── OverviewTab.test.tsx
│   └── hooks/
│       └── __tests__/          # NEW - hook tests
│           ├── useHealth.test.ts
│           └── useStatistics.test.ts
├── tests/
│   └── setup.ts               # Test setup file
└── vitest.config.ts           # Vitest configuration
```

### Tech Stack
- **Testing Framework:** Vitest 3.2.4
- **Testing Library:** @testing-library/react 16.3.0
- **Environment:** happy-dom 20.0.0
- **Mocking:** MSW (Mock Service Worker) for API mocking

### Coding Standards
- **Test File Location:** Co-locate tests with source in `__tests__` folders
- **Naming:** `*.test.ts` or `*.test.tsx`
- **Structure:** Arrange-Act-Assert pattern
- **Mocking:** Use MSW for API mocking, not manual fetch mocks

### Implementation Examples

**Dashboard Component Test:**
```typescript
// src/components/__tests__/Dashboard.test.tsx
import { describe, it, expect } from 'vitest';
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { Dashboard } from '../Dashboard';

describe('Dashboard', () => {
  it('should render without crashing', async () => {
    render(<Dashboard />);
    expect(await screen.findByText(/HA Ingestor Dashboard/i)).toBeInTheDocument();
  });

  it('should switch tabs when navigation clicked', async () => {
    const user = userEvent.setup();
    render(<Dashboard />);
    
    // Click Services tab
    const servicesTab = screen.getByRole('button', { name: /Services/i });
    await user.click(servicesTab);
    
    // Verify services content is shown
    expect(await screen.findByText(/Service Status/i)).toBeInTheDocument();
  });

  it('should display error message on API failure', async () => {
    // Mock API to return error
    server.use(
      http.get('/api/v1/health', () => {
        return new HttpResponse(null, { status: 500 });
      })
    );
    
    render(<Dashboard />);
    
    expect(await screen.findByText(/Dashboard Error/i)).toBeInTheDocument();
    expect(screen.getByText(/Unable to connect/i)).toBeInTheDocument();
  });
});
```

**useHealth Hook Test:**
```typescript
// src/hooks/__tests__/useHealth.test.ts
import { describe, it, expect, beforeEach } from 'vitest';
import { renderHook, waitFor } from '@testing-library/react';
import { useHealth } from '../useHealth';
import { server } from '../../tests/mocks/server';
import { http, HttpResponse } from 'msw';

describe('useHealth', () => {
  it('should fetch health data successfully', async () => {
    const { result } = renderHook(() => useHealth());
    
    // Initially loading
    expect(result.current.loading).toBe(true);
    expect(result.current.health).toBeNull();
    
    // Wait for data
    await waitFor(() => {
      expect(result.current.loading).toBe(false);
    });
    
    expect(result.current.health).toBeDefined();
    expect(result.current.health?.overall_status).toBe('healthy');
    expect(result.current.error).toBeNull();
  });

  it('should handle API error gracefully', async () => {
    // Mock API to fail
    server.use(
      http.get('/api/v1/health', () => {
        return new HttpResponse(null, { status: 500 });
      })
    );
    
    const { result } = renderHook(() => useHealth());
    
    await waitFor(() => {
      expect(result.current.loading).toBe(false);
    });
    
    expect(result.current.health).toBeNull();
    expect(result.current.error).toBeDefined();
  });

  it('should handle network error', async () => {
    // Mock network failure
    server.use(
      http.get('/api/v1/health', () => {
        return HttpResponse.error();
      })
    );
    
    const { result } = renderHook(() => useHealth());
    
    await waitFor(() => {
      expect(result.current.loading).toBe(false);
    });
    
    expect(result.current.error).toContain('network');
  });
});
```

**MSW Setup (for API mocking):**
```typescript
// src/tests/mocks/handlers.ts
import { http, HttpResponse } from 'msw';

export const handlers = [
  http.get('/api/v1/health', () => {
    return HttpResponse.json({
      overall_status: 'healthy',
      timestamp: new Date().toISOString(),
      services: {
        websocket: { status: 'healthy' },
        enrichment: { status: 'healthy' },
        influxdb: { status: 'healthy' }
      }
    });
  }),
  
  http.get('/api/v1/statistics', () => {
    return HttpResponse.json({
      total_events: 12345,
      events_per_minute: 42,
      error_rate: 0.5
    });
  }),
];

// src/tests/mocks/server.ts
import { setupServer } from 'msw/node';
import { handlers } from './handlers';

export const server = setupServer(...handlers);

// src/tests/setup.ts
import { beforeAll, afterEach, afterAll } from 'vitest';
import { server } from './mocks/server';

beforeAll(() => server.listen({ onUnhandledRequest: 'error' }));
afterEach(() => server.resetHandlers());
afterAll(() => server.close());
```

### Testing Standards

**Framework:** Vitest with React Testing Library

**Test Categories:**
1. **Component Tests** - Render and interaction tests
2. **Hook Tests** - Data fetching and state management
3. **Integration Tests** - User workflows (e.g., navigation)

**Don't Test:**
- Every component (focus on Dashboard and main workflows)
- Every edge case (just main happy path + error states)
- Styling or CSS (visual regression is overkill for personal project)

**Test Structure:**
```typescript
describe('ComponentName', () => {
  it('should do specific thing', async () => {
    // Arrange - set up test
    // Act - perform action
    // Assert - verify result
  });
});
```

**Mocking Strategy:**
- Use MSW for API mocking (realistic HTTP mocking)
- Don't mock React hooks (test real behavior)
- Mock external dependencies (WebSocket, etc.)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-12 | 1.0 | Created story for basic test coverage | BMad Master |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

