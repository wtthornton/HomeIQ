# Story 19.4: Admin API Endpoints

## Status
**Ready for Review**

## Story
**As a** system operator,  
**I want** REST API endpoints to query device and entity inventory,  
**so that** I can access the data programmatically and display it in the dashboard.

## Acceptance Criteria
1. GET `/api/devices` endpoint lists all devices with optional filters
2. GET `/api/devices/{device_id}` endpoint returns specific device details
3. GET `/api/entities` endpoint lists all entities with optional filters
4. GET `/api/entities/{entity_id}` endpoint returns specific entity details
5. GET `/api/integrations` endpoint lists all config entries
6. All endpoints support pagination (limit/offset)
7. Endpoints return proper HTTP status codes and error messages

## Tasks / Subtasks

- [x] Create devices endpoints (AC: 1, 2, 6, 7)
  - [x] Create `services/admin-api/src/devices_endpoints.py`
  - [x] Implement GET `/api/devices` with filters
  - [x] Implement GET `/api/devices/{device_id}`
  - [x] Add pagination support (limit parameter)
  - [x] Add filter support (manufacturer, model, area_id)
  - [x] Add error handling (404, 500)
  - [x] Add response models (Pydantic)

- [x] Create entities endpoints (AC: 3, 4, 6, 7)
  - [x] Add GET `/api/entities` with filters
  - [x] Add GET `/api/entities/{entity_id}`
  - [x] Add pagination support
  - [x] Add filter support (domain, platform, device_id)
  - [x] Add error handling

- [x] Create integrations endpoint (AC: 5, 6, 7)
  - [x] Add GET `/api/integrations`
  - [x] Add pagination support
  - [x] Add error handling

- [x] Register routes (AC: all)
  - [x] Import devices_endpoints in main.py
  - [x] Register router with app
  - [x] Routes accessible and tested

- [x] Testing (AC: all)
  - [x] Unit test: devices endpoint (3 tests)
  - [x] Unit test: entities endpoint (3 tests)
  - [x] Unit test: integrations endpoint (1 test)
  - [x] Unit test: pagination (included in endpoint tests)
  - [x] Unit test: filters (4 query builder tests)
  - [x] Unit test: error handling (404 tests)

## Dev Notes

### Source Tree Context
From `docs/architecture/source-tree.md`:
- Admin API location: `services/admin-api/src/`
- New file: `devices_endpoints.py`
- Register in: `main.py`

### Technology Context
From `docs/architecture/tech-stack.md`:
- **Framework**: FastAPI 0.104.1
- **Language**: Python 3.11
- **Testing**: pytest 7.4.3+

### Existing API Patterns

From `services/admin-api/src/`:

**Endpoint Pattern**:
```python
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel

router = APIRouter()

@router.get("/api/resource")
async def list_resources():
    # Query data
    # Return results
    return {"resources": results}
```

**Router Registration** (in main.py):
```python
from devices_endpoints import router as devices_router

app.include_router(devices_router)
```

### InfluxDB Client Access

Admin API needs to query InfluxDB for device/entity data. Options:
1. Create new InfluxDB client in admin-api
2. Query via HTTP to websocket service
3. Direct InfluxDB connection (simplest)

**Recommended**: Create InfluxDB client in admin-api with read-only access

### API Endpoints Specification

**GET /api/devices**:
```json
{
  "devices": [
    {
      "device_id": "abc123",
      "name": "Living Room Light",
      "manufacturer": "Philips",
      "model": "Hue Bulb",
      "sw_version": "1.58.0",
      "area_id": "living_room",
      "entity_count": 3
    }
  ],
  "count": 1,
  "limit": 100
}
```

**Query Parameters**:
- `limit` (int, default: 100)
- `manufacturer` (string, optional)
- `model` (string, optional)
- `area_id` (string, optional)

**GET /api/devices/{device_id}**:
```json
{
  "device_id": "abc123",
  "name": "Living Room Light",
  ...
}
```

**GET /api/entities**:
- Similar structure to devices
- Filters: domain, platform, device_id

**GET /api/integrations**:
- Lists config entries
- Simple list, minimal filters

### Implementation Notes

1. **Keep it simple** - Basic CRUD endpoints
2. **Reuse patterns** - Copy from existing endpoints in admin-api
3. **No complex queries** - Simple InfluxDB Flux queries
4. **Basic pagination** - Just limit parameter (no offset initially)
5. **Standard errors** - 404 for not found, 500 for server errors

### Testing

**Unit Tests**:
- Location: `services/admin-api/tests/test_devices_endpoints.py`
- Mock InfluxDB responses
- Test each endpoint
- Test filters and pagination
- Test error cases

### Coding Standards
- Python functions: snake_case
- Use FastAPI patterns
- Type hints with Pydantic models
- Docstrings for endpoints
- Proper HTTP status codes

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-12 | 1.0 | Story created | James (Dev) |
| 2025-10-12 | 1.1 | Implementation complete, 13 tests passing | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (2025-10-12)

### Debug Log References
No debug log required - all tests passed.

### Completion Notes List
- Created `devices_endpoints.py` with 5 REST API endpoints
- Implemented GET /api/devices (list with filters and pagination)
- Implemented GET /api/devices/{device_id} (get specific device)
- Implemented GET /api/entities (list with filters and pagination)
- Implemented GET /api/entities/{entity_id} (get specific entity)
- Implemented GET /api/integrations (list config entries)
- Created Pydantic response models for type safety:
  - DeviceResponse, EntityResponse, IntegrationResponse
  - DevicesListResponse, EntitiesListResponse, IntegrationsListResponse
- Added query builder helper functions for Flux queries
- Filter support: manufacturer, model, area_id (devices), domain, platform, device_id (entities)
- Pagination: limit parameter (1-1000, default: 100)
- Error handling: 404 for not found, 500 for server errors
- Reused existing AdminAPIInfluxDBClient for queries
- Registered router in main.py with proper tags
- Created 13 comprehensive tests (all passing)
- No linter errors
- Follows existing FastAPI patterns in admin-api

### File List
**Created:**
- `services/admin-api/src/devices_endpoints.py` (339 lines)
- `services/admin-api/tests/test_devices_endpoints.py` (222 lines)

**Modified:**
- `services/admin-api/src/main.py` (+6 lines)
  - Added devices_router import
  - Registered devices_router in _add_routes()

## QA Results
_To be filled by QA agent_

