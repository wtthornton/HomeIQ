# Story 31.4: Event Pipeline Decoupling

## Status

Draft

## Story

**As a** system reliability engineer,
**I want** weather enrichment removed from the event processing pipeline,
**so that** Home Assistant events process 30% faster without weather API latency and the system has better failure isolation between weather and event processing.

## Acceptance Criteria

1. Weather enrichment code removed from websocket-ingestion service
2. Weather fields removed from ProcessedEvent data model
3. Enrichment-pipeline service updated to skip weather processing
4. Event processing performance improves by 30% (measured latency reduction)
5. Historical events with embedded weather remain queryable (backward compatibility)
6. InfluxDB schema supports both old (embedded) and new (no weather) events
7. Deprecation notices added to removed code for reference
8. All event processing tests pass without weather enrichment
9. No regression in existing event capture or normalization
10. Code review confirms complete decoupling (no weather dependencies remain)

## Tasks / Subtasks

- [ ] Task 1: Remove Weather Enrichment from Websocket-Ingestion (AC: 1, 7)
  - [ ] Remove weather_enrichment.py module
  - [ ] Remove WeatherEnrichmentService from main.py lifespan
  - [ ] Remove weather_client.py (migrated to weather-api in Story 31.2)
  - [ ] Remove weather imports from event processing logic
  - [ ] Add deprecation notice comments explaining migration
  - [ ] Update requirements.txt (remove weather-specific dependencies if any)
  - [ ] Archive removed code to git branch `archive/weather-enrichment`

- [ ] Task 2: Update ProcessedEvent Data Model (AC: 2, 6)
  - [ ] Remove weather, weather_enriched, weather_location fields from ProcessedEvent
  - [ ] Keep fields as Optional for backward compatibility in reads
  - [ ] Update TypeScript interfaces in health-dashboard
  - [ ] Update Python type hints in shared/types/
  - [ ] Add migration comments explaining schema evolution
  - [ ] Document schema version change (v2 → v3)

- [ ] Task 3: Update Enrichment Pipeline (AC: 3, 7)
  - [ ] Remove weather processing logic from data_normalizer.py
  - [ ] Remove weather-related validation rules
  - [ ] Remove weather field mappings in InfluxDB writes
  - [ ] Update enrichment tests to remove weather assertions
  - [ ] Add deprecation notices in comments
  - [ ] Verify enrichment continues without weather

- [ ] Task 4: InfluxDB Schema Compatibility (AC: 5, 6)
  - [ ] Verify historical events with weather fields remain readable
  - [ ] Test queries that use weather_condition tag (should work for old data)
  - [ ] Update InfluxDB write logic to NOT write weather fields for new events
  - [ ] Keep weather field definitions in schema for reference
  - [ ] Add schema migration documentation
  - [ ] Test mixed queries (old events with weather + new events without)

- [ ] Task 5: Performance Testing & Validation (AC: 4, 9)
  - [ ] Measure baseline event processing latency (before changes)
  - [ ] Run load test with 1000 events/minute
  - [ ] Measure post-decoupling latency
  - [ ] Verify 30% performance improvement achieved
  - [ ] Test event capture continues without errors
  - [ ] Test normalization pipeline continues without errors
  - [ ] Verify InfluxDB writes succeed

- [ ] Task 6: Update Tests (AC: 8)
  - [ ] Remove weather enrichment unit tests
  - [ ] Remove weather assertions from integration tests
  - [ ] Update event processing tests to NOT expect weather fields
  - [ ] Add regression tests for event pipeline performance
  - [ ] Test historical event queries (backward compatibility)
  - [ ] Verify all tests pass without weather enrichment

- [ ] Task 7: Documentation & Deprecation (AC: 7, 10)
  - [ ] Update docs/architecture/data-models.md (remove weather fields)
  - [ ] Update docs/architecture/database-schema.md (mark weather fields as legacy)
  - [ ] Create migration guide: docs/architecture/weather-migration-guide.md
  - [ ] Document backward compatibility strategy
  - [ ] Add comments in code explaining removal
  - [ ] Update README with weather API service reference

- [ ] Task 8: Code Review & Validation (AC: 10)
  - [ ] Search codebase for lingering weather references (grep)
  - [ ] Verify no imports of removed modules
  - [ ] Check for hardcoded weather field accesses
  - [ ] Review InfluxDB queries for weather dependencies
  - [ ] Conduct peer review focusing on complete decoupling
  - [ ] Run full regression test suite

## Dev Notes

### Testing Standards

**Performance Testing:**
```python
import time
import asyncio

async def test_event_processing_performance():
    """Measure event processing latency before and after decoupling"""
    
    # Create test events
    events = [create_test_event(i) for i in range(1000)]
    
    # Measure processing time
    start = time.time()
    for event in events:
        await process_event(event)
    end = time.time()
    
    latency_per_event = (end - start) / len(events) * 1000  # milliseconds
    
    # Target: <50ms per event after decoupling (vs ~70ms with weather)
    assert latency_per_event < 50, f"Latency too high: {latency_per_event}ms"
```

**Backward Compatibility Testing:**
```python
async def test_historical_weather_queries():
    """Verify old events with weather fields remain accessible"""
    
    # Query InfluxDB for old events (before migration)
    query = '''
    from(bucket: "home_assistant_events")
    |> range(start: -30d, stop: -7d)
    |> filter(fn: (r) => exists r.weather_condition)
    '''
    
    results = await influxdb_client.query(query)
    
    # Should return historical events with weather data
    assert len(results) > 0, "Historical weather data not accessible"
    assert results[0]['weather_condition'] in ['Clear', 'Clouds', 'Rain']
```

### Architecture Context

**Files to Modify:**

```
services/websocket-ingestion/
├── src/
│   ├── main.py                         # Remove weather enrichment from lifespan
│   ├── event_processor.py              # Remove weather enrichment calls
│   ├── weather_enrichment.py           # DELETE (move to archive branch)
│   └── weather_client.py               # DELETE (migrated to weather-api)

services/enrichment-pipeline/
├── src/
│   ├── data_normalizer.py              # Remove weather field processing
│   └── influxdb_wrapper.py             # Remove weather field writes

shared/types/
└── events.py                            # Update ProcessedEvent model

services/health-dashboard/src/types/
└── events.ts                            # Update ProcessedEvent interface
```

**InfluxDB Schema Migration:**

```python
# OLD SCHEMA (before decoupling)
class HomeAssistantEvent:
    # ... standard fields ...
    weather_temp: float  # DEPRECATED
    weather_humidity: int  # DEPRECATED
    weather_pressure: int  # DEPRECATED
    weather_condition: str  # DEPRECATED (tag)
    weather_enriched: bool  # DEPRECATED

# NEW SCHEMA (after decoupling)
class HomeAssistantEvent:
    # ... standard fields only ...
    # Weather fields removed
    # Use JOIN with weather_data measurement for correlation

# BACKWARD COMPATIBLE QUERIES
# Old approach (single query with embedded weather):
SELECT * FROM home_assistant_events WHERE weather_condition = 'Rain'

# New approach (JOIN with weather_data):
SELECT e.*, w.condition
FROM home_assistant_events e
LEFT JOIN weather w
  ON time_window(e.time, 5m) = time_window(w.time, 5m)
WHERE w.condition = 'Rain'
```

**Deprecation Notice Template:**

```python
# services/websocket-ingestion/src/main.py

# DEPRECATED (2025-10-19): Weather enrichment removed
# Weather data now fetched independently via weather-api service (Port 8009)
# Migration: Epic 31, Story 31.4
# Historical events with embedded weather remain accessible in InfluxDB
# For new weather correlation queries, use time-window JOIN with weather_data measurement
# Reference: docs/architecture/weather-migration-guide.md

# OLD CODE (removed):
# from .weather_enrichment import WeatherEnrichmentService
# self.weather_service = WeatherEnrichmentService()
# enriched_event = await self.weather_service.enrich_event(event_data)

# NEW CODE:
# Events are NOT enriched with weather
# Weather fetched independently by weather-api service
```

### Reference Implementations

**Code Removal Pattern** (from past migrations):
- Add deprecation notices before deletion
- Archive to git branch (not just git history)
- Update all imports and dependencies
- Remove from docker-compose if service deleted
- Update documentation immediately

**Schema Evolution Best Practices:**
- Use Optional types for removed fields
- Maintain backward compatibility for reads
- Document schema version changes
- Test with historical data
- Provide migration guide

### Context7 Verification

**Pydantic Model Updates** (verified against `/fastapi/fastapi`):
```python
from pydantic import BaseModel
from typing import Optional

# OLD MODEL
class ProcessedEvent(BaseModel):
    entity_id: str
    state: str
    weather: Optional[dict]  # DEPRECATED
    weather_enriched: Optional[bool]  # DEPRECATED

# NEW MODEL (backward compatible)
class ProcessedEvent(BaseModel):
    entity_id: str
    state: str
    # Weather fields removed from new events
    # Old events may still have these fields in InfluxDB
```

### Critical Success Factors

1. **Performance**: 30% improvement MUST be measurable
2. **Backward Compatibility**: Historical queries CANNOT break
3. **Complete Decoupling**: NO weather dependencies remain
4. **Testing**: All existing tests pass without modification
5. **Documentation**: Migration guide explains new pattern

### Integration Points

**Dependencies:**
- Story 31.1, 31.2, 31.3 - MUST BE COMPLETE (weather-api fully operational)
- Health Dashboard - Will be updated in Story 31.5
- InfluxDB - Historical data must remain accessible

**Impacts:**
- websocket-ingestion service (primary changes)
- enrichment-pipeline service (secondary changes)
- Shared type definitions (minor changes)
- Frontend TypeScript types (minor changes)

### Performance Benchmarks

**Before Decoupling (with weather enrichment):**
- Event processing latency: ~70ms per event
- Weather API calls: ~2000/day
- Events blocked by weather: ~5% (API timeouts)

**After Decoupling (without weather enrichment):**
- Target latency: ~50ms per event (30% improvement)
- Weather API calls: 0 (moved to weather-api service)
- Events blocked: 0% (independent processing)

### Rollback Plan

**If Issues Occur:**
1. Revert to `main` branch (before decoupling)
2. Restore weather_enrichment.py from archive branch
3. Re-enable weather enrichment in main.py lifespan
4. Redeploy websocket-ingestion service
5. Estimated rollback time: <10 minutes

**Rollback Command:**
```bash
git checkout archive/weather-enrichment -- services/websocket-ingestion/src/weather_enrichment.py
git checkout archive/weather-enrichment -- services/websocket-ingestion/src/weather_client.py
docker-compose up -d --build websocket-ingestion
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial story creation | BMad Master |

## Dev Agent Record

*This section will be populated during implementation*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be added here*

