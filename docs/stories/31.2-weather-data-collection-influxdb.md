# Story 31.2: Weather Data Collection & InfluxDB Persistence

## Status

Complete

## Story

**As a** system administrator,
**I want** weather data continuously collected and stored in InfluxDB,
**so that** weather information is available without excessive API calls.

## Acceptance Criteria

1. WeatherService class fetches from OpenWeatherMap (already in main.py)
2. Simple cache with 15-minute TTL (dict + timestamp, not separate module)
3. Weather written to InfluxDB `weather_data` measurement
4. Background fetch loop runs every 15 minutes
5. Cache stats tracked (hits/misses)
6. API failures handled with cached fallback
7. Memory footprint <100MB

## Tasks / Subtasks

- [x] Task 1: Add Weather Fetching to WeatherService
  - [x] Add OpenWeatherMap API call logic
  - [x] Parse response into simple dict
  - [x] Handle errors gracefully

- [x] Task 2: Simple Cache (Inline, No Module)
  - [x] Add cached_weather dict
  - [x] Add cache_time timestamp
  - [x] Check cache age before fetch
  - [x] Track hits/misses

- [x] Task 3: InfluxDB Integration (Inline)
  - [x] Create InfluxDB client in startup
  - [x] Write Point with tags/fields
  - [x] Fire-and-forget writes (no blocking)

- [x] Task 4: Background Loop
  - [x] Add run_continuous() method
  - [x] asyncio.create_task() in startup
  - [x] Sleep cache_ttl between fetches

## Dev Notes

**SIMPLE APPROACH:**
```python
class WeatherService:
    def __init__(self):
        self.cached_weather = None  # Simple dict
        self.cache_time = None      # Timestamp
        self.cache_ttl = 900         # 15 minutes
    
    async def get_current_weather(self):
        # Check cache
        if self.cached_weather and self.cache_time:
            age = (datetime.utcnow() - self.cache_time).total_seconds()
            if age < self.cache_ttl:
                return self.cached_weather
        
        # Fetch, cache, store
        weather = await self.fetch_weather()
        if weather:
            self.cached_weather = weather
            self.cache_time = datetime.utcnow()
            await self.store_in_influxdb(weather)
        return weather
```

**NO separate cache_service.py, circuit_breaker.py, etc.**

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial creation | BMad Master |
| 2025-10-19 | 2.0 | Simplified - inline everything | BMad Master |

## Dev Agent Record

### Completion Notes

âœ… Story 31.2 COMPLETE - All in main.py (~250 lines total)
- Simple caching (no module)
- InfluxDB writes inline
- Background fetch loop
- No over-engineering
