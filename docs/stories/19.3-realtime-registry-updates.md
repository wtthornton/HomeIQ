# Story 19.3: Real-Time Registry Updates

## Status
**Ready for Review**

## Story
**As a** system operator,  
**I want** real-time notifications when devices/entities are added/removed/changed in Home Assistant,  
**so that** our inventory stays synchronized without polling.

## Acceptance Criteria
1. Service subscribes to `device_registry_updated` events on connect
2. Service subscribes to `entity_registry_updated` events on connect
3. Device registry update events are processed and logged
4. Entity registry update events are processed and logged
5. Storage updated when registry changes occur
6. All registry changes logged with action type (create/update/remove)
7. Errors handled gracefully without disrupting event stream

## Tasks / Subtasks

- [x] Add registry event subscriptions (AC: 1, 2)
  - [x] Add subscribe_to_device_registry_events() to discovery_service
  - [x] Add subscribe_to_entity_registry_events() to discovery_service
  - [x] Call subscriptions in connection_manager._on_connect()
  - [x] Handle subscription confirmation responses

- [x] Handle device registry events (AC: 3, 5, 6)
  - [x] Detect event type in _on_message handler
  - [x] Parse device_registry_updated event data
  - [x] Extract action (create/update/remove)
  - [x] Log device change with details
  - [x] Convert to Device model and store
  - [x] Handle storage errors

- [x] Handle entity registry events (AC: 4, 5, 6)
  - [x] Parse entity_registry_updated event data
  - [x] Extract action (create/update/remove)
  - [x] Log entity change with details
  - [x] Convert to Entity model and store
  - [x] Handle storage errors

- [x] Error handling (AC: 7)
  - [x] Handle malformed registry events
  - [x] Handle missing event data
  - [x] Continue processing other events on error
  - [x] Log errors without crashing

- [x] Testing (AC: all)
  - [x] Unit test: subscription methods (2 tests)
  - [x] Unit test: event parsing and processing
  - [x] Mock test: device registry event handling (2 tests)
  - [x] Mock test: entity registry event handling (2 tests)
  - [x] Integration test: event handling logic verified

## Dev Notes

### Source Tree Context
- Enhance: `services/websocket-ingestion/src/discovery_service.py`
- Enhance: `services/websocket-ingestion/src/connection_manager.py`
- Existing pattern: Event subscription in event_subscription.py

### Technology Context
- **Language**: Python 3.11
- **WebSocket**: aiohttp 3.9.1
- **Models**: Already created in Story 19.2
- **Storage**: Already implemented in Story 19.2

### WebSocket Event Subscription Pattern

From Context7 KB (`docs/kb/context7-cache/libraries/homeassistant/docs.md`):

**Subscribe to Registry Events**:
```json
{
  "id": 10,
  "type": "subscribe_events",
  "event_type": "device_registry_updated"
}
```

**Event Received**:
```json
{
  "id": 10,
  "type": "event",
  "event": {
    "event_type": "device_registry_updated",
    "data": {
      "action": "create",
      "device_id": "abc123",
      "device": {...}
    }
  }
}
```

### Existing Event Handling Pattern

From `services/websocket-ingestion/src/connection_manager.py`:
```python
async def _on_message(self, message: Dict[str, Any]):
    if message.get("type") == "event":
        event_data = message.get("event", {})
        # Process event
```

### Implementation Notes

1. Reuse existing event subscription pattern from event_subscription.py
2. Add registry event handlers to connection_manager._on_message()
3. Keep simple - just detect event type, log, and store
4. Non-fatal errors - don't crash on bad events
5. Storage is optional (graceful if no InfluxDB)

### Testing

**Unit Tests**:
- Location: `services/websocket-ingestion/tests/test_discovery_service.py` (enhance)
- Test subscription command sending
- Test event parsing
- Mock event handling

**Integration Test**:
- Mock complete flow: subscribe → receive event → store
- Verify storage called with correct data

### Coding Standards
- Python functions: snake_case
- Use async/await for I/O
- Type hints on parameters
- Docstrings for public methods
- Handle exceptions explicitly

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-12 | 1.0 | Story created | James (Dev) |
| 2025-10-12 | 1.1 | Implementation complete, 41 tests passing | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (2025-10-12)

### Debug Log References
No debug log required - all tests passed.

### Completion Notes List
- Added 2 subscription methods to `discovery_service.py`:
  - subscribe_to_device_registry_events() - subscribes to device changes
  - subscribe_to_entity_registry_events() - subscribes to entity changes
- Added 2 event handler methods to `discovery_service.py`:
  - handle_device_registry_event() - processes device updates
  - handle_entity_registry_event() - processes entity updates
- Enhanced `connection_manager._on_connect()` to call both subscriptions after discovery
- Enhanced `connection_manager._on_message()` to route registry events to handlers
- Event routing logic detects event_type and routes to appropriate handler
- Comprehensive logging for all registry changes (action, ID, details)
- Automatic storage of registry updates (optional if InfluxDB available)
- Graceful error handling - events continue processing on errors
- Non-fatal failures logged but don't crash service
- Added 6 comprehensive tests for subscriptions and event handling
- All 41 tests passing (22 model + 13 discovery + 6 registry events)
- No linter errors

### File List
**Modified:**
- `services/websocket-ingestion/src/discovery_service.py` (+149 lines)
  - Added subscribe_to_device_registry_events()
  - Added subscribe_to_entity_registry_events()
  - Added handle_device_registry_event()
  - Added handle_entity_registry_event()

- `services/websocket-ingestion/src/connection_manager.py` (+17 lines)
  - Added registry event subscriptions in _on_connect()
  - Added registry event routing in _on_message()

- `services/websocket-ingestion/tests/test_discovery_service.py` (+128 lines)
  - Added 6 new tests for registry event handling

## QA Results
_To be filled by QA agent_

