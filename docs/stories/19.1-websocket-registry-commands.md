# Story 19.1: WebSocket Registry Commands

## Status
**Ready for Review**

## Story
**As a** system operator,  
**I want** the WebSocket ingestion service to query Home Assistant device/entity registries,  
**so that** we have a complete inventory of connected devices and entities.

## Acceptance Criteria
1. Service can send `config/device_registry/list` command to HA and parse response
2. Service can send `config/entity_registry/list` command to HA and parse response
3. Service can send `config_entries/list` command to HA and parse response
4. All three commands executed on WebSocket connection established
5. Responses logged with device/entity counts
6. Errors handled gracefully without crashing service
7. Sample data from each registry logged for verification

## Tasks / Subtasks

- [x] Create discovery service module (AC: 1, 2, 3)
  - [x] Create `services/websocket-ingestion/src/discovery_service.py`
  - [x] Implement `DiscoveryService` class
  - [x] Add `discover_devices()` method - send device_registry/list
  - [x] Add `discover_entities()` method - send entity_registry/list
  - [x] Add `discover_config_entries()` method - send config_entries/list

- [x] Integrate with connection manager (AC: 4)
  - [x] Add `discovery_service` to ConnectionManager
  - [x] Call discovery on successful WebSocket connect
  - [x] Run discovery in `_on_connect()` method

- [x] Add logging and error handling (AC: 5, 6, 7)
  - [x] Log device count from registry
  - [x] Log entity count from registry
  - [x] Log sample device (first one)
  - [x] Log sample entity (first one)
  - [x] Handle JSON parse errors
  - [x] Handle timeout errors
  - [x] Handle malformed responses

- [x] Testing (AC: all)
  - [x] Unit test: discovery_service.py methods
  - [x] Integration test: discovery with mock HA responses
  - [ ] Manual test: connect to real HA and verify logs

## Dev Notes

### Source Tree Context
From `docs/architecture/source-tree.md`:
- WebSocket service location: `services/websocket-ingestion/src/`
- Existing patterns: `websocket_client.py`, `connection_manager.py`
- Add new file: `discovery_service.py` in same directory

### Technology Context
From `docs/architecture/tech-stack.md`:
- **Language**: Python 3.11
- **WebSocket Library**: aiohttp 3.9.1
- **Testing**: pytest 7.4.3+
- **Async Pattern**: async/await with asyncio

### Existing Code Patterns
From `services/websocket-ingestion/src/`:

**WebSocket Command Pattern** (from `websocket_client.py`):
```python
async def send_command(self, command_type: str, **kwargs):
    message_id = self._get_next_id()
    await self.websocket.send_json({
        "id": message_id,
        "type": command_type,
        **kwargs
    })
    return await self._wait_for_response(message_id)
```

**Connection Callback Pattern** (from `connection_manager.py`):
```python
async def _on_connect(self):
    logger.info("Connected to Home Assistant")
    await self._subscribe_to_events()
    if self.on_connect:
        await self.on_connect()
```

### WebSocket Commands to Implement

**Device Registry**:
```json
{
  "id": 100,
  "type": "config/device_registry/list"
}
```

**Entity Registry**:
```json
{
  "id": 101,
  "type": "config/entity_registry/list"
}
```

**Config Entries**:
```json
{
  "id": 102,
  "type": "config_entries/list"
}
```

**Response Format**:
```json
{
  "id": 100,
  "type": "result",
  "success": true,
  "result": [...]
}
```

### Implementation Notes
1. Keep it simple - just send commands and parse responses
2. No data storage yet (Story 19.2)
3. No event subscriptions yet (Story 19.3)
4. Focus on proving WebSocket commands work
5. Reuse existing websocket_client.py patterns

### Testing

**Unit Tests**:
- Location: `services/websocket-ingestion/tests/test_discovery_service.py`
- Mock WebSocket responses
- Test each discover method
- Test error handling

**Integration Tests**:
- Mock complete HA registry responses
- Verify command/response flow
- Verify logging output

**Manual Test**:
- Connect to real Home Assistant
- Check logs for device/entity counts
- Verify no errors in service

### Coding Standards
From `docs/architecture/coding-standards.md`:
- Python functions: snake_case
- Use async/await for I/O operations
- Type hints on all function parameters
- Docstrings for public functions
- Handle exceptions explicitly

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-12 | 1.0 | Story created | BMad Master |
| 2025-10-12 | 1.1 | Implementation complete, all tests passing | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (2025-10-12)

### Debug Log References
No debug log required - all tests passed on first run.

### Completion Notes List
- Created `discovery_service.py` with 3 registry query methods (devices, entities, config_entries)
- Each method sends WebSocket command, waits for response, logs results, handles errors
- Integrated with `connection_manager.py` - discovery runs automatically on WebSocket connect
- All error handling implemented: timeouts, JSON parse errors, malformed responses, non-fatal failures
- Comprehensive logging with emoji icons for visual clarity in logs
- Created 13 unit tests covering success cases, failures, timeouts, partial failures
- All tests passed (13/13) on first run
- No linter errors
- Manual testing pending (requires live HA connection)

### File List
**Created:**
- `services/websocket-ingestion/src/discovery_service.py` (329 lines)
- `services/websocket-ingestion/tests/test_discovery_service.py` (384 lines)

**Modified:**
- `services/websocket-ingestion/src/connection_manager.py` (+18 lines)
  - Added import for DiscoveryService
  - Added discovery_service initialization
  - Added discovery call in _on_connect() method

## QA Results
_To be filled by QA agent_

