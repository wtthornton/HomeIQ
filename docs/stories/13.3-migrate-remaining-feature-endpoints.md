# Story 13.3: Migrate Remaining Feature Endpoints & WebSockets

**Epic**: Epic 13 - Admin API Service Separation  
**Story Number**: 13.3  
**Status**: Draft  
**Created**: 2025-10-13  
**Estimated Effort**: 5 days  
**Depends On**: Story 13.2 (events & devices migrated)

---

## Story

**As a** system architect,  
**I want** all remaining feature endpoints (alerts, metrics, integrations, WebSockets) migrated from admin-api to data-api,  
**so that** admin-api contains only system monitoring endpoints, enabling clean separation of concerns and independent scaling.

---

## Story Context

**Existing System Integration:**
- **Integrates with**: data-api (enhanced in Story 13.2), all dashboard tabs, InfluxDB, external services
- **Technology**: FastAPI routers, WebSocket connections, alert system, metrics collection
- **Follows pattern**: Existing endpoint modules from admin-api
- **Touch points**: All 12 dashboard tabs, nginx routing, service integrations

**Current State** (After Story 13.2):
- data-api has events and devices endpoints
- admin-api still has: alerts, metrics, integrations, WebSockets, monitoring
- Dashboard Events/Devices tabs use data-api
- Other tabs still use admin-api

**Target State**:
- ALL feature endpoints in data-api
- ONLY system monitoring in admin-api
- Dashboard fully migrated to use data-api for features
- admin-api clean and focused (22 endpoints only)

---

## Acceptance Criteria

### Functional Requirements

1. **Alert endpoints migrated** to data-api with all 5 routes functional (GET, POST, PUT, DELETE)
2. **Metrics endpoints migrated** to data-api with all 6 analytics routes functional
3. **Integration endpoints migrated** to data-api with all 7 management routes functional
4. **WebSocket endpoints migrated** to data-api with all 3 streaming connections functional
5. **All 12 dashboard tabs work** via appropriate service (11 via data-api, 1 via admin-api)

### Migration Requirements

6. **admin-api contains only system endpoints** (~22 total: health, Docker, config, monitoring, system stats)
7. **admin-api codebase cleaned** (migrated endpoint modules removed, code size reduced ~60%)
8. **Deprecated endpoints removed** from admin-api (feature flag OFF)
9. **Dashboard API service complete** with clear AdminApiClient vs DataApiClient separation
10. **Nginx routing finalized** for all feature vs system endpoints

### Quality Requirements

11. **All dashboard tabs functional** (comprehensive regression testing, no visual regressions)
12. **Performance targets met** (admin-api <50ms, data-api <200ms for p95)
13. **Load testing passes** (4 concurrent dashboard users, all tabs responsive)
14. **WebSocket connections stable** (no dropped connections during migration)
15. **API documentation updated** (FastAPI /docs pages for both services)

---

## Tasks / Subtasks

### Task 1: Migrate Alert Endpoints (AC: 1)
- [ ] Copy `services/admin-api/src/alert_endpoints.py` → `services/data-api/src/alert_endpoints.py`
- [ ] Copy `services/admin-api/src/alerting_service.py` → `services/data-api/src/alerting_service.py`
- [ ] Update imports (use shared utilities)
- [ ] Register router in data-api main.py
- [ ] Test all alert CRUD operations
- [ ] Update dashboard Alerts tab to use data-api

### Task 2: Migrate Metrics Endpoints (AC: 2)
- [ ] Copy `services/admin-api/src/metrics_endpoints.py` → `services/data-api/src/metrics_endpoints.py`
- [ ] Copy `services/admin-api/src/metrics_service.py` → `services/data-api/src/metrics_service.py`
- [ ] Update imports
- [ ] Register router in data-api
- [ ] Test analytics queries
- [ ] Update dashboard Analytics tab to use data-api

### Task 3: Migrate Integration Endpoints (AC: 3)
- [ ] Copy `services/admin-api/src/integration_endpoints.py` → `services/data-api/src/integration_endpoints.py`
- [ ] Keep service controller reference (may need shared or both services)
- [ ] Update imports
- [ ] Register router in data-api
- [ ] Test integration management operations
- [ ] Update dashboard Services tab integration features

### Task 4: Migrate WebSocket Endpoints (AC: 4, 14)
- [ ] Copy `services/admin-api/src/websocket_endpoints.py` → `services/data-api/src/websocket_endpoints.py`
- [ ] Update WebSocket connection manager
- [ ] Update broadcast loop for metrics/events/alerts
- [ ] Register WebSocket routes in data-api
- [ ] Test WebSocket connections
- [ ] Update dashboard WebSocket service to use data-api
- [ ] Verify connection stability (monitor for 1 hour)

### Task 5: Update Dashboard for All Tabs (AC: 5, 9, 11)
- [ ] Update `src/services/api.ts` - finalize AdminApiClient vs DataApiClient
- [ ] Update Overview tab (uses both APIs)
- [ ] Update Custom tab
- [ ] Update Services tab (mixed: health from admin, data from data-api)
- [ ] Update Dependencies tab
- [ ] Update Events tab (already done in 13.2, verify)
- [ ] Update Devices tab (already done in 13.2, verify)
- [ ] Update Logs tab
- [ ] Update Sports tab (prepare for Epic 12)
- [ ] Update Data Sources tab
- [ ] Update Analytics tab
- [ ] Update Alerts tab
- [ ] Update Configuration tab (uses admin-api for system config)

### Task 6: Clean Up admin-api (AC: 6, 7, 8)
- [ ] Remove `alert_endpoints.py` from admin-api
- [ ] Remove `metrics_endpoints.py` from admin-api
- [ ] Remove `integration_endpoints.py` from admin-api
- [ ] Remove `websocket_endpoints.py` from admin-api
- [ ] Remove `events_endpoints.py` from admin-api
- [ ] Remove `devices_endpoints.py` from admin-api
- [ ] Update main.py to remove router imports
- [ ] Remove unused dependencies
- [ ] Verify admin-api still starts
- [ ] Measure codebase size reduction

### Task 7: Finalize Nginx Routing (AC: 10)
- [ ] Update nginx.conf with complete routing rules:
  ```nginx
  # System monitoring (admin-api)
  location /api/v1/health { proxy_pass http://admin-api:8003; }
  location /api/v1/monitoring { proxy_pass http://admin-api:8003; }
  location /api/docker { proxy_pass http://admin-api:8003; }
  location /api/v1/config { proxy_pass http://admin-api:8003; }
  location /api/v1/stats { proxy_pass http://admin-api:8003; }
  
  # Feature data (data-api)
  location /api/v1/events { proxy_pass http://data-api:8006; }
  location /api/v1/devices { proxy_pass http://data-api:8006; }
  location /api/v1/entities { proxy_pass http://data-api:8006; }
  location /api/v1/alerts { proxy_pass http://data-api:8006; }
  location /api/v1/analytics { proxy_pass http://data-api:8006; }
  location /api/v1/integrations { proxy_pass http://data-api:8006; }
  location /api/v1/ws { proxy_pass http://data-api:8006; }
  ```
- [ ] Test nginx config
- [ ] Reload nginx
- [ ] Verify all routes work

### Task 8: Performance & Load Testing (AC: 12, 13)
- [ ] Create load test script (simulate 4 concurrent users)
- [ ] Test all dashboard tabs under load
- [ ] Measure response times (p50, p95, p99)
- [ ] Verify admin-api response times improved
- [ ] Verify data-api handles query load
- [ ] Monitor resource usage (CPU, memory, connections)
- [ ] Document performance results

### Task 9: Comprehensive Regression Testing (AC: 11, 14)
- [ ] Run all existing admin-api tests (should still pass)
- [ ] Run all dashboard E2E tests (Playwright)
- [ ] Test each dashboard tab manually
- [ ] Test WebSocket connections (real-time updates)
- [ ] Test error scenarios (service down, InfluxDB down)
- [ ] Test rollback scenario (disable data-api, fallback to admin-api)
- [ ] Verify no visual regressions
- [ ] Check browser console (no errors)

### Task 10: Documentation & Deployment (AC: 15)
- [ ] Update API documentation (both services)
- [ ] Update architecture documentation
- [ ] Update deployment guide
- [ ] Create migration guide for users
- [ ] Update EXTERNAL_API_CALL_TREES.md (reference data-api)
- [ ] Update docker-compose.yml comments
- [ ] Create rollback procedure document

---

## Dev Notes

### Service Responsibilities (Final State)

**admin-api (Port 8003)** - System Monitoring & Control:
```python
# Modules remaining in admin-api:
- health_endpoints.py        # System health checks
- monitoring_endpoints.py    # System monitoring
- docker_endpoints.py        # Container management
- config_endpoints.py        # System configuration
- stats_endpoints.py         # System statistics (processing rates)
- auth.py                    # Shared from shared/
- logging_service.py         # System logging
```

**data-api (Port 8006)** - Feature Data Hub:
```python
# Modules moved to data-api:
- events_endpoints.py        # HA event queries (from 13.2)
- devices_endpoints.py       # Device/entity browser (from 13.2)
- alert_endpoints.py         # Alert management (this story)
- metrics_endpoints.py       # Analytics/metrics (this story)
- integration_endpoints.py   # Integration management (this story)
- websocket_endpoints.py     # Real-time streaming (this story)
- auth.py                    # Shared from shared/
- alerting_service.py        # Alert processing
- metrics_service.py         # Metrics collection
```

### WebSocket Migration Considerations

**Critical**: WebSocket state must be preserved during migration

**Approach**:
1. Start data-api WebSocket server
2. Dashboard connects to both (dual connection temporarily)
3. Verify data-api WebSocket working
4. Switch dashboard to data-api only
5. Shutdown admin-api WebSocket server

**Connection Manager Pattern**:
```python
# data-api/src/websocket_endpoints.py
class WebSocketManager:
    def __init__(self):
        self.active_connections: List[WebSocket] = []
        self.broadcast_task: Optional[asyncio.Task] = None
    
    async def connect(self, websocket: WebSocket):
        await websocket.accept()
        self.active_connections.append(websocket)
    
    async def broadcast(self, message: dict):
        for connection in self.active_connections:
            try:
                await connection.send_json(message)
            except:
                self.active_connections.remove(connection)
```

### Performance Testing Script

```python
# scripts/load_test_apis.py
import asyncio
import aiohttp
import time

async def simulate_dashboard_user():
    """Simulate one dashboard user querying all tabs"""
    async with aiohttp.ClientSession() as session:
        # Query all endpoints a dashboard would hit
        endpoints = [
            'http://localhost:8003/api/v1/health',        # admin-api
            'http://localhost:8006/api/v1/events',        # data-api
            'http://localhost:8006/api/v1/devices',       # data-api
            'http://localhost:8006/api/v1/alerts',        # data-api
            'http://localhost:8006/api/v1/analytics/realtime'  # data-api
        ]
        
        for endpoint in endpoints:
            start = time.time()
            async with session.get(endpoint) as response:
                await response.json()
                latency = (time.time() - start) * 1000
                print(f"{endpoint}: {latency:.2f}ms")

# Run 4 concurrent users
async def main():
    tasks = [simulate_dashboard_user() for _ in range(4)]
    await asyncio.gather(*tasks)

asyncio.run(main())
```

---

## Testing

### Regression Test Checklist

**Dashboard Tabs** (all must work):
- [ ] Overview Tab (system health from admin-api, metrics from data-api)
- [ ] Custom Tab
- [ ] Services Tab (health from admin-api, integration data from data-api)
- [ ] Dependencies Tab
- [ ] Devices Tab (via data-api)
- [ ] Events Tab (via data-api)
- [ ] Logs Tab
- [ ] Sports Tab (ready for Epic 12)
- [ ] Data Sources Tab
- [ ] Analytics Tab (via data-api)
- [ ] Alerts Tab (via data-api)
- [ ] Configuration Tab (via admin-api)

**WebSocket Streams** (all must work):
- [ ] Real-time metrics updates
- [ ] Real-time event stream
- [ ] Real-time alert notifications

**API Performance**:
- [ ] admin-api health check: <50ms (p95)
- [ ] data-api event queries: <200ms (p95)
- [ ] data-api device queries: <100ms (p95)
- [ ] WebSocket latency: <100ms

---

## QA Results

(To be populated by QA Agent after implementation)

---

**Story Ready for**: Development  
**Previous Story**: 13.2 - Migrate Events & Devices Endpoints  
**Next Story**: 13.4 - Sports Data & HA Automation Integration

