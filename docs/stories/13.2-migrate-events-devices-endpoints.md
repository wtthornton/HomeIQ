# Story 13.2: Migrate Events & Devices Endpoints to data-api

**Epic**: Epic 13 - Admin API Service Separation  
**Story Number**: 13.2  
**Status**: Draft  
**Created**: 2025-10-13  
**Estimated Effort**: 4 days  
**Depends On**: Story 13.1 (data-api foundation)

---

## Story

**As a** dashboard user,  
**I want** event and device browsing functionality to work through the new data-api service,  
**so that** I can continue using the Events and Devices tabs while the system architecture improves with better performance and scalability.

---

## Story Context

**Existing System Integration:**
- **Integrates with**: data-api (created in Story 13.1), dashboard Events/Devices tabs, InfluxDB
- **Technology**: FastAPI routers, InfluxDB SQL queries, React hooks (useEvents, useDevices)
- **Follows pattern**: Existing events_endpoints.py and devices_endpoints.py from admin-api
- **Touch points**: Dashboard API service layer, nginx routing, InfluxDB measurements

**Current State** (After Story 13.1):
- data-api service exists and running (port 8006)
- events_endpoints.py in admin-api (port 8003)
- devices_endpoints.py in admin-api (port 8003)
- Dashboard calls admin-api for both

**Target State**:
- events_endpoints.py migrated to data-api
- devices_endpoints.py migrated to data-api
- Dashboard Events tab calls data-api
- Dashboard Devices tab calls data-api
- admin-api endpoints deprecated (feature flag)

---

## Acceptance Criteria

### Functional Requirements

1. **Events endpoints functional in data-api** with all 8 routes working (GET /events, GET /events/{id}, POST /events/search, etc.)
2. **Devices endpoints functional in data-api** with all 5 routes working (GET /devices, GET /entities, etc.)
3. **Dashboard Events tab works** via data-api with same functionality as before (event list, filtering, search)
4. **Dashboard Devices tab works** via data-api with device/entity browsing unchanged
5. **Query performance meets SLA** (<200ms for events queries, <100ms for device queries)

### Integration Requirements

6. **admin-api endpoints return deprecation warnings** when `DEPRECATED_ENDPOINTS_ENABLED=true` in headers
7. **Nginx routes correctly** to data-api for `/api/v1/events` and `/api/v1/devices` paths
8. **Dashboard API service updated** with DataApiClient class separating admin vs data calls
9. **Both services can run simultaneously** during migration (dual-routing support)
10. **Backward compatibility** maintained (feature flag allows rollback to admin-api)

### Quality Requirements

11. **Integration tests pass** for both services (events queries, device queries)
12. **Dashboard regression tests pass** (Events tab, Devices tab, no visual regressions)
13. **Response times logged** and meet performance targets
14. **No regression in admin-api** functionality (other endpoints still work)

---

## Tasks / Subtasks

### Task 1: Copy Endpoint Files to data-api (AC: 1, 2)
- [ ] Copy `services/admin-api/src/events_endpoints.py` → `services/data-api/src/events_endpoints.py`
- [ ] Copy `services/admin-api/src/devices_endpoints.py` → `services/data-api/src/devices_endpoints.py`
- [ ] Update imports to use `shared/` utilities
- [ ] Remove any admin-specific logic
- [ ] Verify no circular dependencies

### Task 2: Register Routes in data-api (AC: 1, 2)
- [ ] Update `services/data-api/src/main.py`
- [ ] Import EventsEndpoints and DevicesEndpoints
- [ ] Register routers: `app.include_router(events_endpoints.router, prefix="/api/v1", tags=["Events"])`
- [ ] Register devices router similarly
- [ ] Test endpoints respond: `curl http://localhost:8006/api/v1/events`

### Task 3: Create InfluxDB Query Layer in data-api (AC: 5)
- [ ] Ensure InfluxDB client is initialized (from Story 13.1)
- [ ] Verify connection pooling (max 10 connections)
- [ ] Test query performance with actual data
- [ ] Add query timeout (5 seconds)
- [ ] Add query result caching (5-minute TTL for historical queries)
- [ ] Log query execution times

### Task 4: Add Deprecation to admin-api Endpoints (AC: 6)
- [ ] Create feature flag: `DEPRECATED_ENDPOINTS_ENABLED=true` in admin-api
- [ ] Wrap events routes with deprecation middleware
- [ ] Add response header: `X-Deprecated: "Use http://data-api:8006/api/v1/events instead"`
- [ ] Add response header: `X-Deprecation-Date: "2025-10-27"`
- [ ] Log deprecation warnings
- [ ] Document migration path

### Task 5: Update Dashboard API Service Layer (AC: 3, 4, 8)
- [ ] Open `services/health-dashboard/src/services/api.ts`
- [ ] Create `DataApiClient` class
- [ ] Create environment variable: `VITE_DATA_API_URL=http://localhost:8006`
- [ ] Update event queries to use DataApiClient
- [ ] Update device queries to use DataApiClient
- [ ] Keep admin queries using AdminApiClient
- [ ] Add feature flag: `USE_DATA_API=true` (rollback capability)
- [ ] Test both API clients work

### Task 6: Update Nginx Routing (AC: 7, 9)
- [ ] Edit `services/health-dashboard/nginx.conf`
- [ ] Add routing rules:
  ```nginx
  location /api/v1/events {
      proxy_pass http://data-api:8006/api/v1/events;
  }
  location /api/v1/devices {
      proxy_pass http://data-api:8006/api/v1/devices;
  }
  location /api/v1/entities {
      proxy_pass http://data-api:8006/api/v1/entities;
  }
  ```
- [ ] Test nginx config: `nginx -t`
- [ ] Reload nginx: `docker-compose restart health-dashboard`
- [ ] Verify routing with curl

### Task 7: Update Dashboard Components (AC: 3, 4)
- [ ] Update `services/health-dashboard/src/components/tabs/EventsTab.tsx`
- [ ] Update `services/health-dashboard/src/components/tabs/DevicesTab.tsx`
- [ ] Verify useEvents hook works with data-api
- [ ] Verify useDevices hook works with data-api
- [ ] Test real-time updates still work
- [ ] Test filtering and search functionality

### Task 8: Integration Testing (AC: 11, 12, 13, 14)
- [ ] Create `services/data-api/tests/test_integration.py`
- [ ] Test events endpoint with real InfluxDB data
- [ ] Test devices endpoint with real data
- [ ] Test error handling (InfluxDB unavailable)
- [ ] Test pagination (large result sets)
- [ ] Test filtering (entity_id, event_type, time range)
- [ ] Run integration tests: `pytest services/data-api/tests/test_integration.py`
- [ ] Verify all tests pass

### Task 9: Dashboard Regression Testing (AC: 12, 14)
- [ ] Start all services (docker-compose up)
- [ ] Open dashboard (http://localhost:3000)
- [ ] Test Events tab:
  - [ ] Event list loads
  - [ ] Filtering works (entity, type, time)
  - [ ] Search functionality works
  - [ ] Real-time updates still functional
  - [ ] Export feature works
- [ ] Test Devices tab:
  - [ ] Device list loads
  - [ ] Entity list loads
  - [ ] Device details view works
  - [ ] Filtering works (manufacturer, area)
- [ ] Test admin-api endpoints still work (Health tab, Services tab)
- [ ] Check browser console for errors
- [ ] Verify no performance regression

### Task 10: Performance Testing (AC: 5, 13)
- [ ] Measure event query response times (100 events)
- [ ] Measure device query response times (100 devices)
- [ ] Test with large datasets (1000+ events)
- [ ] Test concurrent requests (4 dashboard users)
- [ ] Verify p95 response times:
  - [ ] Events queries: <200ms
  - [ ] Device queries: <100ms
- [ ] Log performance metrics to InfluxDB

### Task 11: Documentation Updates
- [ ] Update `docs/API_DOCUMENTATION.md` with data-api endpoints
- [ ] Update architecture diagrams (show both services)
- [ ] Update `services/data-api/README.md` with events/devices docs
- [ ] Create migration guide for users
- [ ] Document feature flag usage (rollback instructions)

---

## Dev Notes

### Dashboard API Service Pattern

From `services/health-dashboard/src/services/api.ts`:

**Current**:
```typescript
class ApiService {
  private baseURL = 'http://localhost:8003/api/v1';
  
  async getEvents(): Promise<Event[]> {
    const response = await fetch(`${this.baseURL}/events`);
    return response.json();
  }
}
```

**Target**:
```typescript
class AdminApiClient {
  private baseURL = 'http://localhost:8003/api/v1';
  
  async getHealth() { /* ... */ }
  async getSystemStats() { /* ... */ }
}

class DataApiClient {
  private baseURL = 'http://localhost:8006/api/v1';
  
  async getEvents(): Promise<Event[]> {
    const response = await fetch(`${this.baseURL}/events`);
    return response.json();
  }
  
  async getDevices(): Promise<Device[]> {
    const response = await fetch(`${this.baseURL}/devices`);
    return response.json();
  }
}

// Export both
export const adminApi = new AdminApiClient();
export const dataApi = new DataApiClient();
```

### Component Update Pattern

```typescript
// OLD (Story 13.1 - before)
import { apiService } from '../services/api';
const events = await apiService.getEvents();

// NEW (Story 13.2 - after)
import { dataApi } from '../services/api';
const events = await dataApi.getEvents();
```

### Feature Flag Pattern

In dashboard:
```typescript
// src/config.ts
export const USE_DATA_API = import.meta.env.VITE_USE_DATA_API === 'true';
export const DATA_API_URL = import.meta.env.VITE_DATA_API_URL || 'http://localhost:8006';

// src/services/api.ts
const apiClient = USE_DATA_API ? dataApi : adminApi;  // Rollback capability
```

---

## Testing

### Integration Test Example

```python
# services/data-api/tests/test_integration.py

import pytest
from httpx import AsyncClient
from src.main import app

@pytest.mark.asyncio
async def test_events_endpoint_integration(influxdb_test_data):
    """Test events endpoint with real InfluxDB data"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        response = await client.get("/api/v1/events?limit=10")
        
        assert response.status_code == 200
        events = response.json()
        assert isinstance(events, list)
        assert len(events) <= 10
        
        # Verify structure
        if events:
            event = events[0]
            assert "id" in event
            assert "entity_id" in event
            assert "timestamp" in event
            assert "event_type" in event

@pytest.mark.asyncio
async def test_devices_endpoint_integration():
    """Test devices endpoint"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        response = await client.get("/api/v1/devices?limit=10")
        
        assert response.status_code == 200
        data = response.json()
        assert "devices" in data
        assert "count" in data
```

### Dashboard E2E Test (Playwright)

```typescript
// tests/e2e/events-tab.spec.ts

test('Events tab loads from data-api', async ({ page }) => {
  await page.goto('http://localhost:3000');
  
  // Click Events tab
  await page.click('text=Events');
  
  // Wait for event list to load
  await page.waitForSelector('[data-testid="event-list"]');
  
  // Verify events displayed
  const events = await page.$$('[data-testid="event-row"]');
  expect(events.length).toBeGreaterThan(0);
  
  // Verify API call went to data-api (check network tab)
  const requests = page.context().requests();
  const eventRequest = requests.find(r => r.url().includes('/api/v1/events'));
  expect(eventRequest?.url()).toContain('8006');  // data-api port
});
```

---

## QA Results

(To be populated by QA Agent after implementation)

---

**Story Ready for**: Development  
**Previous Story**: 13.1 - Create data-api Service Foundation  
**Next Story**: 13.3 - Migrate Remaining Feature Endpoints

