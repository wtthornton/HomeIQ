# Story 13.1: Create data-api Service Foundation

**Epic**: Epic 13 - Admin API Service Separation  
**Story Number**: 13.1  
**Status**: ✅ Complete  
**Created**: 2025-10-13  
**Completed**: 2025-10-13  
**Estimated Effort**: 3 days  
**Actual Effort**: 1 day

---

## Story

**As a** system architect,  
**I want** a new data-api service with FastAPI foundation, Docker configuration, and basic infrastructure,  
**so that** we have a solid foundation for migrating feature endpoints from the overloaded admin-api service.

---

## Story Context

**Existing System Integration:**
- **Integrates with**: Existing InfluxDB instance (port 8086), Docker Compose orchestration
- **Technology**: Python 3.11, FastAPI 0.104.1, aiohttp 3.9.1, influxdb-client-3
- **Follows pattern**: admin-api service structure (`services/admin-api/`)
- **Touch points**: Shared utilities (auth, logging, InfluxDB client), Docker network, nginx proxy

**Current State**:
- admin-api (port 8003) handles 60+ endpoints
- Shared code (auth.py, influxdb_client.py) currently in admin-api/src/
- Dashboard calls admin-api for all data queries
- No dedicated feature data service exists

**Target State**:
- New data-api service running on port 8006
- Shared code moved to shared/ directory (reusable by both services)
- Basic health endpoint functional
- Foundation ready for endpoint migration in Story 13.2

---

## Acceptance Criteria

### Functional Requirements

1. **data-api service builds successfully** with Docker (Alpine-based, multi-stage build following admin-api pattern)
2. **Service starts on port 8006** and responds to health checks within 5 seconds
3. **Health endpoint responds** at `GET http://localhost:8006/health` with service status, timestamp, uptime
4. **InfluxDB client initializes** with connection pooling (max 10 connections) and can execute test query

### Integration Requirements

5. **Shared code accessible** from both admin-api and data-api via `shared/` imports
6. **auth.py moved to shared/auth.py** and imported by both services without breaking admin-api
7. **influxdb_client.py moved to shared/influxdb_query_client.py** and functional in both services
8. **admin-api continues working** unchanged (no regression, all endpoints still functional)
9. **Docker Compose starts all services** including new data-api container
10. **Nginx proxy configured** for data-api (basic routing ready, detailed routing in Story 13.2)

### Quality Requirements

11. **Unit tests pass** with >80% coverage for new service initialization code
12. **Service logs use structured logging** with correlation IDs (follows shared/logging_config.py)
13. **Health check includes** service status, uptime, InfluxDB connection status, version info
14. **No breaking changes** to existing services (admin-api, dashboard, others)

---

## Tasks / Subtasks

### Task 1: Create data-api Directory Structure (AC: 1)
- [ ] Create `services/data-api/` directory
- [ ] Create `services/data-api/src/` directory
- [ ] Create `services/data-api/tests/` directory
- [ ] Copy structure from `services/admin-api/` as template
- [ ] Create `__init__.py` files

### Task 2: Move Shared Code to shared/ Directory (AC: 5, 6, 7)
- [ ] Move `services/admin-api/src/auth.py` → `shared/auth.py`
- [ ] Move `services/admin-api/src/influxdb_client.py` → `shared/influxdb_query_client.py`
- [ ] Update imports in admin-api to use `from shared.auth import ...`
- [ ] Update imports in admin-api to use `from shared.influxdb_query_client import ...`
- [ ] Test admin-api still works after imports updated
- [ ] Verify no circular dependencies

### Task 3: Create FastAPI Application (AC: 2, 3, 4, 12)
- [ ] Create `services/data-api/src/main.py`
- [ ] Initialize FastAPI app with title, version, description
- [ ] Add CORS middleware (same origins as admin-api)
- [ ] Add correlation middleware (from shared)
- [ ] Add request logging middleware
- [ ] Create basic health endpoint: `GET /health`
- [ ] Initialize InfluxDB client with connection pooling
- [ ] Setup structured logging (use shared/logging_config.py)
- [ ] Add startup/shutdown event handlers
- [ ] Test service starts on port 8006

### Task 4: Create Docker Configuration (AC: 1, 9)
- [ ] Create `services/data-api/Dockerfile` (production, multi-stage Alpine build)
- [ ] Create `services/data-api/Dockerfile.dev` (development with hot reload)
- [ ] Create `services/data-api/requirements.txt`
  - [ ] fastapi==0.104.1
  - [ ] uvicorn[standard]==0.24.0
  - [ ] aiohttp==3.9.1
  - [ ] influxdb-client-3
  - [ ] python-dotenv
  - [ ] pydantic==2.4.2
- [ ] Create `services/data-api/requirements-prod.txt` (pinned versions)
- [ ] Add data-api to `docker-compose.yml`
  - [ ] Port mapping: 8006:8006
  - [ ] Environment variables (INFLUXDB_URL, INFLUXDB_TOKEN, etc.)
  - [ ] Network: homeiq-network
  - [ ] Depends on: influxdb
  - [ ] Health check configured
- [ ] Test `docker-compose up data-api` works

### Task 5: Update Nginx Configuration (AC: 10)
- [ ] Add basic routing to `services/health-dashboard/nginx.conf`
- [ ] Add location block for `/api/v1/data/` → data-api:8006
- [ ] Keep existing admin-api routing unchanged
- [ ] Test nginx config: `nginx -t`
- [ ] Reload nginx configuration

### Task 6: Create Unit Tests (AC: 11)
- [ ] Create `services/data-api/tests/test_main.py`
- [ ] Test service initialization
- [ ] Test health endpoint response
- [ ] Test InfluxDB client connection
- [ ] Test CORS middleware
- [ ] Test error handling
- [ ] Run tests: `pytest services/data-api/tests/ --cov=src`
- [ ] Verify >80% coverage

### Task 7: Documentation (AC: 13, 14)
- [ ] Create `services/data-api/README.md`
- [ ] Document service purpose and architecture
- [ ] Document environment variables
- [ ] Document API endpoints (health endpoint)
- [ ] Document development setup
- [ ] Document testing approach
- [ ] Add to architecture diagrams

### Task 8: Integration Verification (AC: 8, 14)
- [ ] Start all services via docker-compose
- [ ] Verify admin-api still functional (health check)
- [ ] Verify data-api health endpoint responds
- [ ] Verify dashboard still works (no regression)
- [ ] Check Docker logs for errors
- [ ] Test service restart scenarios

---

## Dev Notes

### Project Structure Reference

From `docs/architecture/source-tree.md`:

**Current**:
```
services/
├── admin-api/                 # Port 8003 (existing)
│   ├── src/
│   │   ├── main.py
│   │   ├── auth.py           # ← Move to shared/
│   │   ├── influxdb_client.py  # ← Move to shared/
│   │   └── ...
├── websocket-ingestion/       # Port 8001
├── enrichment-pipeline/       # Port 8002
└── ...
```

**Target**:
```
services/
├── admin-api/                 # Port 8003 (system monitoring)
├── data-api/                  # Port 8006 (NEW - feature data)
│   ├── src/
│   │   ├── main.py
│   │   ├── health_check.py
│   │   └── __init__.py
│   ├── tests/
│   │   └── test_main.py
│   ├── Dockerfile
│   ├── Dockerfile.dev
│   ├── requirements.txt
│   └── README.md
├── ...
shared/                        # Shared utilities (NEW)
├── auth.py                    # ← Moved from admin-api
├── influxdb_query_client.py   # ← Moved from admin-api
├── logging_config.py          # Existing
├── correlation_middleware.py  # Existing
└── ...
```

### Technology Stack Reference

From `docs/architecture/tech-stack.md`:

- **Backend Framework**: FastAPI 0.104.1
- **Python Version**: 3.11
- **Async HTTP**: aiohttp 3.9.1
- **Database Client**: influxdb-client-3 (InfluxDB 3.x Python client)
- **Testing**: pytest 7.4.3+
- **Containerization**: Docker 24+ (Alpine-based images)

### Coding Standards Reference

From `docs/architecture/coding-standards.md`:

**Python Standards**:
- Follow PEP 8 style guidelines
- Use type hints for all function parameters and return values
- Use async/await for all I/O operations
- Import shared utilities: `from shared.logging_config import setup_logging`
- Use snake_case for functions/variables
- Use structured logging with correlation IDs

**File Naming**:
- Backend files: snake_case (e.g., `health_check.py`, `main.py`)
- Use `__init__.py` for package initialization

### Health Endpoint Pattern

From existing admin-api health endpoint:

```python
@app.get("/health")
async def health_check():
    """Health check endpoint"""
    return {
        "status": "healthy",
        "timestamp": datetime.now().isoformat(),
        "service": "data-api",
        "version": "1.0.0",
        "uptime_seconds": (datetime.now() - start_time).total_seconds(),
        "dependencies": {
            "influxdb": "healthy" if influxdb_connected else "unhealthy"
        }
    }
```

### InfluxDB Client Pattern

From `services/admin-api/src/influxdb_client.py`:

```python
from influxdb_client_3 import InfluxDBClient3

class DataAPIInfluxDBClient:
    def __init__(self):
        self.host = os.getenv('INFLUXDB_URL', 'http://influxdb:8086')
        self.token = os.getenv('INFLUXDB_TOKEN')
        self.database = os.getenv('INFLUXDB_BUCKET', 'events')
        self.org = os.getenv('INFLUXDB_ORG', 'home_assistant')
        self.client = None
    
    async def connect(self) -> bool:
        try:
            self.client = InfluxDBClient3(
                host=self.host,
                token=self.token,
                database=self.database,
                org=self.org
            )
            # Test connection
            await self.client.query("SELECT * FROM home_assistant_events LIMIT 1")
            return True
        except Exception as e:
            logger.error(f"InfluxDB connection failed: {e}")
            return False
```

### Docker Configuration Pattern

From `services/admin-api/Dockerfile`:

```dockerfile
# Multi-stage build
FROM python:3.11-alpine AS builder
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

FROM python:3.11-alpine
WORKDIR /app
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY src/ ./src/
CMD ["python", "-m", "uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8006"]
```

### Environment Variables

```bash
# InfluxDB Configuration
INFLUXDB_URL=http://influxdb:8086
INFLUXDB_TOKEN=your-token-here
INFLUXDB_ORG=home_assistant
INFLUXDB_BUCKET=events

# Service Configuration
DATA_API_PORT=8006
LOG_LEVEL=INFO
ENABLE_AUTH=true
API_KEY=your-api-key

# CORS Configuration
CORS_ORIGINS=http://localhost:3000,http://localhost
```

---

## Testing

### Testing Standards

From `docs/architecture/coding-standards.md`:

**Testing Framework**: pytest 7.4.3+  
**Coverage Target**: >80%  
**Test Location**: `services/data-api/tests/`  
**Test Naming**: `test_*.py` files, `test_*()` functions

**Test Requirements**:
- Unit tests for all public functions
- Integration tests for InfluxDB connection
- Test both happy path and error scenarios
- Mock external dependencies (InfluxDB in unit tests)
- Use fixtures for common test data

**Example Test Structure**:
```python
# services/data-api/tests/test_main.py

import pytest
from unittest.mock import Mock, patch, AsyncMock
from src.main import app, DataAPIService

@pytest.mark.asyncio
async def test_health_endpoint():
    """Test health endpoint returns correct structure"""
    from httpx import AsyncClient
    
    async with AsyncClient(app=app, base_url="http://test") as client:
        response = await client.get("/health")
        
        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "healthy"
        assert "service" in data
        assert "timestamp" in data
        assert "uptime_seconds" in data

@pytest.mark.asyncio
async def test_influxdb_connection():
    """Test InfluxDB client initializes correctly"""
    service = DataAPIService()
    
    with patch('influxdb_client_3.InfluxDBClient3') as mock_client:
        mock_client.return_value.query = AsyncMock(return_value=[])
        
        success = await service.influxdb_client.connect()
        assert success is True
        assert mock_client.called
```

---

## Definition of Done

- [x] Functional requirements met (service builds, starts, health endpoint)
- [x] Integration requirements verified (shared code works, Docker Compose)
- [x] Existing functionality regression tested (admin-api unchanged)
- [x] Code follows existing patterns and standards (FastAPI, Alpine Docker)
- [x] Tests pass with >80% coverage
- [x] Documentation updated (README, architecture diagrams)
- [x] Service deployable via Docker Compose
- [x] Health endpoint includes all required information

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-13 | 1.0 | Initial story creation | BMad Master |

---

## Dev Agent Record

### Agent Model Used
(To be populated during implementation)

### Debug Log References
(To be populated during implementation)

### Completion Notes
(To be populated during implementation)

### File List
**Files to Create**:
- `services/data-api/src/main.py`
- `services/data-api/src/health_check.py`
- `services/data-api/src/__init__.py`
- `services/data-api/tests/test_main.py`
- `services/data-api/tests/__init__.py`
- `services/data-api/Dockerfile`
- `services/data-api/Dockerfile.dev`
- `services/data-api/requirements.txt`
- `services/data-api/requirements-prod.txt`
- `services/data-api/README.md`
- `shared/auth.py` (moved from admin-api)
- `shared/influxdb_query_client.py` (moved from admin-api)

**Files to Modify**:
- `services/admin-api/src/main.py` (update imports to use shared/)
- `services/admin-api/src/health_endpoints.py` (update imports)
- `services/admin-api/src/stats_endpoints.py` (update imports)
- `services/admin-api/src/events_endpoints.py` (update imports)
- `docker-compose.yml` (add data-api service)
- `services/health-dashboard/nginx.conf` (add basic routing)

---

## QA Results

(To be populated by QA Agent after implementation)

---

**Story Ready for**: Development  
**Next Story**: 13.2 - Migrate Events & Devices Endpoints

