# Story 31.1: Weather API Service Foundation

## Status

Draft

## Story

**As a** DevOps engineer,
**I want** a foundational weather API service infrastructure with health checks, metrics, and Docker deployment,
**so that** the weather service follows the same proven patterns as other external API services (sports, carbon, air quality) and integrates seamlessly into our microservices architecture.

## Acceptance Criteria

1. FastAPI service created following sports-data service template structure
2. Service runs on Port 8009 with proper CORS middleware for dashboard access
3. Health check endpoint `/health` returns service status, uptime, and component health
4. Basic endpoints defined: `/` (root), `/health`, `/metrics`
5. Docker deployment configured with multi-stage build (Alpine-based)
6. Service registered in docker-compose.yml with proper networking
7. Environment variable configuration matches existing service patterns
8. Service starts successfully and passes health checks in Docker environment
9. Structured logging configured using shared/logging_config.py
10. Service integrates with correlation middleware for request tracking

## Tasks / Subtasks

- [ ] Task 1: Create Service Directory Structure (AC: 1, 7)
  - [ ] Create `services/weather-api/` directory structure
  - [ ] Create `src/` subdirectory for Python modules
  - [ ] Create `tests/` subdirectory for pytest tests
  - [ ] Copy requirements template from sports-data service
  - [ ] Create `.dockerignore` file
  - [ ] Create `README.md` with service documentation

- [ ] Task 2: Implement FastAPI Application Skeleton (AC: 1, 2, 4)
  - [ ] Create `src/main.py` with FastAPI app initialization
  - [ ] Add CORS middleware configuration (allow localhost:3000)
  - [ ] Implement root endpoint `/` with service metadata
  - [ ] Add API metadata (title, description, version)
  - [ ] Configure lifespan context manager for startup/shutdown
  - [ ] Add structured logging with correlation IDs

- [ ] Task 3: Implement Health Check System (AC: 3)
  - [ ] Create `src/health_check.py` module
  - [ ] Implement HealthCheckHandler class with service uptime tracking
  - [ ] Add `/health` endpoint returning status, uptime, timestamp
  - [ ] Track service start time for accurate uptime calculation
  - [ ] Return HTTP 200 for healthy, HTTP 503 for unhealthy
  - [ ] Include component health status (API client, cache, InfluxDB)

- [ ] Task 4: Implement Metrics Endpoint (AC: 4)
  - [ ] Create `/metrics` endpoint for Prometheus-compatible metrics
  - [ ] Track API call counts and success/failure rates
  - [ ] Track cache hit/miss statistics
  - [ ] Include response time percentiles (p50, p95, p99)
  - [ ] Add uptime and error rate metrics

- [ ] Task 5: Docker Configuration (AC: 5, 6)
  - [ ] Create `Dockerfile` with multi-stage Alpine-based build
  - [ ] Create `Dockerfile.dev` for development with hot-reload
  - [ ] Configure non-root user (appuser) for security
  - [ ] Add health check configuration to Dockerfile
  - [ ] Update `docker-compose.yml` with weather-api service (Port 8009)
  - [ ] Add service to `ha-network` for inter-service communication
  - [ ] Configure environment variables (WEATHER_API_KEY, SERVICE_PORT)

- [ ] Task 6: Environment Configuration (AC: 7)
  - [ ] Create `infrastructure/env.weather.template` with all required variables
  - [ ] Add WEATHER_API_KEY (OpenWeatherMap)
  - [ ] Add WEATHER_LOCATION (default location for queries)
  - [ ] Add CACHE_TTL (default 900 seconds - 15 minutes)
  - [ ] Add SERVICE_PORT (8009)
  - [ ] Add INFLUXDB connection variables
  - [ ] Document all environment variables in README

- [ ] Task 7: Integration Testing (AC: 8, 9, 10)
  - [ ] Write pytest tests for health check endpoint
  - [ ] Write pytest tests for root endpoint
  - [ ] Write pytest tests for metrics endpoint
  - [ ] Test Docker build process (both production and dev)
  - [ ] Test service startup in Docker Compose
  - [ ] Verify health check passes within 30 seconds of startup
  - [ ] Verify structured logging outputs to console
  - [ ] Verify correlation middleware adds correlation_id to logs

- [ ] Task 8: Documentation & Code Review (AC: 1-10)
  - [ ] Update `docs/architecture/source-tree.md` with new service
  - [ ] Update `docs/architecture/tech-stack.md` if needed
  - [ ] Create service-specific README with API endpoints
  - [ ] Document environment variables and configuration
  - [ ] Code review focusing on pattern consistency with sports-data

## Dev Notes

### Testing Standards

**Test File Location:**
- Unit tests: `services/weather-api/tests/test_*.py`
- Integration tests: `services/weather-api/tests/integration/test_*.py`
- Follow pytest naming conventions

**Test Standards:**
- Use pytest 7.4+ (from tech-stack.md)
- AAA pattern (Arrange, Act, Assert)
- Test both success and failure scenarios
- Mock external dependencies (OpenWeatherMap API, InfluxDB)
- Use `@pytest.mark.asyncio` for async tests
- Minimum 80% code coverage target

**Testing Frameworks:**
- pytest for test execution
- pytest-asyncio for async testing
- httpx TestClient for FastAPI endpoint testing
- pytest-cov for coverage reporting

### Architecture Context

**Source Tree Structure** (from `docs/architecture/source-tree.md`):

```
services/weather-api/
├── src/
│   ├── __init__.py
│   ├── main.py                    # FastAPI application entry point
│   ├── health_check.py            # Health check handler
│   ├── weather_client.py          # OpenWeatherMap client (Story 31.2)
│   ├── cache_service.py           # Caching layer (Story 31.2)
│   └── influxdb_writer.py         # InfluxDB integration (Story 31.2)
├── tests/
│   ├── __init__.py
│   ├── test_health_check.py       # Health check tests
│   ├── test_main.py               # Main app tests
│   └── integration/               # Integration tests
├── Dockerfile                      # Production Docker image
├── Dockerfile.dev                  # Development Docker image
├── requirements.txt                # Python dependencies
├── requirements-dev.txt            # Development dependencies
└── README.md                       # Service documentation
```

**Technology Stack** (from `docs/architecture/tech-stack.md`):
- **Backend Framework**: FastAPI 0.104.1
- **Async HTTP**: aiohttp 3.9.1
- **Database**: InfluxDB 2.7 (time-series)
- **Testing**: pytest 7.4.3+, pytest-asyncio 0.21.1
- **Docker**: Alpine Linux base (python:3.12-alpine)
- **Logging**: Structured JSON logging with correlation IDs

**Coding Standards** (from `docs/architecture/coding-standards.md`):

**Python Standards:**
- Follow PEP 8 style guidelines
- Use type hints for all function parameters and return values
- Write docstrings for all public functions and classes (Google style)
- Use meaningful variable and function names (snake_case)
- Handle exceptions explicitly, avoid bare except clauses
- Use context managers (with statements) for resource management
- Follow single responsibility principle

**API Standards:**
- Use kebab-case for route paths (`/current-weather` not `/currentWeather`)
- Return JSON responses with appropriate status codes
- Include proper error handling with HTTPException
- Add CORS middleware for dashboard access
- Use lifespan context managers for startup/shutdown logic

### Reference Implementation

**Use sports-data service as template** (`services/sports-data/src/main.py`):

**Key Patterns to Follow:**
1. **Lifespan Context Manager:**
```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    logger.info("Starting Weather API Service...")
    # Initialize components
    yield
    # Cleanup
    logger.info("Shutting down...")
```

2. **Health Check Pattern:**
```python
@app.get("/health", response_model=HealthCheck)
async def health_check():
    return HealthCheck(
        status="healthy",
        service="weather-api",
        timestamp=datetime.utcnow().isoformat(),
        uptime=str(datetime.now() - start_time)
    )
```

3. **CORS Middleware:**
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000", "http://localhost"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

4. **Structured Logging:**
```python
from shared.logging_config import setup_logging

logger = setup_logging("weather-api")
```

### Context7 Verification

**FastAPI Best Practices** (verified against `/fastapi/fastapi`):
- ✅ Use lifespan context managers for resource initialization
- ✅ Implement dependency injection with `Depends` and `yield`
- ✅ Use Pydantic models for request/response validation
- ✅ Add proper health check endpoints
- ✅ Configure CORS middleware for browser access

**Docker Best Practices:**
- ✅ Multi-stage builds to minimize image size
- ✅ Alpine-based images for production (50-70% smaller)
- ✅ Non-root user execution for security
- ✅ Health check configuration in Dockerfile

### Critical Success Factors

1. **Pattern Consistency**: Service MUST match sports-data structure exactly
2. **Health Checks**: Must be responsive within 30 seconds of startup
3. **Logging**: Must use shared/logging_config.py (no custom logging)
4. **Port Configuration**: Port 8009 must be available and documented
5. **Docker Networking**: Must join ha-network for service discovery

### Integration Points

**Existing Services That Will Integrate:**
- None initially (this is foundation only)
- Story 31.5 will integrate with health-dashboard

**Required Connections:**
- InfluxDB (host: influxdb:8086) - for Story 31.2
- Docker network: ha-network (internal service communication)

### Performance Targets

- Service startup time: <10 seconds
- Health check response: <50ms
- Memory footprint: <100MB (Alpine image)
- Docker image size: <150MB (multi-stage build)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial story creation | BMad Master |

## Dev Agent Record

*This section will be populated during implementation*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be added here*

