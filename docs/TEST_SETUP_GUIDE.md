# Home Assistant Test Container Setup Guide

## Quick Start

### 1. Start Test Containers

```bash
# Start Home Assistant test container and websocket-ingestion-test
docker-compose --profile test up -d home-assistant-test websocket-ingestion-test

# Wait for Home Assistant to initialize (first time: 2-3 minutes)
docker-compose logs -f home-assistant-test
```

### 2. Setup Test Environment

**Linux/Mac:**
```bash
./scripts/setup_ha_test.sh
```

**Windows:**
```powershell
.\scripts\setup_ha_test.ps1
```

This script:
- Waits for Home Assistant to be ready
- Creates a long-lived access token
- Saves configuration to `.env.test`

### 3. Load Test Dataset

```bash
# Load assist-mini dataset (smallest, fastest)
python scripts/load_dataset_to_ha.py --dataset assist-mini

# Or load other datasets
python scripts/load_dataset_to_ha.py --dataset assist
```

### 4. Run Tests

```bash
# Run dataset tests
pytest tests/datasets/ -v

# Run specific test
pytest tests/datasets/test_pattern_detection_with_datasets.py -v
```

### 5. Stop Test Environment

```bash
# Stop test containers
docker-compose --profile test stop

# Remove containers and volumes (optional - cleans up test data)
docker-compose --profile test down -v
```

## Architecture

```
┌─────────────────────────────────────────┐
│  Home Assistant Test Container          │
│  Port: 8124                             │
│  URL: http://localhost:8124            │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  websocket-ingestion-test               │
│  Port: 8002                             │
│  Connects to: home-assistant-test:8123 │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  InfluxDB                               │
│  Bucket: home_assistant_events_test    │
└─────────────────────────────────────────┘
```

## Configuration

### Environment Variables

Create `.env.test` file (auto-generated by setup script):

```bash
HA_TEST_URL=http://localhost:8124
HA_TEST_TOKEN=your_token_here
HA_TEST_WS_URL=ws://localhost:8124/api/websocket
INFLUXDB_TEST_BUCKET=home_assistant_events_test
```

### Docker Compose Profiles

Test containers use the `test` profile, so they only start when explicitly requested:

```bash
# Start test containers
docker-compose --profile test up -d

# Start all services including test
docker-compose --profile test up -d

# Stop only test containers
docker-compose --profile test stop
```

## Available Datasets

- **assist-mini**: Small home, limited entities (fastest for testing)
- **assist**: Medium home, more complex scenarios
- **intents**: Large home, stress testing
- **automations**: Automation evaluation tasks

## Troubleshooting

### Home Assistant Not Starting

```bash
# Check logs
docker-compose logs home-assistant-test

# Check health
docker-compose ps home-assistant-test

# Restart
docker-compose restart home-assistant-test
```

### Token Creation Failed

1. Open http://localhost:8124
2. Complete initial setup (if first run)
3. Go to Profile → Long-Lived Access Tokens
4. Create token named "HomeIQ Test Token"
5. Add to `.env.test`: `HA_TEST_TOKEN=your_token_here`

### WebSocket Connection Issues

```bash
# Check websocket-ingestion-test logs
docker-compose logs websocket-ingestion-test

# Verify HA is accessible
curl http://localhost:8124/api/

# Check token
curl -H "Authorization: Bearer $HA_TEST_TOKEN" http://localhost:8124/api/
```

### InfluxDB Test Bucket

The test bucket `home_assistant_events_test` is created automatically. If it doesn't exist:

```bash
# Create bucket via InfluxDB UI
# http://localhost:8086 → Data → Buckets → Create Bucket
# Name: home_assistant_events_test
```

## Resource Usage

- **Memory**: ~400-640MB additional when running
- **Disk**: ~150-700MB for config and data
- **CPU**: Minimal when idle, spikes during tests

## Best Practices

1. **Isolation**: Test containers are completely isolated from production
2. **Cleanup**: Remove test containers when not in use to save resources
3. **Data**: Test data is stored separately (test bucket, test volumes)
4. **Tokens**: Use separate test tokens (never use production tokens)
5. **CI/CD**: Can be used in automated test pipelines

## Next Steps

- See [HOME_ASSISTANT_TEST_CONTAINER_PLAN.md](../implementation/analysis/HOME_ASSISTANT_TEST_CONTAINER_PLAN.md) for full details
- See [TESTING_GUIDE.md](../services/ai-automation-service/tests/datasets/TESTING_GUIDE.md) for test execution
- See [DATA_FLOW.md](../services/ai-automation-service/tests/datasets/DATA_FLOW.md) for test data flow

