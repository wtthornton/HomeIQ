# Step 1: Enhanced Prompt - Proactive Suggestions Device Validation

## Original Request
Fix Proactive Suggestions service to prevent AI hallucination of non-existent devices (e.g., "Smart Humidifier" when user has no humidifier).

## Enhanced Specification

### Problem Statement
The Proactive Suggestions feature in the `proactive-agent-service` is generating automation suggestions that reference devices the user does not have in their Home Assistant setup. This occurs because:
1. The LLM (GPT-4o-mini) hallucinates device names without validation
2. Device context is truncated to 3,000 characters
3. No post-generation validation of device existence
4. Generic insights mislead the LLM into suggesting non-existent device types

### Requirements Analysis

#### Functional Requirements
1. **FR-1: Device Existence Validation**
   - System MUST validate that devices mentioned in suggestions exist in Home Assistant
   - Suggestions referencing non-existent devices MUST be rejected before storage
   - Validation MUST use the actual device inventory from ha-ai-agent-service

2. **FR-2: Explicit Device List in LLM Context**
   - System MUST provide an explicit, structured list of available devices to the LLM
   - Device list MUST NOT be truncated
   - Device list MUST include device names in a format matching user expectations

3. **FR-3: Remove Misleading Insights**
   - System MUST NOT generate insights for device types that don't exist
   - Generic insights (e.g., "consider dehumidifier automation") MUST be removed
   - Insights MUST be generated only for existing device capabilities

4. **FR-4: Enhanced LLM System Prompt**
   - System prompt MUST explicitly forbid suggesting non-existent devices
   - System prompt MUST include CRITICAL instruction about device constraints
   - LLM MUST be instructed to return empty array rather than hallucinate

5. **FR-5: User Feedback for Invalid Suggestions**
   - Users SHOULD be able to mark suggestions as "invalid"
   - System SHOULD track invalid suggestion patterns
   - API endpoint for reporting bad suggestions

#### Non-Functional Requirements
1. **NFR-1: Performance** - Device validation should add <100ms latency
2. **NFR-2: Reliability** - Validation failure should gracefully skip suggestion, not crash
3. **NFR-3: Logging** - All rejected suggestions should be logged for debugging
4. **NFR-4: Backwards Compatibility** - Existing API contracts must be maintained

### Architecture Guidance

#### Components to Modify
1. `services/proactive-agent-service/src/services/ai_prompt_generation_service.py`
   - Add device list fetching
   - Add device validation method
   - Enhance system prompt

2. `services/proactive-agent-service/src/services/context_analysis_service.py`
   - Remove generic device-type insights
   - Add device-aware insight generation

3. `services/proactive-agent-service/src/services/suggestion_storage_service.py`
   - Add invalid suggestion tracking

4. `services/proactive-agent-service/src/api/suggestions.py`
   - Add endpoint for reporting invalid suggestions

#### New Components
1. `DeviceValidationService` - Validates device existence
2. Database migration for `invalid_suggestion_reports` table

### Quality Standards
- All code MUST pass quality score ≥ 70
- Security score ≥ 7.0/10
- Test coverage ≥ 80%
- Type hints required for all functions
- Docstrings required for all public methods

### Success Criteria
1. ✅ Suggestions only reference devices that exist in Home Assistant
2. ✅ LLM receives explicit device list (not truncated)
3. ✅ No generic insights for non-existent device types
4. ✅ Users can report invalid suggestions
5. ✅ All tests pass
6. ✅ Quality score ≥ 70

### Implementation Priority
| Priority | Component | Effort |
|----------|-----------|--------|
| P0 | Device existence validation | 2h |
| P0 | Explicit device list to LLM | 1h |
| P1 | Remove generic insights | 30m |
| P1 | Enhanced system prompt | 30m |
| P2 | User feedback endpoint | 1h |

---
*Generated by TappsCodingAgents Simple Mode - Step 1: @enhancer *enhance*
