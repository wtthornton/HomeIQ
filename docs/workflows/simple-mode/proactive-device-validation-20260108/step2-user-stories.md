# Step 2: User Stories - Proactive Suggestions Device Validation

## Epic: Fix Proactive Suggestions Device Hallucination

### Story 1: Device Existence Validation (P0)
**As a** HomeIQ user  
**I want** proactive suggestions to only reference devices I actually have  
**So that** I don't see confusing suggestions for devices that don't exist  

**Story Points:** 5  
**Priority:** P0 - Critical  

**Acceptance Criteria:**
- [ ] AC1.1: Suggestions mentioning non-existent devices are filtered out before display
- [ ] AC1.2: Validation uses actual device inventory from Home Assistant
- [ ] AC1.3: Validation adds <100ms latency to suggestion generation
- [ ] AC1.4: Rejected suggestions are logged with reason
- [ ] AC1.5: Service handles validation errors gracefully (doesn't crash)

**Technical Tasks:**
1. Create `DeviceValidationService` class
2. Implement `validate_suggestion_devices()` method
3. Extract device names from suggestion text
4. Query ha-ai-agent-service for device inventory
5. Add validation step to suggestion pipeline

---

### Story 2: Explicit Device List in LLM Context (P0)
**As a** HomeIQ system  
**I want** to provide the LLM with an explicit list of available devices  
**So that** the LLM knows exactly what devices exist and doesn't hallucinate  

**Story Points:** 3  
**Priority:** P0 - Critical  

**Acceptance Criteria:**
- [ ] AC2.1: LLM receives a structured JSON list of available device names
- [ ] AC2.2: Device list is NOT truncated (full list provided)
- [ ] AC2.3: Device list includes friendly names users would recognize
- [ ] AC2.4: Context includes device domains (light, switch, climate, etc.)

**Technical Tasks:**
1. Create `get_device_inventory()` method
2. Format device list as JSON for LLM context
3. Update `_build_llm_context()` to include device list
4. Remove 3000 character truncation for device section

---

### Story 3: Remove Misleading Generic Insights (P1)
**As a** HomeIQ system  
**I want** to only generate insights for device types that exist  
**So that** the LLM doesn't receive misleading context about non-existent devices  

**Story Points:** 2  
**Priority:** P1 - High  

**Acceptance Criteria:**
- [ ] AC3.1: Generic "consider dehumidifier automation" insight is removed
- [ ] AC3.2: Humidity insights only generated if humidity-related device exists
- [ ] AC3.3: All insights are tied to actual device capabilities
- [ ] AC3.4: No hardcoded device type suggestions

**Technical Tasks:**
1. Remove line 132 generic dehumidifier insight
2. Add device-type existence check before generating insights
3. Create `has_device_type()` helper method

---

### Story 4: Enhanced LLM System Prompt (P1)
**As a** HomeIQ system  
**I want** the LLM system prompt to explicitly forbid hallucinating devices  
**So that** the LLM is strongly constrained to real devices only  

**Story Points:** 1  
**Priority:** P1 - High  

**Acceptance Criteria:**
- [ ] AC4.1: System prompt includes CRITICAL instruction about device constraints
- [ ] AC4.2: Prompt explicitly states "ONLY suggest for devices in the list"
- [ ] AC4.3: Prompt instructs to return empty array rather than hallucinate
- [ ] AC4.4: Prompt mentions user-visible device names to match

**Technical Tasks:**
1. Update `SUGGESTION_SYSTEM_PROMPT` constant
2. Add explicit device constraint section
3. Add instruction for empty array on uncertainty

---

### Story 5: User Feedback for Invalid Suggestions (P2)
**As a** HomeIQ user  
**I want** to report suggestions that are invalid or unhelpful  
**So that** the system can learn and improve over time  

**Story Points:** 3  
**Priority:** P2 - Medium  

**Acceptance Criteria:**
- [ ] AC5.1: API endpoint exists to report invalid suggestions
- [ ] AC5.2: Reports are stored with suggestion ID and reason
- [ ] AC5.3: Tracking includes timestamp and user feedback
- [ ] AC5.4: Admin can view invalid suggestion patterns

**Technical Tasks:**
1. Add `InvalidSuggestionReport` database model
2. Create database migration
3. Add `POST /api/v1/suggestions/{id}/report` endpoint
4. Add `GET /api/v1/suggestions/reports` admin endpoint

---

## Sprint Plan

### Sprint 1 (Current)
| Story | Points | Status |
|-------|--------|--------|
| Story 1: Device Validation | 5 | To Do |
| Story 2: Explicit Device List | 3 | To Do |
| Story 3: Remove Generic Insights | 2 | To Do |
| Story 4: Enhanced System Prompt | 1 | To Do |
| Story 5: User Feedback | 3 | To Do |
| **Total** | **14** | |

### Estimated Completion
- Development: 4-5 hours
- Testing: 1-2 hours
- Total: ~6 hours

---
*Generated by TappsCodingAgents Simple Mode - Step 2: @planner *plan*
